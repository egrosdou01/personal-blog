<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Cilium Cluster Mesh on RKE2 | Welcome to Eleni&#x27;s Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://github.com/personal-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://github.com/personal-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Cilium Cluster Mesh on RKE2 | Welcome to Eleni&#x27;s Blog"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-07-18T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/egrosdou01"><meta data-rh="true" property="article:tag" content="Cilium,RKE2,Open Source,Kubernetes,GitOps,DevOps,2024"><link data-rh="true" rel="icon" href="https://github.com/egrosdou01.png"><link data-rh="true" rel="canonical" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2"><link data-rh="true" rel="alternate" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2" hreflang="en"><link data-rh="true" rel="alternate" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2","mainEntityOfPage":"https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2","url":"https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2","headline":"Cilium Cluster Mesh on RKE2","name":"Cilium Cluster Mesh on RKE2","description":"Introduction","datePublished":"2024-07-18T00:00:00.000Z","author":{"@type":"Person","name":"Eleni Grosdouli","description":"DevOps Consulting Engineer at Cisco Systems","url":"https://github.com/egrosdou01","image":"https://github.com/egrosdou01.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://github.com/personal-blog/blog","name":"Eleni Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/personal-blog/blog/rss.xml" title="Welcome to Eleni&#39;s Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/personal-blog/blog/atom.xml" title="Welcome to Eleni&#39;s Blog Atom Feed"><link rel="stylesheet" href="/personal-blog/assets/css/styles.8e64e2c7.css">
<script src="/personal-blog/assets/js/runtime~main.2b7dd48f.js" defer="defer"></script>
<script src="/personal-blog/assets/js/main.7dca580e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/personal-blog/"><div class="navbar__logo"><img src="https://github.com/egrosdou01.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="https://github.com/egrosdou01.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">About</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/personal-blog/blog">Blog</a><a class="navbar__item navbar__link" href="/personal-blog/blog/tags">Tags</a><a class="navbar__item navbar__link" href="/personal-blog/talks">Talks</a><a class="navbar__item navbar__link" href="/personal-blog/favourites">Favourites</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/egrosdou01" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns">K8s Troubleshooting Insights: Looking into CoreDNS Issues</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/sveltos-cilium-tetragon-day2-operations">Sveltos: Optimising Day-2 Operations with Cilium and Tetragon</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/sveltos-introduction-to-tiers">Sveltos Tiers: Efficient Day-2 Operations and Targeted Updates</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/ossummit-europe-2024">OSSummit Europe 2024</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/civo-navigate-berlin-2024">Civo Navigate Berlin 2024</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/opentofu-rke2-cilium-azure">OpenTofu: RKE2 Cluster with Cilium on Azure</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_xvU1">Cilium Cluster Mesh on RKE2</h1><div class="container_iJTo margin-vert--md"><time datetime="2024-07-18T00:00:00.000Z">July 18, 2024</time> Â· <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_q4o9"><div class="avatar margin-bottom--sm"><a href="https://github.com/egrosdou01" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/egrosdou01.png" alt="Eleni Grosdouli"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/egrosdou01" target="_blank" rel="noopener noreferrer"><span>Eleni Grosdouli</span></a></div><small class="avatar__subtitle">DevOps Consulting Engineer at Cisco Systems</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="/personal-blog/blog/cilium-cluster-mesh-rke2#introduction">â</a></h2>
<p>After spending some time working with the on-prem <a href="https://docs.rke2.io/" target="_blank" rel="noopener noreferrer">RKE2</a> lab setup, I came to notice a couple of issues while forming in an automated fashion the <a href="https://docs.cilium.io/en/stable/network/clustermesh/clustermesh/" target="_blank" rel="noopener noreferrer">Cilium cluster mesh</a> between on-prem clusters.</p>
<p>In today&#x27;s post, we will go through the step-by-step process of forming a <strong>Cilium Cluster Mesh</strong> and explain any issues that might have arisen by following the <strong>GitOps</strong> approach. The cilium CLI will not be required. The deployment will be performed primarily via <code>Helm</code> and <code>kubectl</code>.</p>
<p>Additionally, we will use the <a href="https://docs.cilium.io/en/v1.15/network/clustermesh/clustermesh/#shared-certificate-authority" target="_blank" rel="noopener noreferrer">shared CA</a> (Certificate Authority) approach as this is a convenient way to form a cluster mesh in an automated fashion and also the best practise for the Hubble Relay setup. The approach will enable <strong>mTLS</strong> across clusters.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-setup">Lab Setup<a class="hash-link" aria-label="Direct link to Lab Setup" title="Direct link to Lab Setup" href="/personal-blog/blog/cilium-cluster-mesh-rke2#lab-setup">â</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+----------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Cluster Name  |        Type          |       Version        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+----------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   mesh01        | RKE2 managed cluster | RKE2 v1.27.14+rke2r1 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   mesh02        | RKE2 managed cluster | RKE2 v1.27.14+rke2r1 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+----------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Deployment     | Version  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Rancher2 Provider |  4.2.0   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|     Cilium        | 1.15.500 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" href="/personal-blog/blog/cilium-cluster-mesh-rke2#prerequisites">â</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="infrastructure">Infrastructure<a class="hash-link" aria-label="Direct link to Infrastructure" title="Direct link to Infrastructure" href="/personal-blog/blog/cilium-cluster-mesh-rke2#infrastructure">â</a></h3>
<p>For this demonstration, we assume readers have at least two RKE2 clusters up and running. In our case, to create an RKE2 cluster on-prem we used the <a href="https://registry.terraform.io/providers/rancher/rancher2/latest/docs" target="_blank" rel="noopener noreferrer">Rancher2</a> Terraform provider. The provider allows users to create different resources across different platforms alongside defining information for the RKE2 deployment like IP Address handling, and CNI (Container Network Interface) custom configuration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cilium-cluster-mesh">Cilium Cluster Mesh<a class="hash-link" aria-label="Direct link to Cilium Cluster Mesh" title="Direct link to Cilium Cluster Mesh" href="/personal-blog/blog/cilium-cluster-mesh-rke2#cilium-cluster-mesh">â</a></h3>
<ul>
<li>The <strong>Cluster Name</strong> and the <strong>Cluster ID</strong> must be unique.</li>
<li>The <strong>Pods</strong> and the <strong>Services CIDR</strong> ranges must be unique across all the Kubernetes Clusters. The pods need to communicate over a unique IP address. See the IP address schema table above.</li>
<li>Node CIDRs must be unique. The Nodes to have IP connectivity.</li>
<li>The Cilium pods must connect to the <code>ClusterMesh API Server</code> service exposed on every Kubernetes cluster.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources" href="/personal-blog/blog/cilium-cluster-mesh-rke2#resources">â</a></h3>
<p>Ensure the below are satisfied.</p>
<ol>
<li>Helm CLI installed</li>
<li>kubectl installed</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-0-rke2-terraform-provider">Step 0: RKE2 Terraform Provider<a class="hash-link" aria-label="Direct link to Step 0: RKE2 Terraform Provider" title="Direct link to Step 0: RKE2 Terraform Provider" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-0-rke2-terraform-provider">â</a></h2>
<p>The below snippet is an example configuration on how to deploy an RKE2 cluster via the <strong>Rancher2</strong> Provider.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  # RKE2 configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource &quot;rancher2_cluster_v2&quot; &quot;rke2&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Define basic cluster details like labels and annotations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotations           = var.rancher_env.cluster_annotations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes_version    = var.rancher_env.rke2_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels                = var.rancher_env.cluster_labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_network_policy = var.rancher_env.network_policy # Option to enable or disable Project Network Isolation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name                  = var.rancher_env.cluster_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Define the Cilium Configuration for the cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      chart_values = &lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rke2-cilium:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          k8sServiceHost: 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          k8sServicePort: 6443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          kubeProxyReplacement: true # Prepare the deployment for kube-proxy replacement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          operator:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          hubble: # Enable Hubble for observability </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            peerService:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              clusterDomain: cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            relay:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              auto:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                certValidityDuration: 1095</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                method: helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ui:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Apply machine global settings for the clusters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      machine_global_config = &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cni: &quot;cilium&quot; # Enable Cilium CNI for every cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cluster-cidr: ${var.rke_cluster_cidr}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service-cidr: ${var.rke_service_cidr}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disable-kube-proxy: true # Disable kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcd-expose-metrics: false # Do not expose the etcd metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Start building the controller and workder nodes dynamically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dynamic &quot;machine_pools&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for_each = var.node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          cloud_credential_secret_name = data.rancher2_cloud_credential.auth.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          control_plane_role           = machine_pools.key == &quot;ctl_plane&quot; ? true : false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          etcd_role                    = machine_pools.key == &quot;ctl_plane&quot; ? true : false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name                         = machine_pools.value.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          quantity                     = machine_pools.value.quantity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          worker_role                  = machine_pools.key != &quot;ctl_plane&quot; ? true : false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          machine_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kind = rancher2_machine_config_v2.nodes[machine_pools.key].kind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name = replace(rancher2_machine_config_v2.nodes[machine_pools.key].name, &quot;_&quot;, &quot;-&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      machine_selector_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As the focus here is more on the <strong>Cilium Cluster Mesh</strong> setup, we will not go into much detail about the Terraform RKE2 deployment. If there is demand for an in-depth blog post about Terraform RKE2 deployments, feel free to get in touch.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-export-kubeconfig">Step 1: Export kubeconfig<a class="hash-link" aria-label="Direct link to Step 1: Export kubeconfig" title="Direct link to Step 1: Export kubeconfig" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-1-export-kubeconfig">â</a></h2>
<p>Either from the Terraform execution plan or via the Rancher UI, collect the kubeconfig of the RKE2 clusters. Alternatively, we can <code>SSH</code> into one of the RKE2 master nodes and collect the <code>kubeconfig</code> found in the directory <code>/etc/rancher/rke2/rke2.yaml</code>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;directory of kubeconfig&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl nodes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-helm-list-and-values-export">Step 2: Helm list and values export<a class="hash-link" aria-label="Direct link to Step 2: Helm list and values export" title="Direct link to Step 2: Helm list and values export" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-2-helm-list-and-values-export">â</a></h2>
<p>RKE2 comes with its own Cilium CNI Helm chart. That means RKE2 clusters will have an RKE2 Cilium Helm chart deployment in the <code>kube-system</code> namespace.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validate">Validate<a class="hash-link" aria-label="Direct link to Validate" title="Direct link to Validate" href="/personal-blog/blog/cilium-cluster-mesh-rke2#validate">â</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;directory of kubeconfig&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm list -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            	NAMESPACE  	REVISION	UPDATED                                	STATUS  	CHART                                       	APP VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-cilium                     	kube-system	1       	2024-07-13 09:32:09.981662 +0200 CEST  	deployed	rke2-cilium-1.15.500                        	1.15.5     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns                    	kube-system	1       	2024-07-13 07:05:49.846980773 +0000 UTC	deployed	rke2-coredns-1.29.002                       	1.11.1     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-ingress-nginx              	kube-system	1       	2024-07-13 07:06:24.63272854 +0000 UTC 	deployed	rke2-ingress-nginx-4.8.200                  	1.9.3      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-metrics-server             	kube-system	1       	2024-07-13 07:06:24.86243331 +0000 UTC 	deployed	rke2-metrics-server-2.11.100-build2023051513	0.6.3      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-snapshot-controller        	kube-system	1       	2024-07-13 07:06:26.764326178 +0000 UTC	deployed	rke2-snapshot-controller-1.7.202            	v6.2.1     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-snapshot-controller-crd    	kube-system	1       	2024-07-13 07:06:24.217899546 +0000 UTC	deployed	rke2-snapshot-controller-crd-1.7.202        	v6.2.1     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-snapshot-validation-webhook	kube-system	1       	2024-07-13 07:06:24.544748567 +0000 UTC	deployed	rke2-snapshot-validation-webhook-1.7.302    	v6.2.2 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="collect-rke2-cilium-helm-values">Collect rke2-cilium Helm Values<a class="hash-link" aria-label="Direct link to Collect rke2-cilium Helm Values" title="Direct link to Collect rke2-cilium Helm Values" href="/personal-blog/blog/cilium-cluster-mesh-rke2#collect-rke2-cilium-helm-values">â</a></h3>
<p><strong>mesh01</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm get values rke2-cilium -n kube-system -o yaml &gt; values_mesh01.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>mesh02</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm get values rke2-cilium -n kube-system -o yaml &gt; values_mesh02.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Example values_mesh01.yaml</strong></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cattle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">clusterId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">8ffz659l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterCIDR</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.244.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterCIDRv4</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.244.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterDNS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.96.0.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterDomain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rke2DataDir</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/lib/rancher/rke2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceCIDR</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.96.0.0/18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">hubble</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">peerService</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">clusterDomain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">relay</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">auto</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">certValidityDuration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1095</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">method</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ui</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">k8sServiceHost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">k8sServicePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kubeProxyReplacement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">operator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The configuration comes from the <code>machine_global_config</code> and <code>chart_values</code> sections defined in the Terraform code found in <a href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-0-rke2-terraform-provider">Step 0</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-cilium-cluster-mesh-helm-values">Step 3: Cilium Cluster Mesh Helm Values<a class="hash-link" aria-label="Direct link to Step 3: Cilium Cluster Mesh Helm Values" title="Direct link to Step 3: Cilium Cluster Mesh Helm Values" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-3-cilium-cluster-mesh-helm-values">â</a></h2>
<p>To set up the Cilium cluster mesh, we need to include the <code>rke2-charts</code> repo and later on, update the Helm values with the required cluster mesh settings. For this demonstration, we will use the <code>NodePort</code> deployment. For production environments, a <code>LoadBalancer</code> deployment is recommended as we do not have to rely on Node availability.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-rke2-charts-repo">Add rke2-charts Repo<a class="hash-link" aria-label="Direct link to Add rke2-charts Repo" title="Direct link to Add rke2-charts Repo" href="/personal-blog/blog/cilium-cluster-mesh-rke2#add-rke2-charts-repo">â</a></h3>
<p>The action should be performed in both clusters.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm repo add rke2-charts https://rke2-charts.rancher.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm repo update</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="update-mesh01-helm-values">Update mesh01 Helm Values<a class="hash-link" aria-label="Direct link to Update mesh01 Helm Values" title="Direct link to Update mesh01 Helm Values" href="/personal-blog/blog/cilium-cluster-mesh-rke2#update-mesh01-helm-values">â</a></h3>
<p>On the same level as global, add the below configuration.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ca</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cert</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Base64 encoded shared CA crt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Base64 encoded shared CA key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mesh01 </span><span class="token comment" style="color:#999988;font-style:italic"># The unique name of the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The unique ID of the cluster used for the cluster mesh formation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">clustermesh</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiserver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NodePort </span><span class="token comment" style="color:#999988;font-style:italic"># Set the Clustermesh API service to be of type NodePort. Not recommended for Production environments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32379</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the listening port for the Clustermesh API service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">authMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">extraDnsNames</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mesh01.mesh.cilium.io&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the extra DNS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">clusters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ips</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> &lt;Node IP</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The Node IP of the mesh02 cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mesh02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32380</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The NodePort defined on mesh02 for the Clustermesh API service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mesh.cilium.io&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the default domain for the mesh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">useAPIServer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Enable the Clustermesh API deployment</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="update-mesh02-helm-values">Update mesh02 Helm Values<a class="hash-link" aria-label="Direct link to Update mesh02 Helm Values" title="Direct link to Update mesh02 Helm Values" href="/personal-blog/blog/cilium-cluster-mesh-rke2#update-mesh02-helm-values">â</a></h3>
<p>On the same level as global, add the below configuration.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ca</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cert</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Base64 encoded shared CA crt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Base64 encoded shared CA key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mesh02 </span><span class="token comment" style="color:#999988;font-style:italic"># The unique name of the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The unique ID of the cluster used for the cluster mesh formation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">clustermesh</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiserver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NodePort </span><span class="token comment" style="color:#999988;font-style:italic"># Set the Clustermesh API service to be of type NodePort. Not recommended for production environments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32380</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the listening port for the Clustermesh API service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">authMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">extraDnsNames</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mesh02.mesh.cilium.io&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the extra DNS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">clusters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ips</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> &lt;Node IP</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The Node IP of the mesg01 cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mesh01 </span><span class="token comment" style="color:#999988;font-style:italic"># Define the name of the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32379</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The NodePort defined on mesh02 for the Clustermesh API service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mesh.cilium.io&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the default domain for the mesh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">useAPIServer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Enable the Clustermesh API deployment</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="update-mesh01mesh02-helm-deployment">Update mesh01/mesh02 Helm deployment<a class="hash-link" aria-label="Direct link to Update mesh01/mesh02 Helm deployment" title="Direct link to Update mesh01/mesh02 Helm deployment" href="/personal-blog/blog/cilium-cluster-mesh-rke2#update-mesh01mesh02-helm-deployment">â</a></h3>
<p>To ensure the updated Helm values are applied, we will use the HELM CLI to update the <code>rke2-cilium</code> deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm upgrade rke2-cilium rke2-charts/rke2-cilium --version 1.15.500 --namespace kube-system -f values_mesh01.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm list -n kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Perform the commands for the <code>mesh02</code> cluster.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The <code>helm upgrade</code> command will create a new revision of the <code>rke2-cilium</code> application and show if the update was successful or not. Additionally, the cilium daemonset will get restarted and the Clustermesh API deployment will get created. Execute the commands below to double-check the update action.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl rollout status daemonset cilium -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods,svc -n kube-system | grep -i clustermesh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-validate-cilium-cluster-mesh">Step 4: Validate Cilium Cluster Mesh<a class="hash-link" aria-label="Direct link to Step 4: Validate Cilium Cluster Mesh" title="Direct link to Step 4: Validate Cilium Cluster Mesh" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-4-validate-cilium-cluster-mesh">â</a></h2>
<p>As we do not use the Cilium CLI, to ensure the Cilium cluster mesh works as expected, we will exec into the cilium daemonset and check the required details.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ds -n kube-system | grep -i cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium                          4         4         4       4            4           kubernetes.io/os=linux   7d6h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="on-mesh01-and-mesh02">On mesh01 and mesh02<a class="hash-link" aria-label="Direct link to On mesh01 and mesh02" title="Direct link to On mesh01 and mesh02" href="/personal-blog/blog/cilium-cluster-mesh-rke2#on-mesh01-and-mesh02">â</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it ds/cilium -n kube-system -- cilium status | grep -i clustermesh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Defaulted container &quot;cilium-agent&quot; out of: cilium-agent, install-portmap-cni-plugin (init), config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClusterMesh:             1/1 clusters ready, 11 global-services</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>On both sides, the <code>ClusterMesh</code> should point to <code>1/1 clusters ready</code>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it ds/cilium -n kube-system -- cilium-health status               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Defaulted container &quot;cilium-agent&quot; out of: cilium-agent, install-portmap-cni-plugin (init), config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Probe time:   2024-07-20T13:58:47Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Nodes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh01/mesh01-controller-3d16581b-7q5bj (localhost):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=693.829Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=118.583Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.244.1.71:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=688.411Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=251.927Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh01/mesh01-controller-3d16581b-v58rq:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=671.007Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=237.395Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.244.0.75:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=702.976Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=342.115Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh01/mesh01-worker-7ced0c6c-lz9sp:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=819.21Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=397.398Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.244.3.215:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=821.223Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=465.965Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh01/mesh01-worker-7ced0c6c-w294x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=738.787Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=335.803Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.244.2.36:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=693.326Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=426.571Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh02/mesh02-controller-52d8e160-b27rn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=683.278Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=335.076Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.245.0.106:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=818.386Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=387.314Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh02/mesh02-controller-52d8e160-q4rvf:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=683.097Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=301.448Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.245.1.75:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=748.101Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=510.124Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh02/mesh02-worker-a1c14ae0-5l759:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=631.954Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=266.391Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.245.3.232:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=751.853Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=433.049Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh02/mesh02-worker-a1c14ae0-c7tcb:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=671.823Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=365.949Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.245.2.69:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=690.894Âµs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=466.73Âµs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>With the cilium-health status command, you should be able to see all the nodes from both clusters. Check the ICMP and HTTP status. Should be &quot;OK&quot;.</p><p>Also, it might take a couple of minutes till the cilium-health status is available.</p><p>If the time-out persists, have a look at the firewall rules and whether traffic between the clusters is allowed.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>The NodePort IP addresses set for the cluster mesh need to be the IP addresses of the worker node instead of the master node. If they are the master node, the Cilium Cluster Mesh will not get deployed and we will get the below error.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">remote-etcd-cluster01                                                             4m25s ago      4s ago       22      failed to detect whether the cluster configuration is required: etcdserver: permission denied </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-5-hubble-ui">Step 5: Hubble UI<a class="hash-link" aria-label="Direct link to Step 5: Hubble UI" title="Direct link to Step 5: Hubble UI" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-5-hubble-ui">â</a></h2>
<p>To work with the Hubble UI we can use the <code>kubectl port-forward</code> of the Hubble UI service or update the existing <code>rke2-cilium</code> deployment on one of the nodes and expose the Hubble UI as a <code>NodePort</code> service. Just include the below in the <code>values_mesh01.yaml</code> or the <code>values_mesh02.yaml</code> file.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ui</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NodePort</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For more information about the RKE2 Cilium Helm Chart values, have a look <a href="https://artifacthub.io/packages/helm/rke2-charts/rke2-cilium/1.15.500" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-contact">âï¸ Contact<a class="hash-link" aria-label="Direct link to âï¸ Contact" title="Direct link to âï¸ Contact" href="/personal-blog/blog/cilium-cluster-mesh-rke2#ï¸-contact">â</a></h2>
<p>If you have any questions, feel free to get in touch! You can use the <code>Discussions</code> option found <a href="https://github.com/egrosdou01/personal-blog/discussions" target="_blank" rel="noopener noreferrer">here</a> or reach out to me on any of the social media platforms provided. ð</p>
<p>We look forward to hearing from you!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="/personal-blog/blog/cilium-cluster-mesh-rke2#conclusions">â</a></h2>
<p>This is it! We performed a Cilium cluster mesh between two on-prem RKE2 clusters in just a few steps! ð</p>
<p>It&#x27;s a wrap for this post! ð Thanks for reading! Stay tuned for more exciting updates!</p></div><div class="blog-post-spacing"></div><div class="social-share-container"><div class="social-share"><p class="shareText_x93L">SHARE</p><button class="react-share__ShareButton shareButton_AVfu" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="25" height="25"><circle cx="32" cy="32" r="32" fill="#0077B5"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button class="react-share__ShareButton shareButton_AVfu" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="25" height="25"><circle cx="32" cy="32" r="32" fill="#000000"></circle><path d="M 41.116 18.375 h 4.962 l -10.8405 12.39 l 12.753 16.86 H 38.005 l -7.821 -10.2255 L 21.235 47.625 H 16.27 l 11.595 -13.2525 L 15.631 18.375 H 25.87 l 7.0695 9.3465 z m -1.7415 26.28 h 2.7495 L 24.376 21.189 H 21.4255 z" fill="white"></path></svg></button><button class="react-share__ShareButton shareButton_AVfu" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="25" height="25"><circle cx="32" cy="32" r="32" fill="#FF5700"></circle><path d="M 53.34375 32 C 53.277344 30.160156 52.136719 28.53125 50.429688 27.839844 C 48.722656 27.148438 46.769531 27.523438 45.441406 28.800781 C 41.800781 26.324219 37.519531 24.957031 33.121094 24.863281 L 35.199219 14.878906 L 42.046875 16.320312 C 42.214844 17.882812 43.496094 19.09375 45.066406 19.171875 C 46.636719 19.253906 48.03125 18.183594 48.359375 16.644531 C 48.6875 15.105469 47.847656 13.558594 46.382812 12.992188 C 44.914062 12.425781 43.253906 13.007812 42.464844 14.367188 L 34.625 12.800781 C 34.363281 12.742188 34.09375 12.792969 33.871094 12.9375 C 33.648438 13.082031 33.492188 13.308594 33.441406 13.566406 L 31.070312 24.671875 C 26.617188 24.738281 22.277344 26.105469 18.59375 28.609375 C 17.242188 27.339844 15.273438 26.988281 13.570312 27.707031 C 11.863281 28.429688 10.746094 30.089844 10.71875 31.941406 C 10.691406 33.789062 11.757812 35.484375 13.441406 36.257812 C 13.402344 36.726562 13.402344 37.195312 13.441406 37.664062 C 13.441406 44.832031 21.792969 50.65625 32.097656 50.65625 C 42.398438 50.65625 50.753906 44.832031 50.753906 37.664062 C 50.789062 37.195312 50.789062 36.726562 50.753906 36.257812 C 52.363281 35.453125 53.371094 33.800781 53.34375 32 Z M 21.34375 35.199219 C 21.34375 33.433594 22.777344 32 24.542969 32 C 26.3125 32 27.742188 33.433594 27.742188 35.199219 C 27.742188 36.96875 26.3125 38.398438 24.542969 38.398438 C 22.777344 38.398438 21.34375 36.96875 21.34375 35.199219 Z M 39.9375 44 C 37.664062 45.710938 34.871094 46.582031 32.03125 46.464844 C 29.191406 46.582031 26.398438 45.710938 24.128906 44 C 23.847656 43.65625 23.871094 43.15625 24.183594 42.839844 C 24.5 42.527344 25 42.503906 25.34375 42.785156 C 27.269531 44.195312 29.617188 44.90625 32 44.800781 C 34.386719 44.929688 36.746094 44.242188 38.6875 42.847656 C 39.042969 42.503906 39.605469 42.511719 39.953125 42.863281 C 40.296875 43.21875 40.289062 43.785156 39.9375 44.128906 Z M 39.359375 38.527344 C 37.59375 38.527344 36.160156 37.09375 36.160156 35.328125 C 36.160156 33.5625 37.59375 32.128906 39.359375 32.128906 C 41.128906 32.128906 42.558594 33.5625 42.558594 35.328125 C 42.59375 36.203125 42.269531 37.054688 41.65625 37.6875 C 41.046875 38.316406 40.203125 38.664062 39.328125 38.65625 Z M 39.359375 38.527344" fill="white"></path></svg></button><button class="react-share__ShareButton shareButton_AVfu" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="25" height="25"><circle cx="32" cy="32" r="32" fill="#7f7f7f"></circle><path d="M17,22v20h30V22H17z M41.1,25L32,32.1L22.9,25H41.1z M20,39V26.6l12,9.3l12-9.3V39H20z" fill="white"></path></svg></button></div></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="eBPF-based Networking, Security, and Observability for Kubernetes" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/cilium">Cilium</a></li><li class="tag_QGVx"><a title="Rancher Kubernetes Engine 2 (RKE2)" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/rke2">RKE2</a></li><li class="tag_QGVx"><a title="Open source software" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/open-source">Open Source</a></li><li class="tag_QGVx"><a title="Container orchestration platform for automating application deployment, scaling, and management" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a title="Operational framework that uses Git as a single source of truth for declarative infrastructure and applications" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/gitops">GitOps</a></li><li class="tag_QGVx"><a title="Set of practices that combines software development and IT operations" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/devops">DevOps</a></li><li class="tag_QGVx"><a title="The year the post went online" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/2024">2024</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/personal-blog/blog/rancher-rke2-cilium-azure"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Rancher RKE2 Cluster on Azure</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/personal-blog/blog/cilium-eks-sveltos"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Cilium on EKS with Sveltos</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#introduction">Introduction</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#lab-setup">Lab Setup</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#prerequisites">Prerequisites</a><ul><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#infrastructure">Infrastructure</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#cilium-cluster-mesh">Cilium Cluster Mesh</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#resources">Resources</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-0-rke2-terraform-provider">Step 0: RKE2 Terraform Provider</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-1-export-kubeconfig">Step 1: Export kubeconfig</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-2-helm-list-and-values-export">Step 2: Helm list and values export</a><ul><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#validate">Validate</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#collect-rke2-cilium-helm-values">Collect rke2-cilium Helm Values</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-3-cilium-cluster-mesh-helm-values">Step 3: Cilium Cluster Mesh Helm Values</a><ul><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#add-rke2-charts-repo">Add rke2-charts Repo</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#update-mesh01-helm-values">Update mesh01 Helm Values</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#update-mesh02-helm-values">Update mesh02 Helm Values</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#update-mesh01mesh02-helm-deployment">Update mesh01/mesh02 Helm deployment</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-4-validate-cilium-cluster-mesh">Step 4: Validate Cilium Cluster Mesh</a><ul><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#on-mesh01-and-mesh02">On mesh01 and mesh02</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#step-5-hubble-ui">Step 5: Hubble UI</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#ï¸-contact">âï¸ Contact</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/cilium-cluster-mesh-rke2#conclusions">Conclusions</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">About</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/personal-blog/">About me</a></li></ul></div><div class="col footer__col"><div class="footer__title">Socials</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://linkedin.com/in/eleni-grosdouli-85a1a5116" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/egrosdou01" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://medium.com/@eleni.grosdouli" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/personal-blog/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 Eleni Grosdouli Blog</div></div></div></footer></div>
</body>
</html>