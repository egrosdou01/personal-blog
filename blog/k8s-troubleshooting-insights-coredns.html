<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">K8s Troubleshooting Insights: Looking into CoreDNS Issues | Welcome to Eleni&#x27;s Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://github.com/personal-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://github.com/personal-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="K8s Troubleshooting Insights: Looking into CoreDNS Issues | Welcome to Eleni&#x27;s Blog"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-10-27T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/egrosdou01"><meta data-rh="true" property="article:tag" content="Kubernetes,Open Source,Troubleshooting Insights,RKE2,2024"><link data-rh="true" rel="icon" href="https://github.com/egrosdou01.png"><link data-rh="true" rel="canonical" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns"><link data-rh="true" rel="alternate" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns" hreflang="en"><link data-rh="true" rel="alternate" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns","mainEntityOfPage":"https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns","url":"https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns","headline":"K8s Troubleshooting Insights: Looking into CoreDNS Issues","name":"K8s Troubleshooting Insights: Looking into CoreDNS Issues","description":"Introduction","datePublished":"2024-10-27T00:00:00.000Z","author":{"@type":"Person","name":"Eleni Grosdouli","description":"DevOps Consulting Engineer at Cisco Systems","url":"https://github.com/egrosdou01","image":"https://github.com/egrosdou01.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://github.com/personal-blog/blog","name":"Eleni Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/personal-blog/blog/rss.xml" title="Welcome to Eleni&#39;s Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/personal-blog/blog/atom.xml" title="Welcome to Eleni&#39;s Blog Atom Feed"><link rel="stylesheet" href="/personal-blog/assets/css/styles.8e64e2c7.css">
<script src="/personal-blog/assets/js/runtime~main.2b7dd48f.js" defer="defer"></script>
<script src="/personal-blog/assets/js/main.4a8a7eaa.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/personal-blog/"><div class="navbar__logo"><img src="https://github.com/egrosdou01.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="https://github.com/egrosdou01.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">About</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/personal-blog/blog">Blog</a><a class="navbar__item navbar__link" href="/personal-blog/blog/tags">Tags</a><a class="navbar__item navbar__link" href="/personal-blog/talks">Talks</a><a class="navbar__item navbar__link" href="/personal-blog/favourites">Favourites</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/egrosdou01" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns">K8s Troubleshooting Insights: Looking into CoreDNS Issues</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/sveltos-cilium-tetragon-day2-operations">Sveltos: Optimising Day-2 Operations with Cilium and Tetragon</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/sveltos-introduction-to-tiers">Sveltos Tiers: Efficient Day-2 Operations and Targeted Updates</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/ossummit-europe-2024">OSSummit Europe 2024</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/civo-navigate-berlin-2024">Civo Navigate Berlin 2024</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/personal-blog/blog/opentofu-rke2-cilium-azure">OpenTofu: RKE2 Cluster with Cilium on Azure</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_xvU1">K8s Troubleshooting Insights: Looking into CoreDNS Issues</h1><div class="container_iJTo margin-vert--md"><time datetime="2024-10-27T00:00:00.000Z">October 27, 2024</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_q4o9"><div class="avatar margin-bottom--sm"><a href="https://github.com/egrosdou01" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/egrosdou01.png" alt="Eleni Grosdouli"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/egrosdou01" target="_blank" rel="noopener noreferrer"><span>Eleni Grosdouli</span></a></div><small class="avatar__subtitle">DevOps Consulting Engineer at Cisco Systems</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#introduction">​</a></h2>
<p>Welcome to the the first post of the brand new Kubernetes Troubleshooting Insights section! The series of blog posts will share helpful information and troubleshooting tips for issues that might appear in a Kubernetes environment. The posts are focused on real-life scenarios from either <code>test</code>, <code>staging</code> or <code>production</code> environments.</p>
<p>In today’s blog post, we’ll explore an issue with <a href="https://kubernetes.io/docs/tasks/administer-cluster/coredns/" target="_blank" rel="noopener noreferrer">CoreDNS</a> setup on <a href="https://docs.rke2.io/" target="_blank" rel="noopener noreferrer">RKE2</a> clusters. <a href="https://docs.cilium.io/en/stable/overview/intro/#what-is-cilium" target="_blank" rel="noopener noreferrer">Cilium</a> CNI with <a href="https://docs.cilium.io/en/stable/overview/intro/#what-is-hubble" target="_blank" rel="noopener noreferrer">Hubble</a> were enabled for this setup. Let’s jump right in!</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;It&amp;#39;s not DNS&amp;quot;" src="/personal-blog/assets/images/its_not_dns-7c9e0117b51945b16881a20c7d6a2878.jpeg" width="552" height="414" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="environment-setup">Environment Setup<a class="hash-link" aria-label="Direct link to Environment Setup" title="Direct link to Environment Setup" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#environment-setup">​</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Cluster Name  |        Type       |         Version          |       OS       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    cluster01    |  Managed Cluster  |      v1.28.14+rke2r1     |   Ubuntu 22.04 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  Deployment  |        Version     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Cilium    |       v1.16.1      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="scenario">Scenario<a class="hash-link" aria-label="Direct link to Scenario" title="Direct link to Scenario" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#scenario">​</a></h2>
<p>DNS issues are wide and can be are caused by many reasons. Unfortunately, there is no one-size-fits-all approach when it comes to troubleshooting. In our scenario, we started with the virtual machines, ensured routing and DNS work and then moved to the Kubernetes layer. The blog post is an attempt to provide readers with troubleshooting ideas about DNS issues.</p>
<p><strong>Background</strong>: We performed a major migration to a new instance with <strong>new DNS</strong> servers and <strong>domains</strong>. We had to test if everything worked with the new setup. Everything appeared fine apart from synchronising <strong>ArgoCD</strong> with internal Git repositories. An error from an <strong>internal Kubernetes IP address</strong> on port <strong>53</strong> appeared. Weird, right? We were confident the underlying virtual machines were using the correct DNS, and the configuration of the DHCP server was updated.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The troubleshooting session was performed on an Ubuntu 22.04 environment. If another operating system is used, the troubleshooting methodology remains the same. The Linux commands will be different.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-steps">Troubleshooting Steps<a class="hash-link" aria-label="Direct link to Troubleshooting Steps" title="Direct link to Troubleshooting Steps" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#troubleshooting-steps">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-underlying-infrastructure">Step 1: Underlying Infrastructure<a class="hash-link" aria-label="Direct link to Step 1: Underlying Infrastructure" title="Direct link to Step 1: Underlying Infrastructure" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#step-1-underlying-infrastructure">​</a></h3>
<p>The below steps were performed to double-check the underlying infrastructure.</p>
<ol>
<li>
<p><strong>DHCP Server (if used)</strong>: Ensure the configuration points to the new DNS servers</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat /etc/dhcp/dhcpd.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Check the <code>domain-name-servers</code> configuration.</p>
</li>
<li>
<p><strong>Cluster Node</strong>: Perform an SSH connection to one of the cluster nodes</p>
<ol>
<li>
<p>Check the DNS configuration</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat /etc/resolv.conf # Check the local DNS configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo resolvectl status # Check the global and per-link DNS settings currently in effect</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From the command above, we would like to see how the Ethernet network interface on the virtual machine resolves domains. The <code>resolvectl status</code> command will reveal the use of the new DNS servers.</p>
</li>
<li>
<p>Check routing</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ping test-site.example-domain.com # Check whether we can reach the custom domain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ping 8.8.8.8 # Check whether we can reach the Internet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If one of the commands above fail, this might be an indication that routing is broken, or something else is blocking traffic.</p>
<p>If the commands above are successful, we continue with the next step and dive into the Kubernetes world.</p>
</li>
</ol>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-kubernetes-troubleshooting">Step 2: Kubernetes Troubleshooting<a class="hash-link" aria-label="Direct link to Step 2: Kubernetes Troubleshooting" title="Direct link to Step 2: Kubernetes Troubleshooting" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#step-2-kubernetes-troubleshooting">​</a></h3>
<p>Depending on the Kubernetes environment in place, identify how DNS queries are resolved from a Kubernetes cluster point of view. In our case, the RKE2 clusters use <code>CoreDNS</code>.</p>
<p>Even from a Kubernetes point of view, we will perform the well used <code>ping</code> and <code>curl</code> commands to see what is going on. For that reason, we will deploy the <code>dns-utils</code> pod to perform network calls.</p>
<ol>
<li>
<p>Deploy the <code>dns-utils</code> <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/" target="_blank" rel="noopener noreferrer">pod</a> to check DNS queries</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: dnsutils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: dnsutils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: registry.k8s.io/e2e-test-images/agnhost:2.39</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      restartPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Exec into the <code>dnsutils</code> pod - Perform <code>ping</code> and <code>dig</code> to well known website</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $ kubectl exec -it dnsutils -- /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  / # ping 8.8.8.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PING 8.8.8.8 (8.8.8.8): 56 data bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  64 bytes from 8.8.8.8: icmp_seq=0 ttl=119 time=41.526 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  / # dig SOA www.google.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ;; AUTHORITY SECTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  google.com.		30	IN	SOA	&lt;YOUR DNS Server&gt;.google.com. dns-admin.google.com. 689372973 900 900 1800 60</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the above commands are successful, we know that routing and resolution works for well known websites.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Learn more about <a href="https://www.cloudflare.com/en-gb/learning/dns/dns-records/dns-soa-record/" target="_blank" rel="noopener noreferrer">SOA</a>.</p></div></div>
</li>
<li>
<p>Exec into the <code>dnsutils</code> pod - Perform <code>curl</code> and <code>dig</code> to the custom domain</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $ kubectl exec -it dnsutils -- /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  / # curl -vvv example-domain.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * Could not resolve host: example-domain.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * Closing connection 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curl: (6) Could not resolve host: example-domain.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  / # dig SOA example-domain.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ;; AUTHORITY SECTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    example-domain.com.	20	IN	SOA	ns.dns.example-domain.com. hostmaster.example-domain.com. 1729344685 7200 1800 86400 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  / # dig @YOUR DNS Server SOA example-domain.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ;; AUTHORITY SECTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  example-domain.com. 3600	IN	SOA	&lt;YOUR DNS SERVER NAME&gt;.example-domain.com. mail.example-domain.com. 1729687405 604800 86400 2419200 604800</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From the above, we can see that we can resolve the custom domain by defining our DNS server. But, when we do not define it the responsible entity to answer the DNS queries of the custom zone is set to the name <code>ns.dns.</code>. What is going on here? We would expect the DNS quetries to be resolved by the DNS serve defined in the virtual machines.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>It is important to check the <code>AUTHORITY SECTION</code> of the <code>dig</code> command output.
<code>SOA ns.dns.example-domain.com.</code> signifies this is an SOA record, which provides essential information about a DNS zone. The <code>ns.dns.example-domain.com.</code> defines the primary DNS for that domain. But why? We would expect to see one of the new DNS servers instead.</p></div></div>
</li>
<li>
<p>Identify the CoreDNS deployment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get deploy -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns              2/2     2            2           23h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns-autoscaler   1/1     1            1           23h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Check the <code>CoreDNS ConfigMap</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cm -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chart-content-rke2-coredns                             1      23h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns                              1      23h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns-autoscaler                   1      23h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cm rke2-coredns-rke2-coredns -n kube-system -o jsonpath=&#x27;{.data.Corefile}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .:53 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  errors </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  health  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lameduck 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ready </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubernetes example-domain.com   cluster.local  cluster.local in-addr.arpa ip6.arpa {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pods insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fallthrough in-addr.arpa ip6.arpa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ttl 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prometheus   0.0.0.0:9153</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  forward   . /etc/resolv.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cache   30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loop </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  reload </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loadbalance </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Exec to the CoreDNS deployment and <code>cat</code> the <code>/etc/resolv.conf</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it deploy/rke2-coredns-rke2-coredns -n kube-system -- cat /etc/resolv.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nameserver &lt;DNS01 IP&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nameserver &lt;DNS02 IP&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the above output returns the expected nameservers, continue with the next step.</p>
</li>
<li>
<p>Analyse the CoreDNS config</p>
<p>The output <code>kubernetes example-domain.com   cluster.local  cluster.local in-addr.arpa ip6.arpa</code> indicates that <code>CoreDNS</code> is responsible for responsing to DNS queries of the specified zones including <code>example-domain.com</code>. Should <code>CoreDNS</code> be responsible, or this is just a misconfiguration?</p>
</li>
</ol>
<p>In our case, the custom domain was included to the <code>CoreDNS</code> configuration by mistake. Responses to DNS queries related to the custom domain should be forwarded to the defined DNS server instead.</p>
<p>If this is the case for your environment, edit the <code>ConfigMap</code> and remove the custom domain from the configuration. Use the commands below.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl patch cm rke2-coredns-rke2-coredns -n kube-system --type=&#x27;json&#x27; -p=&#x27;[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/data/Corefile&quot;, &quot;value&quot;: &quot;.:53 {\n    errors \n    health  {\n        lameduck 5s\n    }\n    ready \n    kubernetes cluster.local cluster.local in-addr.arpa ip6.arpa {\n        pods insecure\n        fallthrough in-addr.arpa ip6.arpa\n        ttl 30\n    }\n    prometheus 0.0.0.0:9153\n    forward . /etc/resolv.conf\n    cache 30\n    loop \n    reload \n    loadbalance \n}&quot;}]&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/rke2-coredns-rke2-coredns patched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cm rke2-coredns-rke2-coredns -n kube-system -o jsonpath=&#x27;{.data.Corefile}&#x27; # Ensure the custom domain is removed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it dnsutils -- /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/ # curl &lt;domain&gt;:&lt;port&gt; # You should be able to resolved the domain now</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optional-kubernetes-troubleshoot-with-cilium-hubble">Optional: Kubernetes Troubleshoot with Cilium Hubble<a class="hash-link" aria-label="Direct link to Optional: Kubernetes Troubleshoot with Cilium Hubble" title="Direct link to Optional: Kubernetes Troubleshoot with Cilium Hubble" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#optional-kubernetes-troubleshoot-with-cilium-hubble">​</a></h3>
<p>Another option to troubleshoot network issues is with Hubble. If it is available as part of your installation, you can exec into the Cilium <code>daemonset</code> and start using the Hubble CLI to observe traffic. For example, you can use something like the below.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it ds/cilium -n kube-system -- /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># hubble observe --pod rke2-coredns-rke2-coredns-84b9cb946c-b7l9k --namespace kube-system --protocol UDP -f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The command above will display UDP packages between the <code>dnsutils</code> pod and <code>CoreDNS</code>. The Hubble cheat sheet can be found <a href="https://cilium.isovalent.com/hubfs/marketing%20briefs/Isovalent%20-%20Cilium%20Hubble%20Cheat%20Sheet.pdf" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optional-kubernetes-troubleshoot-with-netshoot-pod-and-tcpdump">Optional: Kubernetes Troubleshoot with Netshoot Pod and TCPDump<a class="hash-link" aria-label="Direct link to Optional: Kubernetes Troubleshoot with Netshoot Pod and TCPDump" title="Direct link to Optional: Kubernetes Troubleshoot with Netshoot Pod and TCPDump" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#optional-kubernetes-troubleshoot-with-netshoot-pod-and-tcpdump">​</a></h3>
<p>If we want to see what happens with the UDP packages when we perform a <code>CURL</code> request on a custom domain, it might be easier to instantiate a <code>tcpdump</code> using the <a href="https://hub.docker.com/r/nicolaka/netshoot/tags" target="_blank" rel="noopener noreferrer">netshoot pod</a>. Follow the commands below.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl run -it --rm debug --image=nicolaka/netshoot -- /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">debug:~# tcpdump -i eth0 -n udp port 53</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once tcpdump is enabled, exec into the same pod and perform <code>CURL</code> requests.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it dnsutils -n kube-system -- /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/ # curl example-domain.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tcpdump-output">tcpdump Output<a class="hash-link" aria-label="Direct link to tcpdump Output" title="Direct link to tcpdump Output" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#tcpdump-output">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16:31:52.197604 IP 10.42.2.184.49109 &gt; 10.43.0.10.53: 59274+ [1au] A? example-domain.com.default.svc.cluster.local. (86)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16:31:52.197677 IP 10.42.2.184.49109 &gt; 10.43.0.10.53: 134+ [1au] AAAA? example-domain.com.default.svc.cluster.local. (86)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16:31:52.198333 IP 10.43.0.10.53 &gt; 10.42.2.184.49109: 59274 NXDomain*- 0/1/1 (179)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16:31:52.198553 IP 10.43.0.10.53 &gt; 10.42.2.184.49109: 134 NXDomain*- 0/1/1 (179)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The output above indicates that a client queries a DNS server, and the server responds that the domain <strong>does not exist</strong>. This would be a hint to check the <code>CoreDNS</code> configuration! :)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#resources">​</a></h2>
<ul>
<li><strong>Debugging DNS</strong>: <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="️-contact">✉️ Contact<a class="hash-link" aria-label="Direct link to ✉️ Contact" title="Direct link to ✉️ Contact" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#️-contact">​</a></h2>
<p>If you have any questions, feel free to get in touch! You can use the <code>Discussions</code> option found <a href="https://github.com/egrosdou01/personal-blog/discussions" target="_blank" rel="noopener noreferrer">here</a> or reach out to me on any of the social media platforms provided. 😊</p>
<p>We look forward to hearing from you!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#conclusions">​</a></h2>
<p>Is it DNS at the end? This is something you will have to find out! Hopefully, the post gave you some ideas to troubleshoot with confidence DNS issues in a Kubernetes environment.</p>
<p>It&#x27;s a wrap for this post! 🎉 Thanks for reading! Stay tuned for more exciting updates!</p></div><div class="blog-post-spacing"></div><div class="social-share-container"><div class="social-share"><p class="shareText_x93L">SHARE</p><button class="react-share__ShareButton shareButton_AVfu" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="25" height="25"><circle cx="32" cy="32" r="32" fill="#0077B5"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button class="react-share__ShareButton shareButton_AVfu" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="25" height="25"><circle cx="32" cy="32" r="32" fill="#000000"></circle><path d="M 41.116 18.375 h 4.962 l -10.8405 12.39 l 12.753 16.86 H 38.005 l -7.821 -10.2255 L 21.235 47.625 H 16.27 l 11.595 -13.2525 L 15.631 18.375 H 25.87 l 7.0695 9.3465 z m -1.7415 26.28 h 2.7495 L 24.376 21.189 H 21.4255 z" fill="white"></path></svg></button><button class="react-share__ShareButton shareButton_AVfu" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="25" height="25"><circle cx="32" cy="32" r="32" fill="#FF5700"></circle><path d="M 53.34375 32 C 53.277344 30.160156 52.136719 28.53125 50.429688 27.839844 C 48.722656 27.148438 46.769531 27.523438 45.441406 28.800781 C 41.800781 26.324219 37.519531 24.957031 33.121094 24.863281 L 35.199219 14.878906 L 42.046875 16.320312 C 42.214844 17.882812 43.496094 19.09375 45.066406 19.171875 C 46.636719 19.253906 48.03125 18.183594 48.359375 16.644531 C 48.6875 15.105469 47.847656 13.558594 46.382812 12.992188 C 44.914062 12.425781 43.253906 13.007812 42.464844 14.367188 L 34.625 12.800781 C 34.363281 12.742188 34.09375 12.792969 33.871094 12.9375 C 33.648438 13.082031 33.492188 13.308594 33.441406 13.566406 L 31.070312 24.671875 C 26.617188 24.738281 22.277344 26.105469 18.59375 28.609375 C 17.242188 27.339844 15.273438 26.988281 13.570312 27.707031 C 11.863281 28.429688 10.746094 30.089844 10.71875 31.941406 C 10.691406 33.789062 11.757812 35.484375 13.441406 36.257812 C 13.402344 36.726562 13.402344 37.195312 13.441406 37.664062 C 13.441406 44.832031 21.792969 50.65625 32.097656 50.65625 C 42.398438 50.65625 50.753906 44.832031 50.753906 37.664062 C 50.789062 37.195312 50.789062 36.726562 50.753906 36.257812 C 52.363281 35.453125 53.371094 33.800781 53.34375 32 Z M 21.34375 35.199219 C 21.34375 33.433594 22.777344 32 24.542969 32 C 26.3125 32 27.742188 33.433594 27.742188 35.199219 C 27.742188 36.96875 26.3125 38.398438 24.542969 38.398438 C 22.777344 38.398438 21.34375 36.96875 21.34375 35.199219 Z M 39.9375 44 C 37.664062 45.710938 34.871094 46.582031 32.03125 46.464844 C 29.191406 46.582031 26.398438 45.710938 24.128906 44 C 23.847656 43.65625 23.871094 43.15625 24.183594 42.839844 C 24.5 42.527344 25 42.503906 25.34375 42.785156 C 27.269531 44.195312 29.617188 44.90625 32 44.800781 C 34.386719 44.929688 36.746094 44.242188 38.6875 42.847656 C 39.042969 42.503906 39.605469 42.511719 39.953125 42.863281 C 40.296875 43.21875 40.289062 43.785156 39.9375 44.128906 Z M 39.359375 38.527344 C 37.59375 38.527344 36.160156 37.09375 36.160156 35.328125 C 36.160156 33.5625 37.59375 32.128906 39.359375 32.128906 C 41.128906 32.128906 42.558594 33.5625 42.558594 35.328125 C 42.59375 36.203125 42.269531 37.054688 41.65625 37.6875 C 41.046875 38.316406 40.203125 38.664062 39.328125 38.65625 Z M 39.359375 38.527344" fill="white"></path></svg></button><button class="react-share__ShareButton shareButton_AVfu" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="25" height="25"><circle cx="32" cy="32" r="32" fill="#7f7f7f"></circle><path d="M17,22v20h30V22H17z M41.1,25L32,32.1L22.9,25H41.1z M20,39V26.6l12,9.3l12-9.3V39H20z" fill="white"></path></svg></button></div></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="Container orchestration platform for automating application deployment, scaling, and management" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a title="Open source software" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/open-source">Open Source</a></li><li class="tag_QGVx"><a title="Label attached to posts related to K8s insights" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/troubleshooting-insights">Troubleshooting Insights</a></li><li class="tag_QGVx"><a title="Rancher Kubernetes Engine 2 (RKE2)" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/rke2">RKE2</a></li><li class="tag_QGVx"><a title="The year the post went online" class="tag_zVej tagRegular_sFm0" href="/personal-blog/blog/tags/2024">2024</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/personal-blog/blog/sveltos-cilium-tetragon-day2-operations"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Sveltos: Optimising Day-2 Operations with Cilium and Tetragon</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#introduction">Introduction</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#environment-setup">Environment Setup</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#scenario">Scenario</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#troubleshooting-steps">Troubleshooting Steps</a><ul><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#step-1-underlying-infrastructure">Step 1: Underlying Infrastructure</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#step-2-kubernetes-troubleshooting">Step 2: Kubernetes Troubleshooting</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#optional-kubernetes-troubleshoot-with-cilium-hubble">Optional: Kubernetes Troubleshoot with Cilium Hubble</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#optional-kubernetes-troubleshoot-with-netshoot-pod-and-tcpdump">Optional: Kubernetes Troubleshoot with Netshoot Pod and TCPDump</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#tcpdump-output">tcpdump Output</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#resources">Resources</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#️-contact">✉️ Contact</a></li><li><a class="table-of-contents__link toc-highlight" href="/personal-blog/blog/k8s-troubleshooting-insights-coredns#conclusions">Conclusions</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">About</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/personal-blog/">About me</a></li></ul></div><div class="col footer__col"><div class="footer__title">Socials</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://linkedin.com/in/eleni-grosdouli-85a1a5116" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/egrosdou01" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://medium.com/@eleni.grosdouli" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/personal-blog/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Eleni Grosdouli Blog</div></div></div></footer></div>
</body>
</html>