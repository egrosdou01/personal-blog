<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://github.com/personal-blog/blog</id>
    <title>Welcome to Eleni's Blog Blog</title>
    <updated>2024-10-27T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://github.com/personal-blog/blog"/>
    <subtitle>Welcome to Eleni's Blog Blog</subtitle>
    <icon>https://github.com/personal-blog/https://github.com/egrosdou01.png</icon>
    <entry>
        <title type="html"><![CDATA[K8s Troubleshooting Insights: Looking into CoreDNS Issues]]></title>
        <id>https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns</id>
        <link href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns"/>
        <updated>2024-10-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#introduction">‚Äã</a></h2>
<p>Welcome to the the first post of the brand&nbsp;new&nbsp;Kubernetes Troubleshooting Insights section! The series of blog posts will share helpful information and troubleshooting tips for issues that might appear in a Kubernetes environment. The posts are focused on real-life scenarios from either <code>test</code>, <code>staging</code> or <code>production</code> environments.</p>
<p>In today‚Äôs blog post, we‚Äôll explore an issue with <a href="https://kubernetes.io/docs/tasks/administer-cluster/coredns/" target="_blank" rel="noopener noreferrer">CoreDNS</a> setup on <a href="https://docs.rke2.io/" target="_blank" rel="noopener noreferrer">RKE2</a> clusters. <a href="https://docs.cilium.io/en/stable/overview/intro/#what-is-cilium" target="_blank" rel="noopener noreferrer">Cilium</a> CNI with <a href="https://docs.cilium.io/en/stable/overview/intro/#what-is-hubble" target="_blank" rel="noopener noreferrer">Hubble</a> were enabled for this setup. Let‚Äôs jump right in!</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;It&amp;#39;s not DNS&amp;quot;" src="https://github.com/personal-blog/assets/images/its_not_dns-7c9e0117b51945b16881a20c7d6a2878.jpeg" width="552" height="414" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="environment-setup">Environment Setup<a class="hash-link" aria-label="Direct link to Environment Setup" title="Direct link to Environment Setup" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#environment-setup">‚Äã</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Cluster Name  |        Type       |         Version          |       OS       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    cluster01    |  Managed Cluster  |      v1.28.14+rke2r1     |   Ubuntu 22.04 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  Deployment  |        Version     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Cilium    |       v1.16.1      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="scenario">Scenario<a class="hash-link" aria-label="Direct link to Scenario" title="Direct link to Scenario" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#scenario">‚Äã</a></h2>
<p>DNS issues are wide and can be are caused by many reasons. Unfortunately, there is no one-size-fits-all approach when it comes to troubleshooting. In our scenario, we started with the virtual machines, ensured routing and DNS work and then moved to the Kubernetes layer. The blog post is an attempt to provide readers with troubleshooting ideas about DNS issues.</p>
<p><strong>Background</strong>: We performed a major migration to a new instance with <strong>new DNS</strong> servers and <strong>domains</strong>. We had to test if everything worked with the new setup. Everything appeared fine apart from synchronising <strong>ArgoCD</strong> with internal Git repositories. An error from an <strong>internal Kubernetes IP address</strong> on port <strong>53</strong> appeared. Weird, right? We were confident the underlying virtual machines were using the correct DNS, and the configuration of the DHCP server was updated.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The troubleshooting session was performed on an Ubuntu 22.04 environment. If another operating system is used, the troubleshooting methodology remains the same. The Linux commands will be different.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-steps">Troubleshooting Steps<a class="hash-link" aria-label="Direct link to Troubleshooting Steps" title="Direct link to Troubleshooting Steps" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#troubleshooting-steps">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-underlying-infrastructure">Step 1: Underlying Infrastructure<a class="hash-link" aria-label="Direct link to Step 1: Underlying Infrastructure" title="Direct link to Step 1: Underlying Infrastructure" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#step-1-underlying-infrastructure">‚Äã</a></h3>
<p>The below steps were performed to double-check the underlying infrastructure.</p>
<ol>
<li>
<p><strong>DHCP Server (if used)</strong>: Ensure the configuration points to the new DNS servers</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat /etc/dhcp/dhcpd.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Check the <code>domain-name-servers</code> configuration.</p>
</li>
<li>
<p><strong>Cluster Node</strong>: Perform an SSH connection to one of the cluster nodes</p>
<ol>
<li>
<p>Check the DNS configuration</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat /etc/resolv.conf # Check the local DNS configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo resolvectl status # Check the global and per-link DNS settings currently in effect</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From the command above, we would like to see how the Ethernet network interface on the virtual machine resolves domains. The <code>resolvectl status</code> command will reveal the use of the new DNS servers.</p>
</li>
<li>
<p>Check routing</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ping test-site.example-domain.com # Check whether we can reach the custom domain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ping 8.8.8.8 # Check whether we can reach the Internet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If one of the commands above fail, this might be an indication that routing is broken, or something else is blocking traffic.</p>
<p>If the commands above are successful, we continue with the next step and dive into the Kubernetes world.</p>
</li>
</ol>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-kubernetes-troubleshooting">Step 2: Kubernetes Troubleshooting<a class="hash-link" aria-label="Direct link to Step 2: Kubernetes Troubleshooting" title="Direct link to Step 2: Kubernetes Troubleshooting" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#step-2-kubernetes-troubleshooting">‚Äã</a></h3>
<p>Depending on the Kubernetes environment in place, identify how DNS queries are resolved from a Kubernetes cluster point of view. In our case, the RKE2 clusters use <code>CoreDNS</code>.</p>
<p>Even from a Kubernetes point of view, we will perform the well used <code>ping</code> and <code>curl</code> commands to see what is going on. For that reason, we will deploy the <code>dns-utils</code> pod to perform network calls.</p>
<ol>
<li>
<p>Deploy the <code>dns-utils</code> <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/" target="_blank" rel="noopener noreferrer">pod</a> to check DNS queries</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: dnsutils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: dnsutils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: registry.k8s.io/e2e-test-images/agnhost:2.39</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      restartPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Exec into the <code>dnsutils</code> pod - Perform <code>ping</code> and <code>dig</code> to well known website</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $ kubectl exec -it dnsutils -- /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  / # ping 8.8.8.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PING 8.8.8.8 (8.8.8.8): 56 data bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  64 bytes from 8.8.8.8: icmp_seq=0 ttl=119 time=41.526 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  / # dig SOA www.google.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ;; AUTHORITY SECTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  google.com.		30	IN	SOA	&lt;YOUR DNS Server&gt;.google.com. dns-admin.google.com. 689372973 900 900 1800 60</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the above commands are successful, we know that routing and resolution works for well known websites.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Learn more about <a href="https://www.cloudflare.com/en-gb/learning/dns/dns-records/dns-soa-record/" target="_blank" rel="noopener noreferrer">SOA</a>.</p></div></div>
</li>
<li>
<p>Exec into the <code>dnsutils</code> pod - Perform <code>curl</code> and <code>dig</code> to the custom domain</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $ kubectl exec -it dnsutils -- /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  / # curl -vvv example-domain.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * Could not resolve host: example-domain.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * Closing connection 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curl: (6) Could not resolve host: example-domain.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  / # dig SOA example-domain.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ;; AUTHORITY SECTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    example-domain.com.	20	IN	SOA	ns.dns.example-domain.com. hostmaster.example-domain.com. 1729344685 7200 1800 86400 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  / # dig @YOUR DNS Server SOA example-domain.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ;; AUTHORITY SECTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  example-domain.com. 3600	IN	SOA	&lt;YOUR DNS SERVER NAME&gt;.example-domain.com. mail.example-domain.com. 1729687405 604800 86400 2419200 604800</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From the above, we can see that we can resolve the custom domain by defining our DNS server. But, when we do not define it the responsible entity to answer the DNS queries of the custom zone is set to the name&nbsp;<code>ns.dns.</code>. What is going on here? We would expect the DNS quetries to be resolved by the DNS serve defined in the virtual machines.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>It is important to check the <code>AUTHORITY SECTION</code> of the <code>dig</code> command output.
<code>SOA ns.dns.example-domain.com.</code> signifies this is an SOA record, which provides essential information about a DNS zone. The <code>ns.dns.example-domain.com.</code> defines the primary DNS for that domain. But why? We would expect to see one of the new DNS servers instead.</p></div></div>
</li>
<li>
<p>Identify the CoreDNS deployment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get deploy -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns              2/2     2            2           23h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns-autoscaler   1/1     1            1           23h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Check the <code>CoreDNS ConfigMap</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cm -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chart-content-rke2-coredns                             1      23h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns                              1      23h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns-autoscaler                   1      23h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cm rke2-coredns-rke2-coredns -n kube-system -o jsonpath='{.data.Corefile}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .:53 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  errors </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  health  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lameduck 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ready </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubernetes example-domain.com   cluster.local  cluster.local in-addr.arpa ip6.arpa {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pods insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fallthrough in-addr.arpa ip6.arpa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ttl 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prometheus   0.0.0.0:9153</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  forward   . /etc/resolv.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cache   30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loop </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  reload </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loadbalance </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Exec to the CoreDNS deployment and <code>cat</code> the <code>/etc/resolv.conf</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it deploy/rke2-coredns-rke2-coredns -n kube-system -- cat /etc/resolv.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nameserver &lt;DNS01 IP&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nameserver &lt;DNS02 IP&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the above output returns the expected nameservers, continue with the next step.</p>
</li>
<li>
<p>Analyse the CoreDNS config</p>
<p>The output <code>kubernetes example-domain.com   cluster.local  cluster.local in-addr.arpa ip6.arpa</code> indicates that <code>CoreDNS</code> is responsible for responsing to DNS queries of the specified zones including <code>example-domain.com</code>. Should <code>CoreDNS</code> be responsible, or this is just a misconfiguration?</p>
</li>
</ol>
<p>In our case, the custom domain was included to the <code>CoreDNS</code> configuration by mistake. Responses to DNS queries related to the custom domain should be forwarded to the defined DNS server instead.</p>
<p>If this is the case for your environment, edit the <code>ConfigMap</code> and remove the custom domain from the configuration. Use the commands below.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl patch cm rke2-coredns-rke2-coredns -n kube-system --type='json' -p='[{"op": "replace", "path": "/data/Corefile", "value": ".:53 {\n    errors \n    health  {\n        lameduck 5s\n    }\n    ready \n    kubernetes cluster.local cluster.local in-addr.arpa ip6.arpa {\n        pods insecure\n        fallthrough in-addr.arpa ip6.arpa\n        ttl 30\n    }\n    prometheus 0.0.0.0:9153\n    forward . /etc/resolv.conf\n    cache 30\n    loop \n    reload \n    loadbalance \n}"}]'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/rke2-coredns-rke2-coredns patched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cm rke2-coredns-rke2-coredns -n kube-system -o jsonpath='{.data.Corefile}' # Ensure the custom domain is removed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it dnsutils -- /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/ # curl &lt;domain&gt;:&lt;port&gt; # You should be able to resolved the domain now</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optional-kubernetes-troubleshoot-with-cilium-hubble">Optional: Kubernetes Troubleshoot with Cilium Hubble<a class="hash-link" aria-label="Direct link to Optional: Kubernetes Troubleshoot with Cilium Hubble" title="Direct link to Optional: Kubernetes Troubleshoot with Cilium Hubble" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#optional-kubernetes-troubleshoot-with-cilium-hubble">‚Äã</a></h3>
<p>Another option to troubleshoot network issues is with Hubble. If it is available as part of your installation, you can exec into the Cilium <code>daemonset</code> and start using the Hubble CLI to observe traffic. For example, you can use something like the below.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it ds/cilium -n kube-system -- /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># hubble observe --pod rke2-coredns-rke2-coredns-84b9cb946c-b7l9k --namespace kube-system --protocol UDP -f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The command above will display UDP packages between the <code>dnsutils</code> pod and <code>CoreDNS</code>. The Hubble cheat sheet can be found <a href="https://cilium.isovalent.com/hubfs/marketing%20briefs/Isovalent%20-%20Cilium%20Hubble%20Cheat%20Sheet.pdf" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optional-kubernetes-troubleshoot-with-netshoot-pod-and-tcpdump">Optional: Kubernetes Troubleshoot with Netshoot Pod and TCPDump<a class="hash-link" aria-label="Direct link to Optional: Kubernetes Troubleshoot with Netshoot Pod and TCPDump" title="Direct link to Optional: Kubernetes Troubleshoot with Netshoot Pod and TCPDump" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#optional-kubernetes-troubleshoot-with-netshoot-pod-and-tcpdump">‚Äã</a></h3>
<p>If we want to see what happens with the UDP packages when we perform a <code>CURL</code> request on a custom domain, it might be easier to instantiate a <code>tcpdump</code> using the <a href="https://hub.docker.com/r/nicolaka/netshoot/tags" target="_blank" rel="noopener noreferrer">netshoot pod</a>. Follow the commands below.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl run -it --rm debug --image=nicolaka/netshoot -- /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">debug:~# tcpdump -i eth0 -n udp port 53</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once tcpdump is enabled, exec into the same pod and perform <code>CURL</code> requests.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it dnsutils -n kube-system -- /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/ # curl example-domain.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tcpdump-output">tcpdump Output<a class="hash-link" aria-label="Direct link to tcpdump Output" title="Direct link to tcpdump Output" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#tcpdump-output">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16:31:52.197604 IP 10.42.2.184.49109 &gt; 10.43.0.10.53: 59274+ [1au] A? example-domain.com.default.svc.cluster.local. (86)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16:31:52.197677 IP 10.42.2.184.49109 &gt; 10.43.0.10.53: 134+ [1au] AAAA? example-domain.com.default.svc.cluster.local. (86)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16:31:52.198333 IP 10.43.0.10.53 &gt; 10.42.2.184.49109: 59274 NXDomain*- 0/1/1 (179)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16:31:52.198553 IP 10.43.0.10.53 &gt; 10.42.2.184.49109: 134 NXDomain*- 0/1/1 (179)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The output above indicates that a client queries a DNS server, and the server responds that the domain <strong>does not exist</strong>. This would be a hint to check the <code>CoreDNS</code> configuration! :)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#resources">‚Äã</a></h2>
<ul>
<li><strong>Debugging DNS</strong>: <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-contact">‚úâÔ∏è Contact<a class="hash-link" aria-label="Direct link to ‚úâÔ∏è Contact" title="Direct link to ‚úâÔ∏è Contact" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#%EF%B8%8F-contact">‚Äã</a></h2>
<p>If you have any questions, feel free to get in touch! You can use the <code>Discussions</code> option found <a href="https://github.com/egrosdou01/personal-blog/discussions" target="_blank" rel="noopener noreferrer">here</a> or reach out to me on any of the social media platforms provided. üòä</p>
<p>We look forward to hearing from you!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="https://github.com/personal-blog/blog/k8s-troubleshooting-insights-coredns#conclusions">‚Äã</a></h2>
<p>Is it DNS at the end? This is something you will have to find out! Hopefully, the post gave you some ideas to troubleshoot with confidence DNS issues in a Kubernetes environment.</p>
<p>It's a wrap for this post! üéâ Thanks for reading! Stay tuned for more exciting updates!</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Open Source" term="Open Source"/>
        <category label="Troubleshooting Insights" term="Troubleshooting Insights"/>
        <category label="RKE2" term="RKE2"/>
        <category label="2024" term="2024"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Sveltos: Optimising Day-2 Operations with Cilium and Tetragon]]></title>
        <id>https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations</id>
        <link href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations"/>
        <updated>2024-10-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#introduction">‚Äã</a></h2>
<p>How easy is it to handle <strong>Day-2</strong> operations with existing CI/CD tooling? <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">Sveltos</a> provides the ability to perform not only <strong>Day-1</strong> operations but also helps platform administrators, tenant administrators and other operators with <strong>Day-2</strong> operations. For example, we can use the <a href="https://github.com/projectsveltos/libsveltos/blob/main/api/v1beta1/healthcheck_type.go" target="_blank" rel="noopener noreferrer">HealthCheck</a> and the <a href="https://raw.githubusercontent.com/projectsveltos/libsveltos/main/api/v1beta1/clusterhealthcheck_type.go" target="_blank" rel="noopener noreferrer">ClusterHealthCheck</a> features to not only watch the health of a cluster but also collect information from the <code>managed</code> clusters and display them in the <code>management</code> cluster.</p>
<p>In today's blog post, we will cover a way of deploying <a href="https://cilium.io/" target="_blank" rel="noopener noreferrer">Cilium</a> as our CNI alongside <a href="https://tetragon.io/" target="_blank" rel="noopener noreferrer">Cilium Tetragon</a> for observability. We will then continue with a simple <code>TracingPolicy</code> deployment to capture socket connections and then use Sveltos to display the tracing results back to the <code>management</code> cluster.</p>
<p>The goal of the demonstration is to showcase how Sveltos can be used for different Kubernetes cluster operations based on the use case at hand.</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;Sveltos Health Check&amp;quot;" src="https://github.com/personal-blog/assets/images/Sveltos_Cilium_Tetragon_HealthCheck-d992c3bba4b4e87aa2c374f5216ba190.jpg" width="5065" height="3158" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-setup">Lab Setup<a class="hash-link" aria-label="Direct link to Lab Setup" title="Direct link to Lab Setup" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#lab-setup">‚Äã</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Cluster Name  |        Type       |         Version          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      mgmt       |   Mgmt Cluster    |      v1.28.9+rke2r1      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| tetragon-test   |  Managed Cluster  |      v1.29.2+k3s1        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  Deployment  |        Version     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Cilium    |       v1.16.1      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Tetragon   |       v1.2.0       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  sveltosctl  |       v0.37.0      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="github-resources">GitHub Resources<a class="hash-link" aria-label="Direct link to GitHub Resources" title="Direct link to GitHub Resources" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#github-resources">‚Äã</a></h2>
<p>The YAML definition files are located <a href="https://github.com/egrosdou01/sveltos-demo-resources/tree/main/day-2-operations/sveltos-cilium-tetragon" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#prerequisites">‚Äã</a></h2>
<p>To follow along, ensure the below are satisfied.</p>
<ol>
<li>A management cluster with Sveltos installed</li>
<li>kubectl installed</li>
<li>sveltosctl installed</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are unaware of installing Sveltos in a Kubernetes cluster, follow the instructions mentioned <a href="https://projectsveltos.github.io/sveltos/getting_started/install/install/" target="_blank" rel="noopener noreferrer">here</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-cluster-registration-withsveltos">Step 1: Cluster Registration with&nbsp;Sveltos<a class="hash-link" aria-label="Direct link to Step 1: Cluster Registration with&nbsp;Sveltos" title="Direct link to Step 1: Cluster Registration with&nbsp;Sveltos" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#step-1-cluster-registration-withsveltos">‚Äã</a></h2>
<p>Once the Kubernetes cluster is ready, we can continue with the Sveltos registration. To do that, we will utilise <code>sveltosctl</code>. The <code>sveltosctl</code> can be downloaded <a href="https://github.com/projectsveltos/sveltosctl/releases" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-registration">Example Registration<a class="hash-link" aria-label="Direct link to Example Registration" title="Direct link to Example Registration" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#example-registration">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sveltosctl register cluster --namespace=test --cluster=tetragon-test \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --kubeconfig=/home/test/tetragon-test.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels=env=test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The cluster above will be registered with Sveltos on the mentioned <strong>namespace</strong>, and <strong>name</strong>, and will attach the cluster labels to perform different deployment versions.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If the namespace does not exist in the management cluster, the command will fail with the namespace not found error. Ensure the defined namespace exists in the cluster before registration.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation">Validation<a class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#validation">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get sveltoscluster -A --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE   NAME          READY   VERSION          LABELS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mgmt        mgmt            true    v1.28.9+rke2r1   projectsveltos.io/k8s-version=v1.28.9,sveltos-agent=present</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test        tetragon-test   true    v1.29.2+k3s1     env=test,projectsveltos.io/k8s-version=v1.29.2,sveltos-agent=present</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Ensure the labels set are correct. We will use them at a later step.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-custom-configmap-cilium-tetragon-deployment">Step 2: Custom ConfigMap, Cilium, Tetragon Deployment<a class="hash-link" aria-label="Direct link to Step 2: Custom ConfigMap, Cilium, Tetragon Deployment" title="Direct link to Step 2: Custom ConfigMap, Cilium, Tetragon Deployment" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#step-2-custom-configmap-cilium-tetragon-deployment">‚Äã</a></h2>
<p>As a first step, we will deploy <strong>Cilium</strong> and <strong>Cilium Tetragon</strong> to the clusters with the label set to <code>env:test</code>. Then, we will deploy a <code>ConfigMap</code> on the <code>management</code> cluster and allow Sveltos to deploy a <code>TracingPolicy</code> alongside a <code>CronJob</code> that polls tracing events every 2 minutes from the targeted <code>managed</code> cluster.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="clusterprofile---cilium-tetragon-and-configmap">ClusterProfile - Cilium, Tetragon, and ConfigMap<a class="hash-link" aria-label="Direct link to ClusterProfile - Cilium, Tetragon, and ConfigMap" title="Direct link to ClusterProfile - Cilium, Tetragon, and ConfigMap" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#clusterprofile---cilium-tetragon-and-configmap">‚Äã</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config.projectsveltos.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterProfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tetragon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">helmCharts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">chartName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium/cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">chartVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.16.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">helmChartAction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryURL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//helm.cilium.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">chartName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium/tetragon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">chartVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">helmChartAction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tetragon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tetragon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryURL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//helm.cilium.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">policyRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tetragon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">policy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">socket</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Sveltos follows the top-down approach when it comes to add-on and application deployment. First, Cilium will get deployed as our CNI. Next, then <strong>Tetragon</strong> and afterwards, we proceed with the deployment of a <code>ConfigMap</code> with the name <code>tetragon-policy-socket-log</code> which has already been deployed in the <code>management</code> cluster.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>A copy of the <code>ConfigMap</code> YAML definition is located <a href="https://github.com/egrosdou01/sveltos-demo-resources/blob/main/day-2-operations/sveltos-cilium-tetragon/env-test/tetragon_configmap.yaml" target="_blank" rel="noopener noreferrer">here</a>.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-configmap-and-clusterprofile---management-cluster">Deploy ConfigMap and ClusterProfile - Management Cluster<a class="hash-link" aria-label="Direct link to Deploy ConfigMap and ClusterProfile - Management Cluster" title="Direct link to Deploy ConfigMap and ClusterProfile - Management Cluster" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#deploy-configmap-and-clusterprofile---management-cluster">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f tetragon_cm.yaml,clusterprofile_tetragon.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation---management-cluster">Validation - Management Cluster<a class="hash-link" aria-label="Direct link to Validation - Management Cluster" title="Direct link to Validation - Management Cluster" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#validation---management-cluster">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./sveltosctl show addons                                         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+----------------------------------------------+-------------+-------------------------------+---------+--------------------------------+-------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      CLUSTER       |                RESOURCE TYPE                 |  NAMESPACE  |             NAME              | VERSION |              TIME              |              PROFILES               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+----------------------------------------------+-------------+-------------------------------+---------+--------------------------------+-------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| test/tetragon-test | helm chart                                   | kube-system | cilium                        | 1.16.1  | 2024-10-06 09:28:12 +0200 CEST | ClusterProfile/tetragon-test-deploy |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| test/tetragon-test | helm chart                                   | kube-system | tetragon                      | 1.2.0   | 2024-10-06 09:28:15 +0200 CEST | ClusterProfile/tetragon-test-deploy |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| test/tetragon-test | rbac.authorization.k8s.io:ClusterRoleBinding |             | tetragon-cluster-role-binding | N/A     | 2024-10-06 09:28:12 +0200 CEST | ClusterProfile/tetragon-test-deploy |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| test/tetragon-test | batch:CronJob                                | default     | tetragon-log-fetcher          | N/A     | 2024-10-06 09:28:12 +0200 CEST | ClusterProfile/tetragon-test-deploy |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| test/tetragon-test | cilium.io:TracingPolicy                      |             | networking                    | N/A     | 2024-10-06 09:28:12 +0200 CEST | ClusterProfile/tetragon-test-deploy |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| test/tetragon-test | :ServiceAccount                              | default     | tetragon-sa                   | N/A     | 2024-10-06 09:28:12 +0200 CEST | ClusterProfile/tetragon-test-deploy |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| test/tetragon-test | rbac.authorization.k8s.io:ClusterRole        |             | tetragon-cluster-role         | N/A     | 2024-10-06 09:28:12 +0200 CEST | ClusterProfile/tetragon-test-deploy |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+----------------------------------------------+-------------+-------------------------------+---------+--------------------------------+-------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation---managed-cluster">Validation - Managed Cluster<a class="hash-link" aria-label="Direct link to Validation - Managed Cluster" title="Direct link to Validation - Managed Cluster" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#validation---managed-cluster">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n kube-system | grep -E "cilium|tetragon"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-8547744bd7-qhl7r     1/1     Running   0          4m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-8547744bd7-m26lh     1/1     Running   0          4m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tetragon-mln8g                       2/2     Running   0          4m29s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tetragon-c7gwj                       2/2     Running   0          4m29s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tetragon-tjx54                       2/2     Running   0          4m29s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-g7ftd                         1/1     Running   0          4m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-pv9gj                         1/1     Running   0          4m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-9cr4l                         1/1     Running   0          4m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-envoy-9kjnv                   1/1     Running   0          4m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-envoy-fpqkl                   1/1     Running   0          4m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-envoy-25gvv                   1/1     Running   0          4m30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tetragon-operator-55c555fcf4-s5mvs   1/1     Running   0          4m29s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cronjobs,jobs,pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                 SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cronjob.batch/tetragon-log-fetcher   */2 * * * *   False     0        98s             5m26s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                      COMPLETIONS   DURATION   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">job.batch/install-traefik2-nodeport-te    1/1           11s        47h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">job.batch/tetragon-log-fetcher-28803330   1/1           10s        3m38s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">job.batch/tetragon-log-fetcher-28803332   1/1           9s         98s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                      READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/install-traefik2-nodeport-te-zrh57    0/1     Completed   0          47h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/tetragon-log-fetcher-28803330-wpl9r   0/1     Completed   0          3m38s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/tetragon-log-fetcher-28803332-r7q5v   0/1     Completed   0          98s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Based on the output above, we have deployed <strong>Cilium</strong>, <strong>Tetragon</strong> and a <strong>CronJob</strong> to collect Tetragon logs based on a tracing policy every 2 minutes with a timeout of 5 sec. üéâ We can proceed further and use the Sveltos <code>ClucterHealthCheck</code> and <code>HealthCheck</code> to collect the data of the newly created <code>ConfiMap</code> in the managed cluster.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If the defined <code>ConfigMap</code> or <code>CronJob</code> does not fit your needs, feel free to update the YAML definitions based on your liking.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-deploy-clusterhealthcheck-and-healthcheck">Step 3: Deploy ClusterHealthCheck and HealthCheck<a class="hash-link" aria-label="Direct link to Step 3: Deploy ClusterHealthCheck and HealthCheck" title="Direct link to Step 3: Deploy ClusterHealthCheck and HealthCheck" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#step-3-deploy-clusterhealthcheck-and-healthcheck">‚Äã</a></h2>
<p>To be able to collect resources from the Sveltos managed cluster, we will use a new YAML definition to collect the data from the <code>ConfigMap</code> with the name <code>tetragon-logs</code>.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The <code>ConfigMap tetragon-logs</code> is <strong>created</strong> and <strong>patched</strong> with a periodic execution of <code>Jobs</code> mentioned in Step 2.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="healthcheck-and-clusterhealthcheck-defintion">HealthCheck and ClusterHealthCheck Defintion<a class="hash-link" aria-label="Direct link to HealthCheck and ClusterHealthCheck Defintion" title="Direct link to HealthCheck and ClusterHealthCheck Defintion" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#healthcheck-and-clusterhealthcheck-defintion">‚Äã</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Collect the resource of the ConfigMap with the name `tetragon-logs`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lib.projectsveltos.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HealthCheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tetragon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">fetcher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">collectResources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resourceSelectors</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">group</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"v1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ConfigMap"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tetragon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">evaluateHealth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    function evaluate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      local statuses = {}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for _</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">resource in ipairs(resources) do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        status = "Degraded"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        table.insert(statuses</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">resource=resource</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> status = status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message = resource.data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"tetragon-logs.txt"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      local hs = </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if </span><span class="token comment" style="color:#999988;font-style:italic">#statuses &gt; 0 then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hs.resources = statuses </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Get the ConfigMap data and send it to the management cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lib.projectsveltos.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterHealthCheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tetragon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">fetcher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">livenessChecks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tetragon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">fetcher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HealthCheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">livenessSourceRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HealthCheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lib.projectsveltos.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tetragon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">fetcher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">notifications</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KubernetesEvent</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-healthcheck-and-clusterhealthcheck---management-cluster">Deploy HealthCheck and ClusterHealthCheck - Management Cluster<a class="hash-link" aria-label="Direct link to Deploy HealthCheck and ClusterHealthCheck - Management Cluster" title="Direct link to Deploy HealthCheck and ClusterHealthCheck - Management Cluster" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#deploy-healthcheck-and-clusterhealthcheck---management-cluster">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f tetragon_healthcheck_logs.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation---management-cluster-1">Validation - Management Cluster<a class="hash-link" aria-label="Direct link to Validation - Management Cluster" title="Direct link to Validation - Management Cluster" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#validation---management-cluster-1">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./sveltosctl show resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+---------------------+-----------+---------------+--------------------------------------------------------------------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      CLUSTER       |         GVK         | NAMESPACE |     NAME      |                                                   MESSAGE                                                    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+---------------------+-----------+---------------+--------------------------------------------------------------------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| test/tetragon-test | /v1, Kind=ConfigMap | default   | tetragon-logs | üîå connect kube-system/coredns-6799fbcd5-4bv5r /coredns tcp 127.0.0.1:35846 -&gt;                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                    |                     |           |               | 127.0.0.1:8080 üßπ close   kube-system/coredns-6799fbcd5-4bv5r /coredns tcp 127.0.0.1:35846                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                    |                     |           |               | -&gt; 127.0.0.1:8080 üßπ close   kube-system/coredns-6799fbcd5-4bv5r /coredns tcp 127.0.0.1:8080                 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                    |                     |           |               | -&gt; 127.0.0.1:35846 üîå connect kube-system/coredns-6799fbcd5-4bv5r /coredns tcp                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                    |                     |           |               | 127.0.0.1:35852 -&gt; 127.0.0.1:8080 üßπ close   kube-system/coredns-6799fbcd5-4bv5r /coredns tcp                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                    |                     |           |               | 127.0.0.1:35852 -&gt; 127.0.0.1:8080 üßπ close   kube-system/coredns-6799fbcd5-4bv5r /coredns tcp                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                    |                     |           |               | 127.0.0.1:8080 -&gt; 127.0.0.1:35852 üîå connect k3s-tetragon-9ab2-92fa7d-node-pool-df07-7inhp                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                    |                     |           |               | /var/lib/rancher/k3s/data/7d0aa19ffc230d4322f04d1ae8783e54ce189dfc4cbfa0a6afcdcabec2346d0c/bin/k3s           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+---------------------+-----------+---------------+--------------------------------------------------------------------------------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From the output above, we see the logs collected from the Tetragon TracingPolicy coming from a <code>managed</code> cluster and making them available in a <code>management</code> cluster! Cool, right? The same approach can be used with different data located in the <code>managed</code> clusters. A post written by Gianluca outlining the collection of <code>kube-bench</code> scanning results can be found <a href="https://itnext.io/ensurincis-benchmark-compliance-across-multiple-kubernetes-clusters-dd544682e786" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sveltos-for-day-2-operations-benefits">Sveltos for Day-2 Operations Benefits<a class="hash-link" aria-label="Direct link to Sveltos for Day-2 Operations Benefits" title="Direct link to Sveltos for Day-2 Operations Benefits" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#sveltos-for-day-2-operations-benefits">‚Äã</a></h2>
<p>Sveltos allows users to deploy the required add-on and deployments to a fleet of clusters while allowing platform administrators and operators to <strong>enhance</strong> the <strong>security posture</strong> and <strong>observability</strong> of the clusters in a simple and meaningful way. Use the Sveltos <code>Event Framework</code>, <code>Tiers</code>, <code>ClusterHealthCheck</code>, and <code>HealthCheck</code> features to enhance the posture of different platforms!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#conclusions">‚Äã</a></h2>
<p>In a few minutes ‚è≥, with minimal configuration effort and following the GitOps approach, we deployed Cilium as our CNI, Cilium Tetragon for observability alongside polling and displaying of critical tracing results to the management cluster painlessly! üéâ</p>
<p>In the next blog posts, we will touch on topics around Day-2 operations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#resources">‚Äã</a></h2>
<ul>
<li><strong>Cilium Labs</strong>: <a href="https://isovalent.com/resource-library/labs/" target="_blank" rel="noopener noreferrer">https://isovalent.com/resource-library/labs/</a></li>
<li><strong>Tetragon - Getting Started Lab</strong>: <a href="https://isovalent.com/labs/tetragon-getting-started/" target="_blank" rel="noopener noreferrer">https://isovalent.com/labs/tetragon-getting-started/</a></li>
<li><strong>Sveltos ClusterHealthCheck/HealthCheck</strong>: <a href="https://projectsveltos.github.io/sveltos/observability/notifications/#example-configmap-healthcheck" target="_blank" rel="noopener noreferrer">https://projectsveltos.github.io/sveltos/observability/notifications/#example-configmap-healthcheck</a></li>
<li><strong>Sveltos Event Framework</strong>: <a href="https://projectsveltos.github.io/sveltos/events/addon_event_deployment/" target="_blank" rel="noopener noreferrer">https://projectsveltos.github.io/sveltos/events/addon_event_deployment/</a></li>
<li><strong>Sveltos Tiers</strong>: <a href="https://projectsveltos.github.io/sveltos/deployment_order/tiers/" target="_blank" rel="noopener noreferrer">https://projectsveltos.github.io/sveltos/deployment_order/tiers/</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-contact">‚úâÔ∏è Contact<a class="hash-link" aria-label="Direct link to ‚úâÔ∏è Contact" title="Direct link to ‚úâÔ∏è Contact" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#%EF%B8%8F-contact">‚Äã</a></h2>
<p>We are here to help! Whether you have questions, or issues or need assistance, our Slack channel is the perfect place for you. Click here to <a href="https://app.slack.com/client/T0471SNT5CZ/C06UZCXQLGP" target="_blank" rel="noopener noreferrer">join us</a> us.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-support-thisproject">üëè Support this&nbsp;project<a class="hash-link" aria-label="Direct link to üëè Support this&nbsp;project" title="Direct link to üëè Support this&nbsp;project" href="https://github.com/personal-blog/blog/sveltos-cilium-tetragon-day2-operations#-support-thisproject">‚Äã</a></h2>
<p>Every contribution counts! If you enjoyed this article, check out the Projectsveltos <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">GitHub repo</a>. You can <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">star üåü the project</a> if you find it helpful.</p>
<p>The GitHub repo is a great resource for getting started with the project. It contains the code, documentation, and many more examples.</p>
<p>Thanks for reading!</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="Sveltos" term="Sveltos"/>
        <category label="Cilium" term="Cilium"/>
        <category label="Tetragon" term="Tetragon"/>
        <category label="Open Source" term="Open Source"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="GitOps" term="GitOps"/>
        <category label="DevOps" term="DevOps"/>
        <category label="2024" term="2024"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Sveltos Tiers: Efficient Day-2 Operations and Targeted Updates]]></title>
        <id>https://github.com/personal-blog/blog/sveltos-introduction-to-tiers</id>
        <link href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers"/>
        <updated>2024-09-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#introduction">‚Äã</a></h2>
<p>In previous posts, we outlined how <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">Sveltos</a> allows Platform and tenant administrators to streamline Kubernetes applications and add-on deployments to a fleet of clusters. In today's blog post, we will take a step further and demonstrate how easy it is to <strong>target</strong> and <strong>update</strong> a <strong>subset</strong> of resources targeted by <strong>multiple configurations</strong>. By multiple configurations, we refer to the <a href="https://projectsveltos.github.io/sveltos/addons/addons/" target="_blank" rel="noopener noreferrer">Sveltos ClusterProfile or Profile</a> Custom Resource Definitions (CRDs). The demonstration focuses on <strong>day-2 operations</strong> as we provide a way to <strong>update and/or remove</strong> resources without affecting <strong>production</strong> operations.</p>
<p>This functionality is called <a href="https://projectsveltos.github.io/sveltos/deployment_order/tiers/" target="_blank" rel="noopener noreferrer">tiers</a>. Sveltos tiers provide a solution for managing the <strong>deployment priority</strong> when resources are targeted by multiple configurations. Tiers are easily integrated into existing ClusterProfile/Profile definitions alongside defining the deployment order control and straightforwardly override behaviour.</p>
<p>Today, we will cover the case of updating the <a href="https://docs.cilium.io/en/latest/" target="_blank" rel="noopener noreferrer">Cilium CNI</a> in a subnet of clusters with the label set to <code>tier:zone2</code> without affecting the monitoring capabilities defined in the <strong>same</strong> ClusterProfile/Profile.</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;Sveltos Tiers&amp;quot;" src="https://github.com/personal-blog/assets/images/sveltos_tiers-efa847a5dfb7374928808c707a7e3292.jpg" width="4614" height="3467" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-setup">Lab Setup<a class="hash-link" aria-label="Direct link to Lab Setup" title="Direct link to Lab Setup" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#lab-setup">‚Äã</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Cluster Name  |        Type       |         Version          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   mgmt          | Mgmt Cluster      |      v1.28.9+rke2r1      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  prod-zone01    | Managed Cluster   |      v1.29.2+k3s1        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  prod-zone02    | Managed Cluster   |      v1.29.2+k3s1        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Deployment  | Version             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Cilium      | v1.15.6, v1.16.1    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sveltosctl  | v0.37.0             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#prerequisites">‚Äã</a></h2>
<p>To follow along, ensure the below are satisfied.</p>
<ol>
<li>A management cluster with Sveltos installed</li>
<li>kubectl installed</li>
<li>sveltosctl installed</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are unaware of installing Sveltos in a Kubernetes cluster, follow the instructions mentioned <a href="https://projectsveltos.github.io/sveltos/getting_started/install/install/" target="_blank" rel="noopener noreferrer">here</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-register-clusters-withsveltos">Step 1: Register Clusters with&nbsp;Sveltos<a class="hash-link" aria-label="Direct link to Step 1: Register Clusters with&nbsp;Sveltos" title="Direct link to Step 1: Register Clusters with&nbsp;Sveltos" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#step-1-register-clusters-withsveltos">‚Äã</a></h2>
<p>For this demo, two <a href="https://www.civo.com/kubernetes" target="_blank" rel="noopener noreferrer">Civo Kubernetes</a> clusters are used. Once the clusters are ready, we can proceed with the Sveltos cluster registration. To do that, we will utilise <code>sveltosctl</code>. The <code>sveltosctl</code> can be downloaded <a href="https://github.com/projectsveltos/sveltosctl/releases" target="_blank" rel="noopener noreferrer">here</a>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sveltosctl register cluster --namespace=&lt;namespace&gt; --cluster=&lt;cluster name&gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig=&lt;path to Sveltos file with Kubeconfig&gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--labels=key1=value1,key2=value2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-registration">Example Registration<a class="hash-link" aria-label="Direct link to Example Registration" title="Direct link to Example Registration" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#example-registration">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sveltosctl register cluster --namespace=civo --cluster=mesh01 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --kubeconfig=/home/test/prod-zone01.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels=env=prod,tier=zone01</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We will register the clusters with Sveltos on the mentioned <strong>namespace</strong>, and <strong>name</strong>, and will attach the cluster labels to perform different deployment versions.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If the namespace does not exist in the management cluster, the command will fail with the namespace not found error. Ensure the defined namespace exists in the cluster before registration.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation">Validation<a class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#validation">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get sveltoscluster -A --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE   NAME          READY   VERSION          LABELS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mgmt        mgmt          true    v1.28.9+rke2r1   projectsveltos.io/k8s-version=v1.28.9,sveltos-agent=present</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prod        prod-zone01   true    v1.28.7+k3s1     env=prod,projectsveltos.io/k8s-version=v1.28.7,sveltos-agent=present,tier=zone01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prod        prod-zone02   true    v1.28.7+k3s1     env=prod,projectsveltos.io/k8s-version=v1.28.7,sveltos-agent=present,tier=zone02</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Ensure the labels set to the managed clusters are correct. We will use them at a later step.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-deploy-cilium-and-monitoring-capabilities">Step 2: Deploy Cilium and Monitoring Capabilities<a class="hash-link" aria-label="Direct link to Step 2: Deploy Cilium and Monitoring Capabilities" title="Direct link to Step 2: Deploy Cilium and Monitoring Capabilities" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#step-2-deploy-cilium-and-monitoring-capabilities">‚Äã</a></h2>
<p>As platform administrators, for every managed cluster, we want to have Cilium as our CNI and monitoring capabilities with Grafana, Prometheus and Loki. For that, we will use the Sveltos ClusterProfile Kubernetes resource and deploy the required deployments in clusters with the label set to <code>env:prod</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="clusterprofile---cilium-grafana-prometheus">ClusterProfile - Cilium, Grafana, Prometheus<a class="hash-link" aria-label="Direct link to ClusterProfile - Cilium, Grafana, Prometheus" title="Direct link to ClusterProfile - Cilium, Grafana, Prometheus" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#clusterprofile---cilium-grafana-prometheus">‚Äã</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config.projectsveltos.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterProfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prod</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">initial</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">setup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">continueOnConflict</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">helmCharts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">chartName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium/cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">chartVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.15.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">helmChartAction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryURL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//helm.cilium.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">chartName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">community/kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">chartVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v60.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">helmChartAction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">community</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">community</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryURL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">community.github.io/helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      grafana:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          type: LoadBalancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      prometheus-node-exporter:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          port: 9200</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          targetPort: 9200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">validateHealths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> deployment</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">health</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">featureID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">group</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"apps"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"v1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Deployment"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">script</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      function evaluate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        local hs = {healthy = false, message = "Available replicas not match requested replicas"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        if obj.status and obj.status.availableReplicas ~= nil and obj.status.availableReplicas == obj.spec.replicas then</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          hs.healthy = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        return hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We instruct Sveltos firstly to install Cilium as our CNI. Next, we deploy the <strong>Grafana</strong> and <strong>Prometheus</strong> stack and ensure the second deployment is in a <code>healthy</code> state using the <code>validateHealths</code>. Afterwards, we proceed with the Loki integration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="clusterprofile---loki">ClusterProfile - Loki<a class="hash-link" aria-label="Direct link to ClusterProfile - Loki" title="Direct link to ClusterProfile - Loki" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#clusterprofile---loki">‚Äã</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config.projectsveltos.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterProfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> loki</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">2102</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">dependsOn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prod</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">initial</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">setup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">continueOnConflict</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">helmCharts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">repositoryURL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//grafana.github.io/helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">chartName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana/loki</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">chartVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v2.10.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> loki</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">helmChartAction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Ensure the <code>dependsOn</code> contains the correct name definition. In our example, it is<code>cluster-prod-initial-setup</code>.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-clusterprofiles---management-cluster">Deploy ClusterProfiles - Management Cluster<a class="hash-link" aria-label="Direct link to Deploy ClusterProfiles - Management Cluster" title="Direct link to Deploy ClusterProfiles - Management Cluster" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#deploy-clusterprofiles---management-cluster">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f clusterprofile_prod_setup.yaml,clusterprofile_loki.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation---management-cluster">Validation - Management Cluster<a class="hash-link" aria-label="Direct link to Validation - Management Cluster" title="Direct link to Validation - Management Cluster" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#validation---management-cluster">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./sveltosctl show addons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------------+-------------+----------------------+---------+--------------------------------+-------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|     CLUSTER      | RESOURCE TYPE |  NAMESPACE  |         NAME         | VERSION |              TIME              |                 PROFILES                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------------+-------------+----------------------+---------+--------------------------------+-------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| prod/prod-zone01 | helm chart    | kube-system | cilium               | 1.15.6  | 2024-09-23 12:18:37 +0200 CEST | ClusterProfile/cluster-prod-initial-setup |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| prod/prod-zone01 | helm chart    | monitoring  | prometheus-community | 60.2.0  | 2024-09-23 12:18:47 +0200 CEST | ClusterProfile/cluster-prod-initial-setup |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| prod/prod-zone01 | helm chart    | loki-stack  | loki                 | 2.10.2  | 2024-09-23 12:20:38 +0200 CEST | ClusterProfile/loki-2102-prod             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| prod/prod-zone02 | helm chart    | kube-system | cilium               | 1.15.6  | 2024-09-23 12:18:47 +0200 CEST | ClusterProfile/cluster-prod-initial-setup |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| prod/prod-zone02 | helm chart    | monitoring  | prometheus-community | 60.2.0  | 2024-09-23 12:18:56 +0200 CEST | ClusterProfile/cluster-prod-initial-setup |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| prod/prod-zone02 | helm chart    | loki-stack  | loki                 | 2.10.2  | 2024-09-23 12:20:47 +0200 CEST | ClusterProfile/loki-2102-prod             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------------+-------------+----------------------+---------+--------------------------------+-------------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation---managed-cluster">Validation - Managed Cluster<a class="hash-link" aria-label="Direct link to Validation - Managed Cluster" title="Direct link to Validation - Managed Cluster" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#validation---managed-cluster">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n kube-system | grep -i cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-579c6c96c4-47wsk   1/1     Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-579c6c96c4-djk8s   1/1     Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-mwk7x                       1/1     Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-x5z5v                       1/1     Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ds/cilium -n kube-system -o jsonpath='{.spec.template.spec.containers[0].image}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quay.io/cilium/cilium:v1.15.6@sha256:6aa840986a3a9722cd967ef63248d675a87add7e1704740902d5d3162f0c0def</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n monitoring </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                       READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-community-prometheus-node-exporter-78llc        1/1     Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-community-prometheus-node-exporter-xhcf9        1/1     Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-community-kube-operator-5746cfbb9-4p45x         1/1     Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-community-kube-state-metrics-7fc779fc58-z4ktb   1/1     Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager-prometheus-community-kube-alertmanager-0      2/2     Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-community-kube-prometheus-0          2/2     Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-community-grafana-7494f9df89-pjqdd              3/3     Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n loki-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                  READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loki-promtail-ttdgx   1/1     Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loki-promtail-jq5td   1/1     Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loki-0                1/1     Running   0          10m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We installed Cilium, Grafana, Prometheus and Loki in our production clusters. Awesome! üéâ Now, we will continue with the <strong>update</strong> of <strong>Cilium</strong> on a subnet of clusters only.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-update-cilium-tier-cluster">Step 3: Update Cilium tier<!-- -->:zone02<!-- --> Cluster<a class="hash-link" aria-label="Direct link to step-3-update-cilium-tier-cluster" title="Direct link to step-3-update-cilium-tier-cluster" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#step-3-update-cilium-tier-cluster">‚Äã</a></h2>
<p>As mentioned, we would like to use the Sveltos <code>tier</code> feature to update <code>Cilium</code> only on the clusters with the label set to <code>tier:zone02</code>. The matching cluster in our example will be the <code>prod-zone01</code> cluster.</p>
<p><strong>Issue</strong>: Because we have a ClusterProfile that installed Cilium to the cluster <code>prod-zone01</code>, how can we instruct Sveltos to update this cluster and only the Cilium deployment?</p>
<p>To achieve this, we will create a new ClusterProfile with the user of <code>tier</code>. We will instruct Sveltos to take the new ClusterProfile with a lower <code>tier</code> value set and update Cilium CNI only on the matching clusters.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The default <code>tier</code> value for every ClusterProfile/Profile is set to 100. If you set this to a lower value, Sveltos will take the lower value as a higher priority deployment.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="clusterprofile---update-cilium">ClusterProfile - Update Cilium<a class="hash-link" aria-label="Direct link to ClusterProfile - Update Cilium" title="Direct link to ClusterProfile - Update Cilium" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#clusterprofile---update-cilium">‚Äã</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config.projectsveltos.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterProfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1161</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">tier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zone02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">continueOnConflict</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">helmCharts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">chartName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium/cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">chartVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.16.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">helmChartAction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryURL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//helm.cilium.io/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation---management-cluster-1">Validation - Management Cluster<a class="hash-link" aria-label="Direct link to Validation - Management Cluster" title="Direct link to Validation - Management Cluster" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#validation---management-cluster-1">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./sveltosctl show addons --cluster=prod-zone02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------------+-------------+----------------------+---------+--------------------------------+-------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|     CLUSTER      | RESOURCE TYPE |  NAMESPACE  |         NAME         | VERSION |              TIME              |                 PROFILES                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------------+-------------+----------------------+---------+--------------------------------+-------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| prod/prod-zone02 | helm chart    | monitoring  | prometheus-community | 60.2.0  | 2024-09-23 12:18:56 +0200 CEST | ClusterProfile/cluster-prod-initial-setup |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| prod/prod-zone02 | helm chart    | loki-stack  | loki                 | 2.10.2  | 2024-09-23 12:20:47 +0200 CEST | ClusterProfile/loki-2102-prod             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| prod/prod-zone02 | helm chart    | kube-system | cilium               | 1.16.1  | 2024-09-23 12:32:27 +0200 CEST | ClusterProfile/cilium-1161                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------------+-------------+----------------------+---------+--------------------------------+-------------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation---managed-cluster-1">Validation - Managed Cluster<a class="hash-link" aria-label="Direct link to Validation - Managed Cluster" title="Direct link to Validation - Managed Cluster" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#validation---managed-cluster-1">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n kube-system | grep -i cilium                                                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-66dcfc4678-76j6m   1/1     Running   0          2m44s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-66dcfc4678-6wvbr   1/1     Running   0          2m44s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-xnt7k                       1/1     Running   0          2m44s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-envoy-rj8pj                 1/1     Running   0          2m45s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-8fbzc                       1/1     Running   0          2m44s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-envoy-hkhmc                 1/1     Running   0          2m45s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ds/cilium -n kube-system -o jsonpath='{.spec.template.spec.containers[0].image}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quay.io/cilium/cilium:v1.16.1@sha256:0b4a3ab41a4760d86b7fc945b8783747ba27f29dac30dd434d94f2c9e3679f39</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sveltos-tiers-benefits">Sveltos Tiers Benefits<a class="hash-link" aria-label="Direct link to Sveltos Tiers Benefits" title="Direct link to Sveltos Tiers Benefits" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#sveltos-tiers-benefits">‚Äã</a></h2>
<p>Sveltos tiers allow seamless <strong>targeting</strong> üéØ and <strong>updating</strong> üîÑ of different Kubernetes applications and add-ons in a subset of clusters. Now, we have a way to perform updates without headaches üòå and be confident and full of control üõ†Ô∏è using the GitOps approach.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#conclusions">‚Äã</a></h2>
<p>In a few minutes ‚è≥, with minimal configuration effort and following the GitOps approach, we updated Cilium CNI in a subset of clusters painless! üéâ Find more about the Sveltos tiers <a href="https://projectsveltos.github.io/sveltos/deployment_order/tiers/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-contact">‚úâÔ∏è Contact<a class="hash-link" aria-label="Direct link to ‚úâÔ∏è Contact" title="Direct link to ‚úâÔ∏è Contact" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#%EF%B8%8F-contact">‚Äã</a></h2>
<p>We are here to help! Whether you have questions, or issues or need assistance, our Slack channel is the perfect place for you. Click here to <a href="https://app.slack.com/client/T0471SNT5CZ/C06UZCXQLGP" target="_blank" rel="noopener noreferrer">join us</a> us.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-support-thisproject">üëè Support this&nbsp;project<a class="hash-link" aria-label="Direct link to üëè Support this&nbsp;project" title="Direct link to üëè Support this&nbsp;project" href="https://github.com/personal-blog/blog/sveltos-introduction-to-tiers#-support-thisproject">‚Äã</a></h2>
<p>Every contribution counts! If you enjoyed this article, check out the Projectsveltos <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">GitHub repo</a>. You can <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">star üåü the project</a> if you find it helpful.</p>
<p>The GitHub repo is a great resource for getting started with the project. It contains the code, documentation, and many more examples.</p>
<p>Thanks for reading!</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="Sveltos" term="Sveltos"/>
        <category label="Open Source" term="Open Source"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="GitOps" term="GitOps"/>
        <category label="DevOps" term="DevOps"/>
        <category label="2024" term="2024"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[OSSummit Europe 2024]]></title>
        <id>https://github.com/personal-blog/blog/ossummit-europe-2024</id>
        <link href="https://github.com/personal-blog/blog/ossummit-europe-2024"/>
        <updated>2024-09-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="https://github.com/personal-blog/blog/ossummit-europe-2024#introduction">‚Äã</a></h2>
<p><a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">Sveltos</a> is on tour! Another non-technical post describing my experience at the <a href="https://events.linuxfoundation.org/open-source-summit-europe/" target="_blank" rel="noopener noreferrer">OSSummit Europe 2024</a>. Apart from outlining my experience, the post will include useful resources on open-source projects I learned during the event.</p>
<p>About Sveltos, <a href="https://www.linkedin.com/in/gianlucamardente/" target="_blank" rel="noopener noreferrer">Gianluca Mardente</a> and I had the chance to talk at the conference and present Sveltos and how it is used to deploy and manage different Kubernetes applications and add-ons in a Multi-Cloud setup.</p>
<p>In the sections below, I will outline my highlights of the conference and what I have learned, while later on, I will describe what we presented about Sveltos and where to locate the required resources.</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;OSSummit Europe 2024&amp;quot;" src="https://github.com/personal-blog/assets/images/ossummit_europe_2024-5828d97c7f2a8e3fedfebce0ef784b9b.jpg" width="2986" height="3258" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ossummit---day-1">OSSummit - Day 1<a class="hash-link" aria-label="Direct link to OSSummit - Day 1" title="Direct link to OSSummit - Day 1" href="https://github.com/personal-blog/blog/ossummit-europe-2024#ossummit---day-1">‚Äã</a></h2>
<p>As with any other conference, the day began with the registration, badge pick-up and familiarisation with the location. Of course, coffee was widely available in almost every corner of the conference!</p>
<p><img decoding="async" loading="lazy" src="https://1075koolfm.com/cobPub/uploads/2024/07/giphy.gif" alt="title image reading &quot;Coffee Dance&quot;" class="img_ev3q"></p>
<p>For a quick look at the Day 1 keynotes, find below my highlights alongside the resources for further reading.</p>
<ul>
<li><a href="https://www.linuxfoundation.org/press/linux-foundation-and-cncf-expand-partnership-with-unified-patents-to-defend-open-source-software-from-non-practicing-entities" target="_blank" rel="noopener noreferrer">Linux Foundation, CNCF, Unified Patents - partnership expansion</a></li>
<li><a href="https://www.prnewswire.com/news-releases/announcing-valkey-8-0--302248447.html" target="_blank" rel="noopener noreferrer">Linux Foundation, Valkey 8.0</a></li>
<li><a href="https://github.com/DevRel-Foundation" target="_blank" rel="noopener noreferrer">Developer Relations Foundation Announcement</a></li>
<li><a href="https://lfaidata.foundation/" target="_blank" rel="noopener noreferrer">Open Source Innovation in Artificial Intelligence and Data</a></li>
<li><a href="https://linuxfoundation.eu/" target="_blank" rel="noopener noreferrer">The Linux Foundation Europe</a></li>
</ul>
<p>From a technical side, there was an announcement about the formation of the <a href="https://www.linuxfoundation.org/press/linux-foundation-announces-opensearch-software-foundation-to-foster-open-collaboration-in-search-and-analytics" target="_blank" rel="noopener noreferrer">OpenSearch Software Foundation</a>. AWS decided to move OpenSearch to the Linux Foundation. OpenSearch is a community-driven, Apache 2.0-licensed open-source search and analytics suite that makes it easy to ingest, search, visualise, and analyse data.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="opensearch---resources">OpenSearch - Resources<a class="hash-link" aria-label="Direct link to OpenSearch - Resources" title="Direct link to OpenSearch - Resources" href="https://github.com/personal-blog/blog/ossummit-europe-2024#opensearch---resources">‚Äã</a></h3>
<ul>
<li><a href="https://github.com/opensearch-project" target="_blank" rel="noopener noreferrer">GitHub</a></li>
<li><a href="https://playground.opensearch.org/app/home" target="_blank" rel="noopener noreferrer">OpenSearch Playground</a></li>
</ul>
<p>Apart from that, I was introduced to <a href="https://cdk8s.io/" target="_blank" rel="noopener noreferrer">cdk8s</a> which is an open-source software development framework for defining Kubernetes applications. It synthesises applications into standard Kubernetes manifests files and supports a wide range of available programming languages like Typescript, Javascript, Go, Python, and Java.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cdk8s---resources">cdk8s - Resources<a class="hash-link" aria-label="Direct link to cdk8s - Resources" title="Direct link to cdk8s - Resources" href="https://github.com/personal-blog/blog/ossummit-europe-2024#cdk8s---resources">‚Äã</a></h3>
<ul>
<li><a href="https://github.com/cdk8s-team/cdk8s" target="_blank" rel="noopener noreferrer">GitHub</a></li>
<li><a href="https://cdk8s.io/docs/latest/" target="_blank" rel="noopener noreferrer">cdk8s Documentation</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ossummit---day-2">OSSummit - Day 2<a class="hash-link" aria-label="Direct link to OSSummit - Day 2" title="Direct link to OSSummit - Day 2" href="https://github.com/personal-blog/blog/ossummit-europe-2024#ossummit---day-2">‚Äã</a></h2>
<p>Why not start the day with a 5k run? Around 20ish people gathered together and enjoyed a morning run near the Danube River! The Day 2 keynotes involved topics around secure supply chain consumption with existing frameworks, how to be compliant in a cloud-native landscape and ways to perform Policy as Code.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="frameworks">Frameworks<a class="hash-link" aria-label="Direct link to Frameworks" title="Direct link to Frameworks" href="https://github.com/personal-blog/blog/ossummit-europe-2024#frameworks">‚Äã</a></h3>
<ul>
<li><a href="https://github.com/ossf/s2c2f" target="_blank" rel="noopener noreferrer">Secure Supply Chain Consumption Framework (S2C2F)</a></li>
<li><a href="https://slsa.dev/" target="_blank" rel="noopener noreferrer">SLSA</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="container-image-patch-tools">Container Image Patch Tools<a class="hash-link" aria-label="Direct link to Container Image Patch Tools" title="Direct link to Container Image Patch Tools" href="https://github.com/personal-blog/blog/ossummit-europe-2024#container-image-patch-tools">‚Äã</a></h3>
<ul>
<li><a href="https://github.com/project-copacetic/copacetic" target="_blank" rel="noopener noreferrer">COPA</a></li>
</ul>
<p>COPA is an open-source tool written in Go that allows DevSecOps engineers to directly patch container images given vulnerability scanning results from popular tools like <a href="https://trivy.dev/" target="_blank" rel="noopener noreferrer">Trivy</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="supply-chain-control-plane">Supply Chain Control Plane<a class="hash-link" aria-label="Direct link to Supply Chain Control Plane" title="Direct link to Supply Chain Control Plane" href="https://github.com/personal-blog/blog/ossummit-europe-2024#supply-chain-control-plane">‚Äã</a></h3>
<ul>
<li><a href="https://github.com/chainloop-dev/chainloop" target="_blank" rel="noopener noreferrer">Chainloop</a></li>
</ul>
<p>Chainloop is an open-source project I found out while crowling at the booth. Chainloop provides a single source of truth for <strong>metadata</strong> and <strong>artifacts</strong>, plus a declarative attestation process. We can declaratively state the pieces of evidence and artifact expectations for different CI/CD pipelines.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="iot">IoT<a class="hash-link" aria-label="Direct link to IoT" title="Direct link to IoT" href="https://github.com/personal-blog/blog/ossummit-europe-2024#iot">‚Äã</a></h3>
<p>If you are interested in IoT, I had the chance to learn more about <a href="https://github.com/zephyrproject-rtos/zephyr/tree/main" target="_blank" rel="noopener noreferrer">Zephyr</a> while attending interactive sessions about IoT development.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="open-source-and-research">Open-source and Research<a class="hash-link" aria-label="Direct link to Open-source and Research" title="Direct link to Open-source and Research" href="https://github.com/personal-blog/blog/ossummit-europe-2024#open-source-and-research">‚Äã</a></h3>
<p>If you have an interest in open-source Research and Enablement check out <a href="https://todogroup.org/" target="_blank" rel="noopener noreferrer">TODO</a> and <a href="https://lero.ie/" target="_blank" rel="noopener noreferrer">LERO/CURIOOS</a> initialives alongside the <a href="https://opensource.net/" target="_blank" rel="noopener noreferrer">opensource.net</a> website for relevant topics.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ossummit---day-3">OSSummit - Day 3<a class="hash-link" aria-label="Direct link to OSSummit - Day 3" title="Direct link to OSSummit - Day 3" href="https://github.com/personal-blog/blog/ossummit-europe-2024#ossummit---day-3">‚Äã</a></h2>
<p>Day 3 started with a group talk on Kernel development and what development looks like with Rust. I found interesting the talk from Paolo De Rosa who talked about the European Digital Identity (EUDI) Wallet and the fact that they want to achieve this with the use of open-source while getting help from the community.</p>
<ul>
<li><a href="https://digital-strategy.ec.europa.eu/en/policies/eudi-wallet-implementation" target="_blank" rel="noopener noreferrer">European Digital Identity (EUDI) Wallet</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ossummit---sveltos">OSSummit - Sveltos<a class="hash-link" aria-label="Direct link to OSSummit - Sveltos" title="Direct link to OSSummit - Sveltos" href="https://github.com/personal-blog/blog/ossummit-europe-2024#ossummit---sveltos">‚Äã</a></h2>
<p>For the conference, we decided to demonstrate how Sveltos can be used to deploy and manage the Container Network Interface (CNI) lifecycle on a fleet of clusters with one manifest file while enabling <a href="https://docs.cilium.io/en/stable/overview/intro/" target="_blank" rel="noopener noreferrer">Cilium Hubble</a> for Network observability. In the second part of the presentation, we demonstrated how to create another set of manifest files to deploy <a href="https://kyverno.io/" target="_blank" rel="noopener noreferrer">Kyverno</a> and specific cluster policies down the clusters based on their scope.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="diagram">Diagram<a class="hash-link" aria-label="Direct link to Diagram" title="Direct link to Diagram" href="https://github.com/personal-blog/blog/ossummit-europe-2024#diagram">‚Äã</a></h3>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;OSSummit Europe 2024 - Sveltos Diagram&amp;quot;" src="https://github.com/personal-blog/assets/images/ossummit_europe_diagram-0c2639cb1d49081a572b14d59e6c112f.jpg" width="4622" height="3461" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="git-repository">Git Repository<a class="hash-link" aria-label="Direct link to Git Repository" title="Direct link to Git Repository" href="https://github.com/personal-blog/blog/ossummit-europe-2024#git-repository">‚Äã</a></h3>
<p>The Git repository with the manifest files and the execution instructions is located <a href="https://github.com/egrosdou01/OSSummit_2024" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="https://github.com/personal-blog/blog/ossummit-europe-2024#conclusions">‚Äã</a></h2>
<p>I had a great fun at the conference! Not only had the chance to present alongside Gianluca, but I also met and interacted with cloud-native enthusiasts.</p>
<p>Till August 2025!</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;OSSummit Europe 2025&amp;quot;" src="https://github.com/personal-blog/assets/images/ossummit_europe_2025-8750e716907847d52374fa5e2c5bcaa9.jpg" width="3616" height="2543" class="img_ev3q"></p>
<p>It's a wrap for this post! üéâ Thanks for reading! Stay tuned for more exciting updates!</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="Conference" term="Conference"/>
        <category label="Open Source" term="Open Source"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="GitOps" term="GitOps"/>
        <category label="DevOps" term="DevOps"/>
        <category label="2024" term="2024"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Civo Navigate Berlin 2024]]></title>
        <id>https://github.com/personal-blog/blog/civo-navigate-berlin-2024</id>
        <link href="https://github.com/personal-blog/blog/civo-navigate-berlin-2024"/>
        <updated>2024-09-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="https://github.com/personal-blog/blog/civo-navigate-berlin-2024#introduction">‚Äã</a></h2>
<p>Today's post will not be as technical as previous ones however, I wanted to share my experience at the <a href="https://www.civo.com/navigate/europe" target="_blank" rel="noopener noreferrer">Civo Navigate</a> in Berlin. I had the chance to talk at the conference, present <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">Sveltos</a> and how it can be used to painlessly deploy different Kubernetes applications and monitoring capabilities on a fleet of clusters.</p>
<p>Apart from that, I attended many different sessions covering relevant topics (Cloud native, Security, Thought Leadership, AI) and meet fellow enthusiasts.</p>
<p>In the sections below, I will outline some of my highlights and afterwards provide an introduction to the Sveltos presentation alongside the useful resources.</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;Civo Navigate Berlin 2024&amp;quot;" src="https://github.com/personal-blog/assets/images/civo_navigate_berlin_2024-4876b5d4d9a8b694abe2b5349c8d9d4e.png" width="1752" height="980" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="civo-navigate---day-1">Civo Navigate - Day 1<a class="hash-link" aria-label="Direct link to Civo Navigate - Day 1" title="Direct link to Civo Navigate - Day 1" href="https://github.com/personal-blog/blog/civo-navigate-berlin-2024#civo-navigate---day-1">‚Äã</a></h2>
<p>The day started quite chill by registering at the event, receiving a badge and becoming familiar with the location. Breakfast and coffee were provided which makes everything much easier.</p>
<p>Fully energized, the conference started with the keynotes and a positive outline of cloud computing, innovation and sustainability, which I can personally relate to it. More details about the Civo partnership with Deep Green can be found <a href="https://www.civo.com/blog/greener-cloud-computing-deep-green" target="_blank" rel="noopener noreferrer">here</a>. Afterwards, many empowering sessions took place, but some could not attend everything. I chose to attend those around developers empowerment and motivation. How developers can work best in diverse environments and how we can allow them to perform best by providing training, noise (notification) minimization, unnecessary meetings and freedom to think and decide on innovative solutions.</p>
<p>From a technical side, I enjoyed a session about testing in modern CI/CD pipelines which gave me a different view of Kubernetes testing. This particular session was an introduction to <a href="https://github.com/kubeshop/testkube" target="_blank" rel="noopener noreferrer">testkube</a>. Not sure how much you can get from the free version in comparison to an enterprise one. Furthermore, I appreciated the informative session about the <a href="https://www.ansible.com/blog/event-driven-ansible-is-here/" target="_blank" rel="noopener noreferrer">Event Driven Ansible</a> to reduce automation reaction time.</p>
<p>After a long day and full of new ideas to try out in the lab, why not chill in the gaming area?</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;Civo Navigate Berlin 2024&amp;quot;" src="https://github.com/personal-blog/assets/images/civo_navigate_gaming_room-31f5d93babf54498737c3d5efbf353f4.jpg" width="4000" height="3000" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="civo-navigate---day-2">Civo Navigate - Day 2<a class="hash-link" aria-label="Direct link to Civo Navigate - Day 2" title="Direct link to Civo Navigate - Day 2" href="https://github.com/personal-blog/blog/civo-navigate-berlin-2024#civo-navigate---day-2">‚Äã</a></h2>
<p>The day started with empowering keynotes from Kelsey Hightower about deep tech, Kubernetes, AI, and how the future might look like. The day continued with mostly technical sessions about open-source tools for Identity Management in Cloud Native stacks, platform engineering and <a href="https://kuttl.dev/" target="_blank" rel="noopener noreferrer">KUTTL</a> for End-to-End (E2E) testing.</p>
<p>Some of the mentioned IAM tools are listed below.</p>
<ul>
<li><a href="https://github.com/rams3sh/Aaia" target="_blank" rel="noopener noreferrer">Aaia</a></li>
<li><a href="https://github.com/iann0036/iamlive" target="_blank" rel="noopener noreferrer">iamalive</a></li>
<li><a href="https://gcp.permissions.cloud/" target="_blank" rel="noopener noreferrer">GCP Permissions</a></li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Once the session recordings are available, a link will be included.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="civo-navigate---sveltos">Civo Navigate - Sveltos<a class="hash-link" aria-label="Direct link to Civo Navigate - Sveltos" title="Direct link to Civo Navigate - Sveltos" href="https://github.com/personal-blog/blog/civo-navigate-berlin-2024#civo-navigate---sveltos">‚Äã</a></h2>
<p>For the conference, we decided to demonstrate how Sveltos can be used to deploy and take over the control of the Container Network Interface (CNI) lifecycle with one manifest file while enabling Cilium Hubble for Network observability. In the second part of the presentation, we demonstrated how to create another set of manifest files to integrate Grafana, Prometheus and Loki for container logs output.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="diagram">Diagram<a class="hash-link" aria-label="Direct link to Diagram" title="Direct link to Diagram" href="https://github.com/personal-blog/blog/civo-navigate-berlin-2024#diagram">‚Äã</a></h3>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;Civo Navigate Berlin 2024&amp;quot;" src="https://github.com/personal-blog/assets/images/civo_navigate_diagram-fe10ff2bafd6444a6f7e09d8f0cb26c3.jpg" width="4690" height="3411" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="git-repository">Git Repository<a class="hash-link" aria-label="Direct link to Git Repository" title="Direct link to Git Repository" href="https://github.com/personal-blog/blog/civo-navigate-berlin-2024#git-repository">‚Äã</a></h3>
<p>The Git repository with the manifest files and the execution instructions are located <a href="https://github.com/egrosdou01/civo_navigate_2024/tree/main" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="https://github.com/personal-blog/blog/civo-navigate-berlin-2024#conclusions">‚Äã</a></h2>
<p>All in all, it was an awesome experience to have the chance to attend and speak at the conference. If you plan to attend any upcoming Civo Navigate conferences, check out the <a href="https://www.civo.com/navigate" target="_blank" rel="noopener noreferrer">link</a>. I am pretty confident you will have an enjoyable experience!</p>
<p>It's a wrap for this post! üéâ Thanks for reading! Stay tuned for more exciting updates!</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="Conference" term="Conference"/>
        <category label="Open Source" term="Open Source"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="GitOps" term="GitOps"/>
        <category label="DevOps" term="DevOps"/>
        <category label="2024" term="2024"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[OpenTofu: RKE2 Cluster with Cilium on Azure]]></title>
        <id>https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure</id>
        <link href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure"/>
        <updated>2024-08-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#introduction">‚Äã</a></h2>
<p>In a <a href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure">previous post</a>, we covered how to create an <a href="https://docs.rke2.io/" target="_blank" rel="noopener noreferrer">RKE2</a> cluster on <a href="https://azure.microsoft.com/en-us/get-started" target="_blank" rel="noopener noreferrer">Azure Cloud</a> using the <a href="https://azure.microsoft.com/en-us/free#all-free-services" target="_blank" rel="noopener noreferrer">cloud-free credits</a> from the <strong>Rancher UI</strong>. As this is a convenient approach to get started with Rancher, in today's post, we will demonstrate how to use <a href="https://opentofu.org/" target="_blank" rel="noopener noreferrer">OpenTofu</a> to automate the deployment.</p>
<p><code>OpenTofu</code> is a fork of <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a>. It is an open-source project, community-driven, and managed by the Linux Foundation. If you want to get familiar with what <code>OpenTofu</code> is and how to get started, check out the link <a href="https://opentofu.org/docs/intro/core-workflow/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>Additionally, we will demonstrate how easy it is to customise the <a href="https://docs.cilium.io/en/stable/" target="_blank" rel="noopener noreferrer">Cilium</a> configuration and enable <a href="https://kube-vip.io/" target="_blank" rel="noopener noreferrer">kube-vip</a> for LoadBalancer services from the HCL (HashiCorp Configuration Language) definition.</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;OpenTofu Rancher RKE2 Cluster on Azure&amp;quot;" src="https://github.com/personal-blog/assets/images/openTofu_rancher_intro_image-d89b7d976207b64e2eaa5b79d0cbf34e.jpg" width="6907" height="2316" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-setup">Lab Setup<a class="hash-link" aria-label="Direct link to Lab Setup" title="Direct link to Lab Setup" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#lab-setup">‚Äã</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------------+------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        Cluster Name         |       Type       |       Version        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------------+------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|          Rancher            |   k3s cluster    |    v1.28.7+k3s1      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Downstream RKE2 cluster     |       RKE2       |  v1.28.11+rke2r1     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------------+------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Deployment     | Version  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      Cilium       | 1.15.500 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      OpenTofu     | v1.8.1   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#prerequisites">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rancher-server">Rancher Server<a class="hash-link" aria-label="Direct link to Rancher Server" title="Direct link to Rancher Server" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#rancher-server">‚Äã</a></h3>
<p>We do not concentrate on installing <code>Rancher</code>. If you are unsure how to install Rancher, take a look at the official documentation <a href="https://ranchermanager.docs.rancher.com/getting-started/quick-start-guides" target="_blank" rel="noopener noreferrer">here</a> or go through the guide I created a couple of weeks back found <a href="https://medium.com/@eleni.grosdouli/rancher-on-eks-with-nginx-ingress-and-lets-encrypt-4f041fc1adae" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="azure-free-credits">Azure Free Credits<a class="hash-link" aria-label="Direct link to Azure Free Credits" title="Direct link to Azure Free Credits" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#azure-free-credits">‚Äã</a></h3>
<p>For this demonstration, we will use the Azure <a href="https://azure.microsoft.com/en-us/free" target="_blank" rel="noopener noreferrer">free credits</a> offering. The approach taken allows readers to understand how to set up the Azure cloud environment to perform RKE2 deployments with Rancher without spending money outside the free-credits offering.</p>
<p>Ensure the below are satisfied.</p>
<ol>
<li>Helm CLI installed (Optional Step)</li>
<li>kubectl installed</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-opentofu">Install OpenTofu<a class="hash-link" aria-label="Direct link to Install OpenTofu" title="Direct link to Install OpenTofu" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#install-opentofu">‚Äã</a></h3>
<p>There is a wide variety of options provided to install <code>OpenTofu</code>. To follow along, check out the <a href="https://opentofu.org/docs/intro/install/" target="_blank" rel="noopener noreferrer">link</a> and install <code>OpenTofu</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="validation">Validation<a class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#validation">‚Äã</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ tofu version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OpenTofu v1.8.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">on darwin_arm64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-0-pre-work">Step 0: Pre-work<a class="hash-link" aria-label="Direct link to Step 0: Pre-work" title="Direct link to Step 0: Pre-work" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#step-0-pre-work">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-01-familiarise-with-opentofu-registry">Step 0.1: Familiarise with OpenTofu Registry<a class="hash-link" aria-label="Direct link to Step 0.1: Familiarise with OpenTofu Registry" title="Direct link to Step 0.1: Familiarise with OpenTofu Registry" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#step-01-familiarise-with-opentofu-registry">‚Äã</a></h3>
<p>As with the Terraform registry, the <code>OpenTofu</code> registry is a centralised service for <strong>distributing</strong> and <strong>managing</strong> providers/modules. Users can <strong>share</strong>, <strong>discover</strong>, and <strong>consume</strong> reusable infrastructure modules and providers.</p>
<p>A list of the available providers/modules is located <a href="https://github.com/opentofu/registry/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>The <code>rancher2</code> provider is supported by OpenTofu. The details can be found <a href="https://github.com/opentofu/registry/tree/main/providers/r/rancher" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-02-familiarise-with-rancher2-provider">Step 0.2: Familiarise with Rancher2 Provider<a class="hash-link" aria-label="Direct link to Step 0.2: Familiarise with Rancher2 Provider" title="Direct link to Step 0.2: Familiarise with Rancher2 Provider" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#step-02-familiarise-with-rancher2-provider">‚Äã</a></h3>
<p>Before we even begin with the actual coding, it is a nice opportunity to familiarise with the <a href="https://search.opentofu.org/provider/opentofu/rancher2/v4.1.0" target="_blank" rel="noopener noreferrer">Rancher2 provider</a>.</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;Rancher2 Terraform Provider&amp;quot;" src="https://github.com/personal-blog/assets/images/rancher2_tf_provider-9d0f69806f1f35bebe06e0d0199cc865.png" width="3454" height="2076" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Check out the example sections of the resources available and the supported Cloud providers.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Be mindful this is an alpha preview of the OpenTofu Registry UI. If you encounter any issues, report them <a href="https://github.com/opentofu/registry-ui/issues" target="_blank" rel="noopener noreferrer">here</a>.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-03-choose-integrated-development-environment-ide">Step 0.3: Choose Integrated Development Environment (IDE)<a class="hash-link" aria-label="Direct link to Step 0.3: Choose Integrated Development Environment (IDE)" title="Direct link to Step 0.3: Choose Integrated Development Environment (IDE)" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#step-03-choose-integrated-development-environment-ide">‚Äã</a></h3>
<p>As with any other project, we will use <a href="https://git-scm.com/book/en/v2/Getting-Started-What-is-Git%3F" target="_blank" rel="noopener noreferrer">Git</a> to store our code in a central location and <a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">Visual Studio Code</a> to perform the coding. Choose your favourite source control system and IDE, and dive into the next sections! üöÄ</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="github-repo">GitHub Repo<a class="hash-link" aria-label="Direct link to GitHub Repo" title="Direct link to GitHub Repo" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#github-repo">‚Äã</a></h2>
<p>The showcase repository is available <a href="https://github.com/egrosdou01/opentofu-rke2-cilium-azure/tree/main" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="outline-project-structure">Outline Project Structure<a class="hash-link" aria-label="Direct link to Outline Project Structure" title="Direct link to Outline Project Structure" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#outline-project-structure">‚Äã</a></h2>
<p>Like with any Terraform project, we will create several <code>.tf</code> files to store the Infrastructure as Code (IaC) definitions. For best practices, have a look at the <a href="https://spacelift.io/blog/opentofu-tutorial#opentofu-best-practices" target="_blank" rel="noopener noreferrer">link</a>.</p>
<p>In your favourite IDE, create a new project and create the below file structure.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="file-structure">File structure<a class="hash-link" aria-label="Direct link to File structure" title="Direct link to File structure" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#file-structure">‚Äã</a></h3>
<ul>
<li><code>main.tf</code>: Contains the resource blocks that define the resources to be created in the Azure cloud</li>
<li><code>variables.tf</code>: Contains the variable declaration used in the resource blocks</li>
<li><code>providers.tf</code>: Contains the required providers used in the resource blocks</li>
<li><code>data.tf</code>: Contains several data retrieved from the outside and used it through the resource creation</li>
<li><code>output.tf</code>: Contains the output that needs to be generated on successful completion of the OpenTofu plan/apply</li>
<li><code>*.tfvars</code>: Contains the default values of the specified variables</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="providerstf">providers.tf<a class="hash-link" aria-label="Direct link to providers.tf" title="Direct link to providers.tf" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#providerstf">‚Äã</a></h2>
<p>The <code>providers.tf</code> file holds the required providers that will be used for the creation of the relevant resources. OpenTofu configurations must declare which providers they require so that OpenTofu can install and use them.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_version = "~&gt; 1.8.1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_providers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rancher2 = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = "opentofu/rancher2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = "4.1.0"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = "opentofu/local"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = "2.5.1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = "opentofu/http"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = "3.4.4"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider "rancher2" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  api_url   = var.rancher2_api_url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token_key = var.rancher2_token_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>It is a good practice to avoid specifying sensitive data in the <code>variables.tf</code> file. The <code>providers.tf</code> file expects the <code>rancher2_api_url</code> and <code>rancher2_token_key</code> variables. Following the best practices, we can have a file that exports the required variable name and value. From a terminal window, we set the <a href="https://www.digitalocean.com/community/tutorials/how-to-read-and-set-environmental-and-shell-variables-on-linux" target="_blank" rel="noopener noreferrer">source</a> pointing to the file before performing any IaC actions.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="datatf">data.tf<a class="hash-link" aria-label="Direct link to data.tf" title="Direct link to data.tf" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#datatf">‚Äã</a></h2>
<p>The <code>data.tf</code> file holds the code to download relevant information about the kube-vip installation. The information will be used later on in the <code>main.tf</code> file while defining the RKE2 cluster configuration.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Download the kube-vip required RBAC manifest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data "http" "kube_vip_rbac" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  url = "https://kube-vip.io/manifests/rbac.yaml"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Download a specific kube-vip version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data "http" "kube_vip_version" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method = "GET"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  url    = "https://api.github.com/repos/kube-vip/kube-vip/releases#v0.8.2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Download the kube-vip-cloud-provider required manifest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data "http" "kube_vip_cloud_provider" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  url = "https://raw.githubusercontent.com/kube-vip/kube-vip-cloud-provider/main/manifest/kube-vip-cloud-controller.yaml"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="outputtf">output.tf<a class="hash-link" aria-label="Direct link to output.tf" title="Direct link to output.tf" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#outputtf">‚Äã</a></h2>
<p>In the file, we can specify anything we want based on the use case at hand. For this demonstration, we keep it simple. We would display only the RKE2 <code>cluster-name</code> and <code>cluster-id</code>.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Display the RKE2 Cluster Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output "rke2_cluster_name" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = rancher2_cluster_v2.rke2.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Display the RKE2 Cluster ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output "rancher_cluster_id" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = data.rancher2_project.system.cluster_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="maintf">main.tf<a class="hash-link" aria-label="Direct link to main.tf" title="Direct link to main.tf" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#maintf">‚Äã</a></h2>
<p>The file contains the logic for creating virtual machines and installing RKE2 on top. We will break the <code>main.tf</code> file into smaller pieces and try to go through them in more detail.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="define-the-azure-cloud-credentials">Define the Azure Cloud Credentials<a class="hash-link" aria-label="Direct link to Define the Azure Cloud Credentials" title="Direct link to Define the Azure Cloud Credentials" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#define-the-azure-cloud-credentials">‚Äã</a></h3>
<p>It is a requirement to have valid Azure cloud credentials before proceeding with the RKE2 installation. If you are unsure how to get the below variable details, have a look at my previous post <a href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#set-up-rancher-cloud-credentials">here</a>.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Create the Azure Cloud Credentials in Rancher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource "rancher2_cloud_credential" "azure_creds" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = "Azure Credentials"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  azure_credential_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client_id       = var.azure_env.az_client_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client_secret   = var.azure_env.az_client_secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subscription_id = var.azure_env.az_subscription_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="define-the-machine-configuration">Define the Machine Configuration<a class="hash-link" aria-label="Direct link to Define the Machine Configuration" title="Direct link to Define the Machine Configuration" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#define-the-machine-configuration">‚Äã</a></h3>
<p>The below resource will create the required virtual machines for the RKE2 cluster. Here, we define two types of nodes, the controller and the worker node. They could have the same or different hardware specifications based on the use case scenario that needs to be covered.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Create the different nodes for RKE2 (controller and worker node)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource "rancher2_machine_config_v2" "nodes" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each      = var.node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  generate_name = each.value.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  azure_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    disk_size            = each.value.agent_disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image                = each.value.image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location             = each.value.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    managed_disks        = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    open_port            = each.value.open_port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private_address_only = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resource_group       = each.value.resource_group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage_type         = each.value.storage_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size                 = each.value.agent_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="define-the-rke2-condifugration">Define the RKE2 Condifugration<a class="hash-link" aria-label="Direct link to Define the RKE2 Condifugration" title="Direct link to Define the RKE2 Condifugration" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#define-the-rke2-condifugration">‚Äã</a></h3>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># RKE2 configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource "rancher2_cluster_v2" "rke2" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations           = var.rancher_env.cluster_annotations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubernetes_version    = var.rancher_env.rke2_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels                = var.rancher_env.cluster_labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable_network_policy = var.rancher_env.network_policy # Option to enable or disable Project Network Isolation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = var.rancher_env.cluster_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rke_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # You can create a Terraform template and polulate the values of the file based on the variables defined below</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    additional_manifest = templatefile("${path.module}/files/kube-vip-daemonset.tfmpl",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int_name                = var.kube_vip.int_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kube_vip_rbac           = data.http.kube_vip_rbac.response_body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kube_vip_version        = jsondecode(data.http.kube_vip_version.response_body)[0]["tag_name"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kube_vip_address        = var.kube_vip.kube_vip_address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kube_vip_pool           = var.kube_vip.kube_vip_pool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kube_vip_cloud_provider = data.http.kube_vip_cloud_provider.response_body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Define the Helm chart values for the Cilium installation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chart_values = &lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Have a look at https://github.com/cilium/cilium/blob/main/install/kubernetes/cilium/values.yaml to include additional custom values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rke2-cilium:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        k8sServiceHost: 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        k8sServicePort: 6443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kubeProxyReplacement: true # Enable Cilium with Kube-Proxy replacement on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Define the Rancher global settings for the whole cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    machine_global_config = &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cni: "cilium" </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cluster-cidr: ${var.rke_cluster_cidr}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      service-cidr: ${var.rke_service_cidr}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disable-kube-proxy: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Sepcify the role of each node based on the name of the node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dynamic "machine_pools" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for_each = var.node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      content {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cloud_credential_secret_name = rancher2_cloud_credential.azure_creds.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        control_plane_role           = machine_pools.key == "controller" ? true : false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcd_role                    = machine_pools.key == "controller" ? true : false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                         = machine_pools.value.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        quantity                     = machine_pools.value.quantity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        worker_role                  = machine_pools.key != "controller" ? true : false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        machine_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          kind = rancher2_machine_config_v2.nodes[machine_pools.key].kind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name = rancher2_machine_config_v2.nodes[machine_pools.key].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    machine_selector_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      config = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="variablestf">variables.tf<a class="hash-link" aria-label="Direct link to variables.tf" title="Direct link to variables.tf" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#variablestf">‚Äã</a></h2>
<p>Outline how the variables used in the <code>main.tf</code> file should look like. If required, perform additional validations to the code.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">variable "azure_env" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = "Azure required details"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    az_client_id       = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    az_client_secret   = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    az_subscription_id = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable "kube_vip" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = "kube-vip basic settings"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int_name         = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kube_vip_address = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kube_vip_pool    = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable "node" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = "Two RKE2 nodes to be configured"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    controller = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name           = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      agent_disk     = optional(number)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image          = optional(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      location       = optional(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      open_port      = optional(list(string))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resource_group = optional(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage_type   = optional(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      agent_type     = optional(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      quantity       = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    worker = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name           = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      agent_disk     = optional(number)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image          = optional(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      location       = optional(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      open_port      = optional(list(string))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resource_group = optional(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage_type   = optional(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      agent_type     = optional(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      quantity       = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable "rancher2_api_url" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = "URL to Rancher Server API"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable "rancher2_token_key" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = "Rancher API Token key"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="terraformtfvars">terraform.tfvars<a class="hash-link" aria-label="Direct link to terraform.tfvars" title="Direct link to terraform.tfvars" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#terraformtfvars">‚Äã</a></h3>
<p>The file holds the input for the resource creation. Depending on how the <code>variables.tf</code> file looks like, we should set a similar structure to define the variables initialisation.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kube_vip = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int_name         = "eth0"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kube_vip_address = "x.x.x.x"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kube_vip_pool    = "x.x.x.x-x.x.x.x"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  controller = { name = "controller", quantity = 1, agent_disk = 30, image = "canonical:UbuntuServer:18.04-LTS:latest", location = "westus", resource_group = "rancher-rg", storage_type = "Standard_LRS", agent_type = "Standard_D2_v2" },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  worker  = { name = "worker", quantity = 1, agent_disk = 30, image = "canonical:UbuntuServer:18.04-LTS:latest", location = "westus", resource_group = "rancher-rg", storage_type = "Standard_LRS", agent_type = "Standard_D2_v2" }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rancher_env = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cluster_annotations = { "rke2" = "demo" }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cluster_labels      = { "rke2" = "azure-demo" }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rke2_version     = "v1.28.11+rke2r1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cluster_id       = "eleni-azure-01"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_policy   = "false"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke_cluster_cidr   = "10.42.0.0/16"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke_service_cidr   = "10.43.0.0/16"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The kube-vip interface name defined in the file represents the network interface from the virtual machines created in the Azure Cloud environment.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The node definition will allow you to create an RKE2 cluster based on the free-credits subscription. If the above are changed, the deployment might fail due to subscription limitations.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="execution">Execution<a class="hash-link" aria-label="Direct link to Execution" title="Direct link to Execution" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#execution">‚Äã</a></h2>
<p>To plan and apply the resources, use the below commands.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tofu init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tofu plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tofu apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>When performing the <code>tofu init</code> command, I received the below warning.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- Installing opentofu/rancher2 v4.1.0...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Installed opentofu/rancher2 v4.1.0. Signature validation was skipped due to the registry not containing GPG keys for this provider</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I raised a <code>GitHub</code> <a href="https://github.com/rancher/terraform-provider-rancher2/issues/1385" target="_blank" rel="noopener noreferrer">issue</a> with the Terraform Rancher2 Provider.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Check out the <code>.terraform/providers/registry.opentofu.org</code> directory with the providers sourced from the OpenTofu registry.</p></div></div>
<p>The above will first create the Azure Cloud Credentials in the Rancher instance, then continue with the RKE2 cluster creation. The <code>tofu apply</code> command might take up to 10 min. Just wait for it to complete.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="validation-1">Validation<a class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#validation-1">‚Äã</a></h2>
<p>If the <code>tofu apply</code> command completes successfully, we should have a cluster with two nodes. One <code>controller</code> and one <code>worker</code> node in the <code>westus</code> region.</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;Rancher2 Terraform Provider&amp;quot;" src="https://github.com/personal-blog/assets/images/rke2_opentofu_azure-6b9ac87af58d9ad3a09d237229e62e3b.png" width="3452" height="1988" class="img_ev3q"></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectk get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                       STATUS   ROLES                       AGE     VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eleni-azure-01-controller-49abc099-ftvnv   Ready    control-plane,etcd,master   11m     v1.28.11+rke2r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eleni-azure-01-worker-87b90346-swd64       Ready    worker                      7m59s   v1.28.11+rke2r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectk get pods -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                                READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-5rfh4                                                        1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-6bd79b68b5-ch979                                    1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-vmt9d                                                        1/1     Running     0          8m8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cloud-controller-manager-eleni-azure-01-controller-49abc099-ftvnv   1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-eleni-azure-01-controller-49abc099-ftvnv                       1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-cilium-kqmkc                                      0/1     Completed   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-coredns-m5f8f                                     0/1     Completed   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-ingress-nginx-vzdps                               0/1     Completed   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-metrics-server-5t4sj                              0/1     Completed   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-snapshot-controller-crd-jvdtd                     0/1     Completed   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-snapshot-controller-zpkhv                         0/1     Completed   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-snapshot-validation-webhook-6qlpx                 0/1     Completed   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-apiserver-eleni-azure-01-controller-49abc099-ftvnv             1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-controller-manager-eleni-azure-01-controller-49abc099-ftvnv    1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-scheduler-eleni-azure-01-controller-49abc099-ftvnv             1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-vip-5vlxw                                                      1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-vip-cloud-provider-85fd9b9cf7-n24fd                            1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns-84b9cb946c-5wch4                          1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns-84b9cb946c-zfkm5                          1/1     Running     0          8m5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns-autoscaler-b49765765-4gkwf                1/1     Running     0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-ingress-nginx-controller-hljpx                                 1/1     Running     0          6m15s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-metrics-server-655477f655-v2j6g                                1/1     Running     0          6m38s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-snapshot-controller-59cc9cd8f4-66942                           1/1     Running     0          6m39s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-snapshot-validation-webhook-54c5989b65-zqxgz                   1/1     Running     0          6m38s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="delete-resources">Delete Resources<a class="hash-link" aria-label="Direct link to Delete Resources" title="Direct link to Delete Resources" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#delete-resources">‚Äã</a></h2>
<p>It is very easy to delete the resources created, simply perform the <code>tofu destroy</code> and confirm the action. The deletion of the resources will take up to 2 minutes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-contact">‚úâÔ∏è Contact<a class="hash-link" aria-label="Direct link to ‚úâÔ∏è Contact" title="Direct link to ‚úâÔ∏è Contact" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#%EF%B8%8F-contact">‚Äã</a></h2>
<p>If you have any questions, feel free to get in touch! You can use the <code>Discussions</code> option found <a href="https://github.com/egrosdou01/personal-blog/discussions" target="_blank" rel="noopener noreferrer">here</a> or reach out to me on any of the social media platforms provided. üòä</p>
<p>We look forward to hearing from you!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="https://github.com/personal-blog/blog/opentofu-rke2-cilium-azure#conclusions">‚Äã</a></h2>
<p>This is it! Automate the creation of RKE2 clusters in Azure with OpenTofu! üéâ</p>
<p>It's a wrap for this post! üéâ Thanks for reading! Stay tuned for more exciting updates!</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="OpenTofu" term="OpenTofu"/>
        <category label="Cilium" term="Cilium"/>
        <category label="RKE2" term="RKE2"/>
        <category label="Azure" term="Azure"/>
        <category label="Open Source" term="Open Source"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="GitOps" term="GitOps"/>
        <category label="DevOps" term="DevOps"/>
        <category label="2024" term="2024"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Sveltos Templating: Cilium Cluster Mesh in One Run]]></title>
        <id>https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh</id>
        <link href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh"/>
        <updated>2024-08-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#introduction">‚Äã</a></h2>
<p>Have you ever wondered how to dynamically instantiate Kubernetes resources before deploying them to a cluster? What if I tell you there is an easy way to do it? <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">Sveltos</a> lets you define add-ons and applications using <a href="https://projectsveltos.github.io/sveltos/template/intro_template/" target="_blank" rel="noopener noreferrer">templates</a>. Before deploying any resource down the <strong>managed</strong> clusters, Sveltos instantiates the templates using information gathered from the <strong>management</strong> cluster.</p>
<p>In a <a href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2">previous post</a>, we outlined a step-by-step approach to forming a <a href="https://docs.cilium.io/en/v1.15/network/clustermesh/clustermesh/" target="_blank" rel="noopener noreferrer">Cilium cluster mesh</a> between two clusters. In today's post, we will demonstrate how the Sveltos templating is used to deploy a Cilium cluster mesh dynamically in <strong>one go</strong>.</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;Sveltos Templating Cilium&amp;quot;" src="https://github.com/personal-blog/assets/images/Sveltos_Templating_Cilium-2b893e8b722fbbacf6940994c1a67404.jpg" width="5364" height="2982" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-setup">Lab Setup<a class="hash-link" aria-label="Direct link to Lab Setup" title="Direct link to Lab Setup" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#lab-setup">‚Äã</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Cluster Name  |        Type       |         Version          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   mgmt          | Mgmt Cluster      |      v1.28.9+rke2r1      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  mesh01         | Managed Cluster   |      v1.29.2+k3s1        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  mesh02         | Managed Cluster   |      v1.29.2+k3s1        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  Deployment | Version  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Cilium   | v1.15.6  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  sveltosctl | v0.32.0  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#prerequisites">‚Äã</a></h2>
<p>To follow along, ensure the below are satisfied.</p>
<ol>
<li>A management cluster with Sveltos installed</li>
<li>kubectl installed</li>
<li>sveltosctl installed</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are unaware of how to install Sveltos in a Kubernetes cluster, follow the instructions mentioned <a href="https://projectsveltos.github.io/sveltos/getting_started/install/install/" target="_blank" rel="noopener noreferrer">here</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-register-clusters-withsveltos">Step 1: Register Clusters with&nbsp;Sveltos<a class="hash-link" aria-label="Direct link to Step 1: Register Clusters with&nbsp;Sveltos" title="Direct link to Step 1: Register Clusters with&nbsp;Sveltos" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#step-1-register-clusters-withsveltos">‚Äã</a></h2>
<p>For this demonstration the <a href="https://www.civo.com/kubernetes" target="_blank" rel="noopener noreferrer">Civo Kubernetes</a> cluster offering was used. Once the clusters are ready, it is time to proceed with the Sveltos cluster registration. To do that, we will utilise <code>sveltosctl</code> and generate a new kubeconfig file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sveltosctl register cluster --namespace=&lt;namespace&gt; --cluster=&lt;cluster name&gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --kubeconfig=&lt;path to Sveltos file with Kubeconfig&gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels=key=value</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example---mesh01-registration">Example - mesh01 registration<a class="hash-link" aria-label="Direct link to Example - mesh01 registration" title="Direct link to Example - mesh01 registration" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#example---mesh01-registration">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sveltosctl register cluster --namespace=civo --cluster=mesh01 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --kubeconfig=/home/test/mesh01.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels=cilium=zone01</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We will register the clusters with Sveltos on the mentioned <strong>namespace</strong>, <strong>name</strong>, and will attach the cluster <strong>labels</strong> <code>cilium=zone01</code> and <code>cilium=zone02</code> respectively.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If the namespace does not exist in the management cluster, the command will fail with the namespace not found error. Ensure the defined namespace exists in the cluster before registration.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation">Validation<a class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#validation">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get sveltoscluster -A --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE   NAME     READY   VERSION          LABELS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">civo        mesh01   true    v1.29.2+k3s1     cilium=zone01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">civo        mesh02   true    v1.29.2+k3s1     cilium=zone02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mgmt        mgmt     true    v1.28.9+rke2r1   sveltos-agent=present</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-deploy-cilium-cluster-mesh-configmap">Step 2: Deploy Cilium Cluster Mesh ConfigMap<a class="hash-link" aria-label="Direct link to Step 2: Deploy Cilium Cluster Mesh ConfigMap" title="Direct link to Step 2: Deploy Cilium Cluster Mesh ConfigMap" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#step-2-deploy-cilium-cluster-mesh-configmap">‚Äã</a></h2>
<p>Before we even start working with the Sveltos templating, we will deploy two <code>ConfigMap</code> resources that include the Cilium Cluster Mesh configuration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example---mesh01-configmap">Example - mesh01 ConfigMap<a class="hash-link" aria-label="Direct link to Example - mesh01 ConfigMap" title="Direct link to Example - mesh01 ConfigMap" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#example---mesh01-configmap">‚Äã</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mesh01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> civo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">k8sServiceHost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"74.220.x.x"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">k8sServicePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"6443"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">nodePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"32379"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">crt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Define the base64 ca.crt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Define the base64 ca.key"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterPoolIPv4PodCIDRList</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10.244.0.0/16"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">peermeshname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"mesh02"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">peermeship</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"192.168.x.x"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">peermeshport</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"32380"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From the YAML definition, it is clear the resources we would like to deploy are in a key-value format. The <code>ConfigMap</code> for both clusters contains the required information to form a <a href="https://cilium.io/use-cases/cluster-mesh/" target="_blank" rel="noopener noreferrer">Cilium cluster mesh</a> seamlessly.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-configmap-management-cluster">Deploy ConfigMap Management Cluster<a class="hash-link" aria-label="Direct link to Deploy ConfigMap Management Cluster" title="Direct link to Deploy ConfigMap Management Cluster" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#deploy-configmap-management-cluster">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f config_mesh01.yaml,config_mesh02.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cm -n civo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                   DATA   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-config-mesh01   10     9s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-config-mesh02   10     5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-root-ca.crt       1      23m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>As the Kubernetes managed clusters are registered in the <code>civo</code> namespace, the <code>ConfigMaps</code> are defined there.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-deploy-sveltos-clusterprofile">Step 3: Deploy Sveltos ClusterProfile<a class="hash-link" aria-label="Direct link to Step 3: Deploy Sveltos ClusterProfile" title="Direct link to Step 3: Deploy Sveltos ClusterProfile" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#step-3-deploy-sveltos-clusterprofile">‚Äã</a></h2>
<p>We will create a Sveltos <a href="https://projectsveltos.github.io/sveltos/features/set/#referencing-clustersetset-in-a-clusterprofileprofile" target="_blank" rel="noopener noreferrer">ClusterProfile</a> to install <strong>Cilium</strong> as a <strong>CNI</strong> alongside the <strong>Hubble UI</strong> and <strong>Cilium cluster mesh</strong> by instantiating the configuration from the information located in the <code>ConfigMap</code> created in previous step.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example---mesh01-clusterprofile">Example - mesh01 ClusterProfile<a class="hash-link" aria-label="Direct link to Example - mesh01 ClusterProfile" title="Direct link to Example - mesh01 ClusterProfile" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#example---mesh01-clusterprofile">‚Äã</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config.projectsveltos.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterProfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">1156</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zone01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">cilium</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zone01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">templateResourceRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Cluster.metadata.name </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">identifier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CiliumConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">helmCharts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">chartName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium/cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">chartVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.15.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">helmChartAction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryURL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//helm.cilium.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        ca:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          cert: {{ (getResource "CiliumConfig").data.crt }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          key: {{ (getResource "CiliumConfig").data.key }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        id: {{ (getResource "CiliumConfig").data.id }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        name: {{ .Cluster.metadata.name }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      clustermesh:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        apiserver:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          replicas: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            nodePort: {{ (getResource "CiliumConfig").data.nodePort }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            authMode: cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              extraDnsNames:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                - "{{ .Cluster.metadata.name }}.mesh.cilium.io"</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          clusters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          - address: ""</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            ips:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            - {{ (getResource "CiliumConfig").data.peermeship }} # The Node IP of the available nodes or a resolvable hostname</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            name: {{ (getResource "CiliumConfig").data.peermeshname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            port: {{ (getResource "CiliumConfig").data.peermeshport }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          domain: "mesh.cilium.io"</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        useAPIServer: true # This is required for the Cluster Mesh setup</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      kubeProxyReplacement: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      k8sServiceHost: {{ (getResource "CiliumConfig").data.k8sServiceHost }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      k8sServicePort: {{ (getResource "CiliumConfig").data.k8sServicePort }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      hubble:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        peerService:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          clusterDomain: cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        relay:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          auto:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            certValidityDuration: 1095</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            method: helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        ui:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      nodeinit:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      ipam:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        mode: cluster-pool</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        operator:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          clusterPoolIPv4MaskSize: "24"</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          clusterPoolIPv4PodCIDRList:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            - {{ (getResource "CiliumConfig").data.clusterPoolIPv4PodCIDRList }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      nodePort:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      debug:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        enabled: true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>ClusterProfile</code> will get deployed to the <strong>managed</strong> clusters with the label set to <code>cilium:zone01</code>. Once a cluster is found, we instruct Sveltos to use the <code>templateResourceRefs</code> capability and use the details found in the <code>ConfgiMap</code> with the name set to <code>cilium-config-{{ .Cluster.metadata.name }}</code>. This will match the <code>cilium-config-mesh01</code> and <code>cilium-config-mesh02</code> ConfigMap. Then, we instruct Sveltos to install the Cilium Helm chart v1.15.6.</p>
<p>For the Cilium Helm chart instantiation, we go through the <code>ConfigMap</code> and populate the <code>values</code> based on the <code>key</code> definition.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>We deploy a Cilium cluster mesh with a <code>common TLS</code> certificate and a <code>NodePort</code> service. For the production environment, it is recommended to deploy a <code>LoadBalancer</code> setup. The above template can be used by updating the <code>clustermesh.service.type=LoadBalancer</code> and setting the standard service <code>Port</code>.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-clusterprofile-management-cluster">Deploy ClusterProfile Management Cluster<a class="hash-link" aria-label="Direct link to Deploy ClusterProfile Management Cluster" title="Direct link to Deploy ClusterProfile Management Cluster" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#deploy-clusterprofile-management-cluster">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f clusterprofile_mesh01.yaml,clusterprofile_mesh02.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-validate-results">Step 4: Validate Results<a class="hash-link" aria-label="Direct link to Step 4: Validate Results" title="Direct link to Step 4: Validate Results" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#step-4-validate-results">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation---sveltosctl">Validation - sveltosctl<a class="hash-link" aria-label="Direct link to Validation - sveltosctl" title="Direct link to Validation - sveltosctl" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#validation---sveltosctl">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./sveltosctl show addons                                     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------+-------------+--------+---------+--------------------------------+-----------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   CLUSTER   | RESOURCE TYPE |  NAMESPACE  |  NAME  | VERSION |              TIME              |             PROFILES              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------+-------------+--------+---------+--------------------------------+-----------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| civo/mesh01 | helm chart    | kube-system | cilium | 1.15.6  | 2024-08-10 22:38:33 +0200 CEST | ClusterProfile/cilium-1156-zone01 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| civo/mesh02 | helm chart    | kube-system | cilium | 1.15.6  | 2024-08-10 22:38:55 +0200 CEST | ClusterProfile/cilium-1156-zone02 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------+-------------+--------+---------+--------------------------------+-----------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation---mesh01">Validation - mesh01<a class="hash-link" aria-label="Direct link to Validation - mesh01" title="Direct link to Validation - mesh01" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#validation---mesh01">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it -n kube-system cilium-888jc -c cilium-agent -- cilium-dbg troubleshoot clustermesh mesh02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Found 1 remote cluster configurations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Troubleshooting filtered subset of clusters: mesh02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Remote cluster "mesh02":</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">üìÑ Configuration path: /var/lib/cilium/clustermesh/mesh02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">üîå Endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - https://mesh02.mesh.cilium.io:32380</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ‚úÖ Hostname resolved to: 192.168.x.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ‚úÖ TCP connection successfully established to 192.168.x.x:32380</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ‚úÖ TLS connection successfully established to 192.168.x.x:32380</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ‚ÑπÔ∏è  Negotiated TLS version: TLS 1.3, ciphersuite TLS_AES_128_GCM_SHA256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ‚ÑπÔ∏è  Etcd server version: 3.5.14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">üîë Digital certificates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚úÖ TLS Root CA certificates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - Serial number:       2c:b4:43:9c:fb:82:62:4f:55:0f:eb:5e:a4:fe:af:5e:14:95:18:74</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Subject:             CN=Cilium LAB CA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Issuer:              CN=Cilium LAB CA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Validity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Not before:  2024-04-25 14:04:31 +0000 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Not after:   2034-04-23 14:04:31 +0000 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚úÖ TLS client certificates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - Serial number:       13:8f:38:4e:e9:08:bb:81:93:20:ff:30:33:ed:fb:13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Subject:             CN=remote-mesh01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Issuer:              CN=Cilium LAB CA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Validity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Not before:  2024-08-10 20:53:31 +0000 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Not after:   2027-08-10 20:53:31 +0000 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚öôÔ∏è Etcd client:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚úÖ Etcd connection successfully established</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚ÑπÔ∏è  Etcd cluster ID: 820847063f6cabce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation---mesh02">Validation - mesh02<a class="hash-link" aria-label="Direct link to Validation - mesh02" title="Direct link to Validation - mesh02" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#validation---mesh02">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it -n kube-system cilium-94ddz -c cilium-agent -- cilium-dbg troubleshoot clustermesh mesh01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Found 1 remote cluster configurations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Troubleshooting filtered subset of clusters: mesh01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Remote cluster "mesh01":</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">üìÑ Configuration path: /var/lib/cilium/clustermesh/mesh01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">üîå Endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - https://mesh01.mesh.cilium.io:32379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ‚úÖ Hostname resolved to: 192.168.x.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ‚úÖ TCP connection successfully established to 192.168.x.x:32379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ‚úÖ TLS connection successfully established to 192.168.x.x:32379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ‚ÑπÔ∏è  Negotiated TLS version: TLS 1.3, ciphersuite TLS_AES_128_GCM_SHA256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ‚ÑπÔ∏è  Etcd server version: 3.5.14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">üîë Digital certificates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚úÖ TLS Root CA certificates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - Serial number:       2c:b4:43:9c:fb:82:62:4f:55:0f:eb:5e:a4:fe:af:5e:14:95:18:74</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Subject:             CN=Cilium LAB CA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Issuer:              CN=Cilium LAB CA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Validity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Not before:  2024-04-25 14:04:31 +0000 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Not after:   2034-04-23 14:04:31 +0000 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚úÖ TLS client certificates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - Serial number:       94:02:e1:4a:b8:74:4c:d7:62:af:c1:d8:19:a8:3b:8f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Subject:             CN=remote-mesh02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Issuer:              CN=Cilium LAB CA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Validity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Not before:  2024-08-10 20:59:07 +0000 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Not after:   2027-08-10 20:59:07 +0000 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚öôÔ∏è Etcd client:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚úÖ Etcd connection successfully established</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚ÑπÔ∏è  Etcd cluster ID: 21f7360bef94b707</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Cilium cluster mesh is deployed in <strong>one run</strong> without the need for an additional Infrastructure as Code (IaC) tool or additional rendering!</p>
<p><img decoding="async" loading="lazy" src="https://i.kym-cdn.com/entries/icons/original/000/045/269/ebdn.jpg" alt="title image reading &quot;Michael Scott Dance - Reference: Phillip Hamilton - https://knowyourmeme.com/memes/michael-scott-with-speaker-everybody-dance-now&quot;" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sveltos-templating-benefits">Sveltos Templating Benefits<a class="hash-link" aria-label="Direct link to Sveltos Templating Benefits" title="Direct link to Sveltos Templating Benefits" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#sveltos-templating-benefits">‚Äã</a></h2>
<p>Sveltos templating enables users to utilise the <strong>same add-on configuration</strong> across different clusters while allowing variations like different add-on configuration values.</p>
<p>Sveltos lets users define add-ons and applications in a <strong>reusable</strong> way. We can deploy the definitions across <strong>multiple</strong> clusters with <strong>minor adjustments</strong>. The approach saves <strong>time</strong>, <strong>effort</strong>, and <strong>headaches</strong>, especially in large-scale environments.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#conclusions">‚Äã</a></h2>
<p>In a couple of minutes and with a minimal configuration effort we formed a cluster mesh between two Kubernetes clusters. This is the power of Sveltos templating.</p>
<p>If you want to explore a step-by-step guide on how to setup a Cilium cluster mesh, have a look at my previous blog post <a href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-contact">‚úâÔ∏è Contact<a class="hash-link" aria-label="Direct link to ‚úâÔ∏è Contact" title="Direct link to ‚úâÔ∏è Contact" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#%EF%B8%8F-contact">‚Äã</a></h2>
<p>We are here to help! Whether you have questions, or issues or need assistance, our Slack channel is the perfect place for you. Click here to <a href="https://app.slack.com/client/T0471SNT5CZ/C06UZCXQLGP" target="_blank" rel="noopener noreferrer">join us</a> us.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-support-thisproject">üëè Support this&nbsp;project<a class="hash-link" aria-label="Direct link to üëè Support this&nbsp;project" title="Direct link to üëè Support this&nbsp;project" href="https://github.com/personal-blog/blog/sveltos-templating-cilium-cluster-mesh#-support-thisproject">‚Äã</a></h2>
<p>Every contribution counts! If you enjoyed this article, check out the Projectsveltos <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">GitHub repo</a>. You can <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">star üåü the project</a> if you find it helpful.</p>
<p>The GitHub repo is a great resource for getting started with the project. It contains the code, documentation, and many more examples.</p>
<p>Thanks for reading!</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="Sveltos" term="Sveltos"/>
        <category label="Cilium" term="Cilium"/>
        <category label="Open Source" term="Open Source"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="GitOps" term="GitOps"/>
        <category label="DevOps" term="DevOps"/>
        <category label="2024" term="2024"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Rancher RKE2 Cluster on Azure]]></title>
        <id>https://github.com/personal-blog/blog/rancher-rke2-cilium-azure</id>
        <link href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure"/>
        <updated>2024-07-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#introduction">‚Äã</a></h2>
<p>For the last couple of days, I have been working on a new use case installing <a href="https://docs.rke2.io/" target="_blank" rel="noopener noreferrer">RKE2</a> clusters powered with <a href="https://docs.cilium.io/en/v1.15/" target="_blank" rel="noopener noreferrer">Cilium</a> on <a href="https://azure.microsoft.com/en-us/get-started" target="_blank" rel="noopener noreferrer">Azure Cloud</a>. The requirement at hand was to use a <a href="https://ranchermanager.docs.rancher.com/v2.8" target="_blank" rel="noopener noreferrer">Rancher</a> instance and from there start deploying RKE2 clusters. After going through the official Rancher documentation, I have noticed that the instructions provided to pre-configure <a href="https://ranchermanager.docs.rancher.com/v2.8/how-to-guides/new-user-guides/launch-kubernetes-with-rancher/use-new-nodes-in-an-infra-provider/create-an-azure-cluster" target="_blank" rel="noopener noreferrer">Azure Cloud</a> are outdated.</p>
<p>In today's blog post, we will cover all the required steps taken to configure the <a href="https://azure.microsoft.com/en-us/free#all-free-services" target="_blank" rel="noopener noreferrer">Azure cloud-free credits</a> to deploy RKE2 clusters with Cilium in that environment. Additionally, we will cover any limitations that come with the <code>free credit</code> concept.</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;Rancher RKE2 Cluster on Azure&amp;quot;" src="https://github.com/personal-blog/assets/images/Rancher_RKE2_Cilium_Azure-5c16e5dc1bd8c9f1d6816d68dca6d0e8.jpg" width="8412" height="1902" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-setup">Lab Setup<a class="hash-link" aria-label="Direct link to Lab Setup" title="Direct link to Lab Setup" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#lab-setup">‚Äã</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------------+------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        Cluster Name         |       Type       |       Version        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------------+------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|          Rancher            |   k3s cluster    |    v1.28.7+k3s1      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Downstream RKE2 cluster     |       RKE2       |  v1.28.11+rke2r1     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------------+------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Deployment     | Version  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      Cilium       | 1.15.500 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#prerequisites">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rancher-server">Rancher Server<a class="hash-link" aria-label="Direct link to Rancher Server" title="Direct link to Rancher Server" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#rancher-server">‚Äã</a></h3>
<p>We do not concentrate on installing Rancher. If you are not sure how to install Rancher, have a look at the official documentation <a href="https://ranchermanager.docs.rancher.com/getting-started/quick-start-guides" target="_blank" rel="noopener noreferrer">here</a> or go through the guide I created a couple of weeks back <a href="https://medium.com/@eleni.grosdouli/rancher-on-eks-with-nginx-ingress-and-lets-encrypt-4f041fc1adae" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="azure-free-credits">Azure Free Credits<a class="hash-link" aria-label="Direct link to Azure Free Credits" title="Direct link to Azure Free Credits" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#azure-free-credits">‚Äã</a></h3>
<p>For this demonstration, we will use the Azure <a href="https://azure.microsoft.com/en-us/free" target="_blank" rel="noopener noreferrer">free credits</a> offering. The approach taken is more than enough to give readers a free and good understanding of how to set up the Azure cloud environment to perform RKE2 deployments with Rancher.</p>
<p>Ensure the below are satisfied.</p>
<ol>
<li>Helm CLI installed (Optional Step)</li>
<li>kubectl installed</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="set-up-azure-cloud-environment">Set up Azure Cloud Environment<a class="hash-link" aria-label="Direct link to Set up Azure Cloud Environment" title="Direct link to Set up Azure Cloud Environment" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#set-up-azure-cloud-environment">‚Äã</a></h2>
<p>In this section, we will provide readers with all the needed guidance on setting up their environment for the RKE2 deployment</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="retrieve-the-tenant-id">Retrieve the Tenant ID<a class="hash-link" aria-label="Direct link to Retrieve the Tenant ID" title="Direct link to Retrieve the Tenant ID" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#retrieve-the-tenant-id">‚Äã</a></h3>
<p>The <code>Tenant ID</code> identifies which Azure Active Directory (AD) instance the application sits under. To retrieve the Tenant ID, follow the steps below.</p>
<ol>
<li>Login to Azure <a href="https://portal.azure.com/" target="_blank" rel="noopener noreferrer">portal</a></li>
<li>Navigate to <strong>Home</strong></li>
<li>Search for <code>Microsoft Entra ID</code>
<img decoding="async" loading="lazy" alt="title image reading &amp;quot;Microsoft Entra ID&amp;quot;" src="https://github.com/personal-blog/assets/images/microsoft_entra_id-af1923eb3d97674f94a215088411e374.png" width="3032" height="574" class="img_ev3q"></li>
<li>Navigate to <strong>Manage &gt; Properties</strong></li>
<li>Grab the <code>Tenant ID</code> once the new windows appear</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-rancher-app-registration">Create a Rancher App Registration<a class="hash-link" aria-label="Direct link to Create a Rancher App Registration" title="Direct link to Create a Rancher App Registration" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#create-a-rancher-app-registration">‚Äã</a></h3>
<p>Azure App Registration is the process of registering an application with Azure AD.</p>
<ol>
<li>
<p>Access the Azure <a href="https://portal.azure.com/" target="_blank" rel="noopener noreferrer">portal</a></p>
</li>
<li>
<p>Navigate to <strong>Home &gt; App registrations &gt; + New Registration</strong></p>
</li>
<li>
<p>Choose the below details:</p>
<ul>
<li><code>Name</code>: What is the name your application will have</li>
<li><code>Supported account types</code>: In my case, I chose the first one, "Accounts in this organizational directory only (Default Directory only - Single tenant)"</li>
<li><code>Redirect URI (optional)</code>: set <code>Web</code> and leave the <code>Sign-on URL</code> empty or add your own URI</li>
</ul>
</li>
<li>
<p>Click the <strong>Register</strong> button to create the application</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;App Registration&amp;quot;" src="https://github.com/personal-blog/assets/images/app_registration-a7bc57ccbd9e147742e95a7a286653ae.png" width="1984" height="1906" class="img_ev3q"></p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-azure-client-secret-for-app-registration">Create an Azure Client Secret for App Registration<a class="hash-link" aria-label="Direct link to Create an Azure Client Secret for App Registration" title="Direct link to Create an Azure Client Secret for App Registration" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#create-an-azure-client-secret-for-app-registration">‚Äã</a></h3>
<ol>
<li>Access the Azure <a href="https://portal.azure.com/" target="_blank" rel="noopener noreferrer">portal</a></li>
<li>Navigate to <strong>Home &gt; App registrations &gt; App name</strong></li>
<li>Navigate to <strong>Manage &gt; Certificates &amp; secrets</strong>
<img decoding="async" loading="lazy" alt="title image reading &amp;quot;Client Secret&amp;quot;" src="https://github.com/personal-blog/assets/images/client_secret-593e5e67a0c9da5ce01eee225d7e1153.png" width="384" height="567" class="img_ev3q"></li>
<li>Click on the <strong>+ New client secret</strong></li>
<li>Provide a <code>description</code> and an <code>expiry date</code></li>
<li>Click <strong>+ Add</strong></li>
<li>Copy the <code>Value</code> and proceed with the configuraition</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-app-registration-permissions">Create App Registration Permissions<a class="hash-link" aria-label="Direct link to Create App Registration Permissions" title="Direct link to Create App Registration Permissions" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#create-app-registration-permissions">‚Äã</a></h3>
<ol>
<li>Access the Azure <a href="https://portal.azure.com/" target="_blank" rel="noopener noreferrer">portal</a></li>
<li>Navigate to <strong>Home &gt; Subscriptions &gt; Your subscription name &gt; Access Control (IAM)</strong>
<img decoding="async" loading="lazy" alt="title image reading &amp;quot;IAM&amp;quot;" src="https://github.com/personal-blog/assets/images/iam-6a88e8c23b90c4289246a47821981987.png" width="3054" height="844" class="img_ev3q"></li>
<li>Click on the <strong>+ Add &gt; Add role assigment</strong>
<img decoding="async" loading="lazy" alt="title image reading &amp;quot;IAM&amp;quot;" src="https://github.com/personal-blog/assets/images/add_role_assigment-405ad73b8039535148cdf018c1579a26.png" width="2585" height="1852" class="img_ev3q"></li>
<li>Open the <code>Privileged administrator roles</code> tab</li>
<li>For Role, select <code>Contributor</code></li>
<li>Click on <strong>Next</strong></li>
<li>Members and <strong>+ Select members</strong> and then choose or type for <code>Rancher</code>. If your application name is something else, provide the application name created in a previous step</li>
<li><strong>Review + assing</strong></li>
<li>Proceed with the creation</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="azure-free-account-limitations">Azure Free Account Limitations<a class="hash-link" aria-label="Direct link to Azure Free Account Limitations" title="Direct link to Azure Free Account Limitations" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#azure-free-account-limitations">‚Äã</a></h2>
<p>Find below some of the limitations spotted with the <code>free-credit</code> subscription.</p>
<ol>
<li>You cannot have more than <strong>one</strong> resource pools</li>
<li>You cannot have more than <strong>3</strong> Public IP addresses</li>
<li>You cannot create a resource pool with a <code>VM Size</code> <strong>greater than</strong> <code>Standard_D2_v2</code></li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="set-up-rancher-cloud-credentials">Set up Rancher Cloud Credentials<a class="hash-link" aria-label="Direct link to Set up Rancher Cloud Credentials" title="Direct link to Set up Rancher Cloud Credentials" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#set-up-rancher-cloud-credentials">‚Äã</a></h2>
<p>Once we have the Azure environment ready, we can move on with Rancher. The first thing we have to do is to create <code>Azure Cloud Credentials</code>. The cloud credentials will be used to provision clusters or can be used in other node templates.</p>
<ol>
<li>Login to Rancher</li>
<li>Navigate to <strong>Home &gt; Cluster management <img decoding="async" loading="lazy" alt="title image reading &amp;quot;Cluster Management&amp;quot;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAMP2lDQ1BJQ0MgUHJvZmlsZQAASImVVwdYU8kWnltSIbQAAlJCb4KIlABSQmihdwRRCUmAUGIMBBU7uqjg2sUCNnRVRMEKiAVF7CyKvS8WFJR1sWBX3qSArvvK9+b75s5//znznzNn5pYBQP0EVyzORTUAyBMVSGKD/Rljk1MYpG5ABGSgC7QAyuXli1nR0eEAlsH27+XdDYDI2qsOMq1/9v/XoskX5PMAQKIhTufn8/IgPggAXskTSwoAIMp48ykFYhmGFWhLYIAQL5ThTAWulOF0Bd4rt4mPZUPcCgBZlcuVZAKgdhnyjEJeJtRQ64PYScQXigBQZ0Dsk5c3iQ9xGsQ20EYMsUyfmf6DTubfNNOHNLnczCGsmIu8kAOE+eJc7rT/Mx3/u+TlSgd9WMGqmiUJiZXNGebtVs6kMBlWhbhXlB4ZBbEWxB+EfLk9xCg1SxqSoLBHDXn5bJgzuM4AdeJzA8IgNoQ4SJQbGa7k0zOEQRyI4Q5BpwoLOPEQ60G8UJAfGKe02SyZFKv0hdZnSNgsJX+OK5H7lfl6IM1JYCn1X2cJOEp9TK0oKz4JYirEFoXCxEiI1SB2zM+JC1PajCnKYkcO2kiksbL4LSCOFYiC/RX6WGGGJChWaV+alz84X2xzlpATqcT7C7LiQxT5wVp5XHn8cC7YZYGIlTCoI8gfGz44F74gIFAxd6xbIEqIU+p8EBf4xyrG4lRxbrTSHjcT5AbLeDOIXfIL45Rj8cQCuCEV+niGuCA6XhEnXpTNDY1WxIMvA+GADQIAA0hhTQeTQDYQtvc29MI7RU8Q4AIJyAQC4KBkBkckyXtE8BoHisCfEAlA/tA4f3mvABRC/usQq7g6gAx5b6F8RA54CnEeCAO58F4qHyUa8pYInkBG+A/vXFh5MN5cWGX9/54fZL8zLMiEKxnpoEeG+qAlMZAYQAwhBhFtcQPcB/fCw+HVD1ZnnIl7DM7juz3hKaGD8IhwndBJuD1RWCz5KcoI0An1g5S5SP8xF7gV1HTF/XFvqA6VcV3cADjgLtAPC/eFnl0hy1bGLcsK4yftv83gh9VQ2lGcKChlGMWPYvPzSDU7NdchFVmuf8yPItb0oXyzh3p+9s/+Ift82Ib9bIktxA5gZ7GT2HnsKNYAGFgz1oi1YcdkeGh3PZHvrkFvsfJ4cqCO8B/+BldWlsl8pxqnHqcvir4CwVTZOxqwJ4mnSYSZWQUMFvwiCBgcEc9xBMPZydkFANn3RfH6ehMj/24gum3fuXl/AODdPDAwcOQ7F9oMwD53+Pgf/s7ZMOGnQwWAc4d5UkmhgsNlFwJ8S6jDJ00fGANzYAPn4wzcgBfwA4EgFESBeJAMJsDos+A+l4ApYAaYC0pAGVgGVoP1YBPYCnaCPWA/aABHwUlwBlwEl8F1cBfuni7wAvSBd+AzgiAkhIbQEX3EBLFE7BFnhIn4IIFIOBKLJCNpSCYiQqTIDGQeUoasQNYjW5BqZB9yGDmJnEc6kNvIQ6QHeY18QjFUFdVGjVArdCTKRFloGBqPjkcz0cloETofXYKuRavQ3Wg9ehK9iF5HO9EXaD8GMBVMFzPFHDAmxsaisBQsA5Ngs7BSrByrwmqxJrjOV7FOrBf7iBNxOs7AHeAODsETcB4+GZ+FL8bX4zvxerwVv4o/xPvwbwQawZBgT/AkcAhjCZmEKYQSQjlhO+EQ4TR8lroI74hEoi7RmugOn8VkYjZxOnExcQOxjniC2EF8TOwnkUj6JHuSNymKxCUVkEpI60i7Sc2kK6Qu0geyCtmE7EwOIqeQReRicjl5F/k4+Qr5GfkzRYNiSfGkRFH4lGmUpZRtlCbKJUoX5TNVk2pN9abGU7Opc6lrqbXU09R71DcqKipmKh4qMSpClTkqa1X2qpxTeajyUVVL1U6VrZqqKlVdorpD9YTqbdU3NBrNiuZHS6EV0JbQqmmnaA9oH9Toao5qHDW+2my1CrV6tStqL9Up6pbqLPUJ6kXq5eoH1C+p92pQNKw02BpcjVkaFRqHNW5q9GvSNUdpRmnmaS7W3KV5XrNbi6RlpRWoxdear7VV65TWYzpGN6ez6Tz6PPo2+ml6lzZR21qbo52tXaa9R7tdu09HS8dFJ1Fnqk6FzjGdTl1M10qXo5uru1R3v+4N3U/DjIaxhgmGLRpWO+zKsPd6w/X89AR6pXp1etf1Pukz9AP1c/SX6zfo3zfADewMYgymGGw0OG3QO1x7uNdw3vDS4fuH3zFEDe0MYw2nG241bDPsNzI2CjYSG60zOmXUa6xr7GecbbzK+LhxjwndxMdEaLLKpNnkOUOHwWLkMtYyWhl9poamIaZS0y2m7aafzazNEsyKzerM7ptTzZnmGearzFvM+yxMLCIsZljUWNyxpFgyLbMs11ietXxvZW2VZLXAqsGq21rPmmNdZF1jfc+GZuNrM9mmyuaaLdGWaZtju8H2sh1q52qXZVdhd8ketXezF9pvsO8YQRjhMUI0omrETQdVB5ZDoUONw0NHXcdwx2LHBseXIy1GpoxcPvLsyG9Ork65Ttuc7o7SGhU6qnhU06jXznbOPOcK52ujaaODRs8e3Tj6lYu9i8Blo8stV7prhOsC1xbXr27ubhK3Wrcedwv3NPdK95tMbWY0czHznAfBw99jtsdRj4+ebp4Fnvs9//Jy8Mrx2uXVPcZ6jGDMtjGPvc28ud5bvDt9GD5pPpt9On1Nfbm+Vb6P/Mz9+H7b/Z6xbFnZrN2sl/5O/hL/Q/7v2Z7smewTAVhAcEBpQHugVmBC4PrAB0FmQZlBNUF9wa7B04NPhBBCwkKWh9zkGHF4nGpOX6h76MzQ1jDVsLiw9WGPwu3CJeFNEWhEaMTKiHuRlpGiyIYoEMWJWhl1P9o6enL0kRhiTHRMRczT2FGxM2LPxtHjJsbtinsX7x+/NP5ugk2CNKElUT0xNbE68X1SQNKKpM6xI8fOHHsx2SBZmNyYQkpJTNme0j8ucNzqcV2prqklqTfGW4+fOv78BIMJuROOTVSfyJ14II2QlpS2K+0LN4pbxe1P56RXpvfx2Lw1vBd8P/4qfo/AW7BC8CzDO2NFRnemd+bKzJ4s36zyrF4hW7he+Co7JHtT9vucqJwdOQO5Sbl1eeS8tLzDIi1Rjqh1kvGkqZM6xPbiEnHnZM/Jqyf3ScIk2/OR/PH5jQXa8Ee+TWoj/UX6sNCnsKLww5TEKQemak4VTW2bZjdt0bRnRUFFv03Hp/Omt8wwnTF3xsOZrJlbZiGz0me1zDafPX9215zgOTvnUufmzP292Kl4RfHbeUnzmuYbzZ8z//Evwb/UlKiVSEpuLvBasGkhvlC4sH3R6EXrFn0r5ZdeKHMqKy/7spi3+MKvo35d++vAkowl7Uvdlm5cRlwmWnZjue/ynSs0VxSteLwyYmX9Ksaq0lVvV09cfb7cpXzTGuoa6ZrOteFrG9dZrFu27sv6rPXXK/wr6ioNKxdVvt/A33Blo9/G2k1Gm8o2fdos3HxrS/CW+iqrqvKtxK2FW59uS9x29jfmb9XbDbaXbf+6Q7Sjc2fsztZq9+rqXYa7ltagNdKant2puy/vCdjTWOtQu6VOt65sL9gr3ft8X9q+G/vD9rccYB6oPWh5sPIQ/VBpPVI/rb6vIauhszG5seNw6OGWJq+mQ0ccj+w4anq04pjOsaXHqcfnHx9oLmruPyE+0Xsy8+Tjloktd0+NPXWtNaa1/XTY6XNngs6cOss623zO+9zR857nD19gXmi46Haxvs217dDvrr8fandrr7/kfqnxssflpo4xHcev+F45eTXg6plrnGsXr0de77iRcOPWzdSbnbf4t7pv595+dafwzue7c+4R7pXe17hf/sDwQdUftn/Udbp1HnsY8LDtUdyju495j188yX/ypWv+U9rT8mcmz6q7nbuP9gT1XH4+7nnXC/GLz70lf2r+WfnS5uXBv/z+ausb29f1SvJq4PXiN/pvdrx1edvSH93/4F3eu8/vSz/of9j5kfnx7KekT88+T/lC+rL2q+3Xpm9h3+4N5A0MiLkSrvxXAIMVzcgA4PUOAGjJANDh+Yw6TnH+kxdEcWaVI/CfsOKMKC9uANTC//eYXvh3cxOAvdvg8Qvqq6cCEE0DIN4DoKNHD9XBs5r8XCkrRHgO2Bz9NT0vHfybojhz/hD3zy2QqbqAn9t/AfgFfESRw67yAAAAbGVYSWZNTQAqAAAACAAEARIAAwAAAAEAAQAAARoABQAAAAEAAAA+ARsABQAAAAEAAABGh2kABAAAAAEAAABOAAAAAAAAAEgAAAABAAAASAAAAAEAAqACAAQAAAABAAAAFKADAAQAAAABAAAAEAAAAADBUZlFAAAACXBIWXMAAAsTAAALEwEAmpwYAAACZGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNi4wLjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgICAgICAgICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iPgogICAgICAgICA8dGlmZjpYUmVzb2x1dGlvbj43MjwvdGlmZjpYUmVzb2x1dGlvbj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgICAgPHRpZmY6WVJlc29sdXRpb24+NzI8L3RpZmY6WVJlc29sdXRpb24+CiAgICAgICAgIDxleGlmOlBpeGVsWURpbWVuc2lvbj41MjwvZXhpZjpQaXhlbFlEaW1lbnNpb24+CiAgICAgICAgIDxleGlmOlBpeGVsWERpbWVuc2lvbj42NzwvZXhpZjpQaXhlbFhEaW1lbnNpb24+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgoFjYVPAAAClklEQVQ4EaVUTW8SURQ9DMwApYDhI/UjpEHaRkmqJhhcaOJSG+PKVGPduDCx0ZU74w8wce1aF0Y3amJ0VxMTXViSNsZFbWmKtY0pglQBoQgMMHjvG2YyUOPGs4A395133rkfM7YuAf8A79psgPFvpf4t5rASrGtN60KSbELMWO/UW5hP/0CzreHk4RACXidd1CUO3diDbdChRgSpR2iTaHlHRcjnRLXexuzjZYz6ZHhkCalcHQ+uHMLIHnef+z5BawpLmyU8X8xjraTi4mQAW6UmXQTcnBoTXh6+2UCjpeHG2VifS8mwaohlvlVw98Uq7r/dQmBYxpkJPz7/bOD1lwp+qxqK5JiRiPqRLTX045aUhSCnybH36W1ce5aBd0jGWNCF1UIdn7I1FKoqpieD6BLn6qNlqB0NfNDUsbRV4jXXjAv9ZCGP64kw1rfroFrg9lQU92bimE6MILVRQZAcHw278G7pO5yKHaS7Cw6jS/MrBQSHHPhabCAZ8WLm9KhJTk6EcCQawJ2nK4jv8yC1/ovmCBhWzIqZXJoMveWLmxXEwm6R3vnkfkHoUJcZbbLios5eOr6X6tZE2KtgLl2Ex2kX+9AlxNqs4a1z44iF3DjgU+B1y+C62rmtBLtddxKP+JGrtnD5VAQXjoVRplEahD7YZES226A4JBLSKdx1jfMi8JrF2alKBL7QR41rdQwykXoudcHeA9eTU2MY7sRDb1+hRnCc7oZMlxvlMsSYazrkIL1omKN5G/+YQ5OGVujQDzt0kEqp1sJaWcXLhSwy+Ro6vDEA8aZwnHtTKDfw6kMOKo3QIPgou/OQy5raEekmD/pxgibAOM9nzFePDwhHHP0P6CmTAIvpGexOo19fMHsh/Wtk3f8DtkAVWS9Nh68AAAAASUVORK5CYII=" width="20" height="16" class="img_ev3q"> &gt; Cloud Credentials &gt; Create &gt; Choose Azure</strong></li>
<li>Provide a <code>name</code>, <code>tenant ID</code> (<strong>Home &gt; Subscriptions</strong>), <code>clientID</code> (<strong>Home &gt; App registrations &gt; Rancher &gt; copy the Application (client) ID</strong>), <code>client secret</code> (<strong>Home &gt; App registrations &gt; App name &gt; manage &gt; certificates &amp; secrets</strong>)</li>
<li>Click the <strong>"Create"</strong> button and ensure no error appears on the screen</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-rke2-cluster-with-cilium">Create an RKE2 cluster with Cilium<a class="hash-link" aria-label="Direct link to Create an RKE2 cluster with Cilium" title="Direct link to Create an RKE2 cluster with Cilium" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#create-an-rke2-cluster-with-cilium">‚Äã</a></h2>
<p>It is time to use the Azure cloud credentials to create an RKE2 cluster on Azure with Cilium.</p>
<ol>
<li>Login to the <strong>Rancher UI</strong></li>
<li>Navigiate to <strong>Home &gt; Cluster management <img decoding="async" loading="lazy" alt="title image reading &amp;quot;Cluster Management&amp;quot;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAMP2lDQ1BJQ0MgUHJvZmlsZQAASImVVwdYU8kWnltSIbQAAlJCb4KIlABSQmihdwRRCUmAUGIMBBU7uqjg2sUCNnRVRMEKiAVF7CyKvS8WFJR1sWBX3qSArvvK9+b75s5//znznzNn5pYBQP0EVyzORTUAyBMVSGKD/Rljk1MYpG5ABGSgC7QAyuXli1nR0eEAlsH27+XdDYDI2qsOMq1/9v/XoskX5PMAQKIhTufn8/IgPggAXskTSwoAIMp48ykFYhmGFWhLYIAQL5ThTAWulOF0Bd4rt4mPZUPcCgBZlcuVZAKgdhnyjEJeJtRQ64PYScQXigBQZ0Dsk5c3iQ9xGsQ20EYMsUyfmf6DTubfNNOHNLnczCGsmIu8kAOE+eJc7rT/Mx3/u+TlSgd9WMGqmiUJiZXNGebtVs6kMBlWhbhXlB4ZBbEWxB+EfLk9xCg1SxqSoLBHDXn5bJgzuM4AdeJzA8IgNoQ4SJQbGa7k0zOEQRyI4Q5BpwoLOPEQ60G8UJAfGKe02SyZFKv0hdZnSNgsJX+OK5H7lfl6IM1JYCn1X2cJOEp9TK0oKz4JYirEFoXCxEiI1SB2zM+JC1PajCnKYkcO2kiksbL4LSCOFYiC/RX6WGGGJChWaV+alz84X2xzlpATqcT7C7LiQxT5wVp5XHn8cC7YZYGIlTCoI8gfGz44F74gIFAxd6xbIEqIU+p8EBf4xyrG4lRxbrTSHjcT5AbLeDOIXfIL45Rj8cQCuCEV+niGuCA6XhEnXpTNDY1WxIMvA+GADQIAA0hhTQeTQDYQtvc29MI7RU8Q4AIJyAQC4KBkBkckyXtE8BoHisCfEAlA/tA4f3mvABRC/usQq7g6gAx5b6F8RA54CnEeCAO58F4qHyUa8pYInkBG+A/vXFh5MN5cWGX9/54fZL8zLMiEKxnpoEeG+qAlMZAYQAwhBhFtcQPcB/fCw+HVD1ZnnIl7DM7juz3hKaGD8IhwndBJuD1RWCz5KcoI0An1g5S5SP8xF7gV1HTF/XFvqA6VcV3cADjgLtAPC/eFnl0hy1bGLcsK4yftv83gh9VQ2lGcKChlGMWPYvPzSDU7NdchFVmuf8yPItb0oXyzh3p+9s/+Ift82Ib9bIktxA5gZ7GT2HnsKNYAGFgz1oi1YcdkeGh3PZHvrkFvsfJ4cqCO8B/+BldWlsl8pxqnHqcvir4CwVTZOxqwJ4mnSYSZWQUMFvwiCBgcEc9xBMPZydkFANn3RfH6ehMj/24gum3fuXl/AODdPDAwcOQ7F9oMwD53+Pgf/s7ZMOGnQwWAc4d5UkmhgsNlFwJ8S6jDJ00fGANzYAPn4wzcgBfwA4EgFESBeJAMJsDos+A+l4ApYAaYC0pAGVgGVoP1YBPYCnaCPWA/aABHwUlwBlwEl8F1cBfuni7wAvSBd+AzgiAkhIbQEX3EBLFE7BFnhIn4IIFIOBKLJCNpSCYiQqTIDGQeUoasQNYjW5BqZB9yGDmJnEc6kNvIQ6QHeY18QjFUFdVGjVArdCTKRFloGBqPjkcz0cloETofXYKuRavQ3Wg9ehK9iF5HO9EXaD8GMBVMFzPFHDAmxsaisBQsA5Ngs7BSrByrwmqxJrjOV7FOrBf7iBNxOs7AHeAODsETcB4+GZ+FL8bX4zvxerwVv4o/xPvwbwQawZBgT/AkcAhjCZmEKYQSQjlhO+EQ4TR8lroI74hEoi7RmugOn8VkYjZxOnExcQOxjniC2EF8TOwnkUj6JHuSNymKxCUVkEpI60i7Sc2kK6Qu0geyCtmE7EwOIqeQReRicjl5F/k4+Qr5GfkzRYNiSfGkRFH4lGmUpZRtlCbKJUoX5TNVk2pN9abGU7Opc6lrqbXU09R71DcqKipmKh4qMSpClTkqa1X2qpxTeajyUVVL1U6VrZqqKlVdorpD9YTqbdU3NBrNiuZHS6EV0JbQqmmnaA9oH9Toao5qHDW+2my1CrV6tStqL9Up6pbqLPUJ6kXq5eoH1C+p92pQNKw02BpcjVkaFRqHNW5q9GvSNUdpRmnmaS7W3KV5XrNbi6RlpRWoxdear7VV65TWYzpGN6ez6Tz6PPo2+ml6lzZR21qbo52tXaa9R7tdu09HS8dFJ1Fnqk6FzjGdTl1M10qXo5uru1R3v+4N3U/DjIaxhgmGLRpWO+zKsPd6w/X89AR6pXp1etf1Pukz9AP1c/SX6zfo3zfADewMYgymGGw0OG3QO1x7uNdw3vDS4fuH3zFEDe0MYw2nG241bDPsNzI2CjYSG60zOmXUa6xr7GecbbzK+LhxjwndxMdEaLLKpNnkOUOHwWLkMtYyWhl9poamIaZS0y2m7aafzazNEsyKzerM7ptTzZnmGearzFvM+yxMLCIsZljUWNyxpFgyLbMs11ietXxvZW2VZLXAqsGq21rPmmNdZF1jfc+GZuNrM9mmyuaaLdGWaZtju8H2sh1q52qXZVdhd8ketXezF9pvsO8YQRjhMUI0omrETQdVB5ZDoUONw0NHXcdwx2LHBseXIy1GpoxcPvLsyG9Ork65Ttuc7o7SGhU6qnhU06jXznbOPOcK52ujaaODRs8e3Tj6lYu9i8Blo8stV7prhOsC1xbXr27ubhK3Wrcedwv3NPdK95tMbWY0czHznAfBw99jtsdRj4+ebp4Fnvs9//Jy8Mrx2uXVPcZ6jGDMtjGPvc28ud5bvDt9GD5pPpt9On1Nfbm+Vb6P/Mz9+H7b/Z6xbFnZrN2sl/5O/hL/Q/7v2Z7smewTAVhAcEBpQHugVmBC4PrAB0FmQZlBNUF9wa7B04NPhBBCwkKWh9zkGHF4nGpOX6h76MzQ1jDVsLiw9WGPwu3CJeFNEWhEaMTKiHuRlpGiyIYoEMWJWhl1P9o6enL0kRhiTHRMRczT2FGxM2LPxtHjJsbtinsX7x+/NP5ugk2CNKElUT0xNbE68X1SQNKKpM6xI8fOHHsx2SBZmNyYQkpJTNme0j8ucNzqcV2prqklqTfGW4+fOv78BIMJuROOTVSfyJ14II2QlpS2K+0LN4pbxe1P56RXpvfx2Lw1vBd8P/4qfo/AW7BC8CzDO2NFRnemd+bKzJ4s36zyrF4hW7he+Co7JHtT9vucqJwdOQO5Sbl1eeS8tLzDIi1Rjqh1kvGkqZM6xPbiEnHnZM/Jqyf3ScIk2/OR/PH5jQXa8Ee+TWoj/UX6sNCnsKLww5TEKQemak4VTW2bZjdt0bRnRUFFv03Hp/Omt8wwnTF3xsOZrJlbZiGz0me1zDafPX9215zgOTvnUufmzP292Kl4RfHbeUnzmuYbzZ8z//Evwb/UlKiVSEpuLvBasGkhvlC4sH3R6EXrFn0r5ZdeKHMqKy/7spi3+MKvo35d++vAkowl7Uvdlm5cRlwmWnZjue/ynSs0VxSteLwyYmX9Ksaq0lVvV09cfb7cpXzTGuoa6ZrOteFrG9dZrFu27sv6rPXXK/wr6ioNKxdVvt/A33Blo9/G2k1Gm8o2fdos3HxrS/CW+iqrqvKtxK2FW59uS9x29jfmb9XbDbaXbf+6Q7Sjc2fsztZq9+rqXYa7ltagNdKant2puy/vCdjTWOtQu6VOt65sL9gr3ft8X9q+G/vD9rccYB6oPWh5sPIQ/VBpPVI/rb6vIauhszG5seNw6OGWJq+mQ0ccj+w4anq04pjOsaXHqcfnHx9oLmruPyE+0Xsy8+Tjloktd0+NPXWtNaa1/XTY6XNngs6cOss623zO+9zR857nD19gXmi46Haxvs217dDvrr8fandrr7/kfqnxssflpo4xHcev+F45eTXg6plrnGsXr0de77iRcOPWzdSbnbf4t7pv595+dafwzue7c+4R7pXe17hf/sDwQdUftn/Udbp1HnsY8LDtUdyju495j188yX/ypWv+U9rT8mcmz6q7nbuP9gT1XH4+7nnXC/GLz70lf2r+WfnS5uXBv/z+ausb29f1SvJq4PXiN/pvdrx1edvSH93/4F3eu8/vSz/of9j5kfnx7KekT88+T/lC+rL2q+3Xpm9h3+4N5A0MiLkSrvxXAIMVzcgA4PUOAGjJANDh+Yw6TnH+kxdEcWaVI/CfsOKMKC9uANTC//eYXvh3cxOAvdvg8Qvqq6cCEE0DIN4DoKNHD9XBs5r8XCkrRHgO2Bz9NT0vHfybojhz/hD3zy2QqbqAn9t/AfgFfESRw67yAAAAbGVYSWZNTQAqAAAACAAEARIAAwAAAAEAAQAAARoABQAAAAEAAAA+ARsABQAAAAEAAABGh2kABAAAAAEAAABOAAAAAAAAAEgAAAABAAAASAAAAAEAAqACAAQAAAABAAAAFKADAAQAAAABAAAAEAAAAADBUZlFAAAACXBIWXMAAAsTAAALEwEAmpwYAAACZGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNi4wLjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgICAgICAgICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iPgogICAgICAgICA8dGlmZjpYUmVzb2x1dGlvbj43MjwvdGlmZjpYUmVzb2x1dGlvbj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgICAgPHRpZmY6WVJlc29sdXRpb24+NzI8L3RpZmY6WVJlc29sdXRpb24+CiAgICAgICAgIDxleGlmOlBpeGVsWURpbWVuc2lvbj41MjwvZXhpZjpQaXhlbFlEaW1lbnNpb24+CiAgICAgICAgIDxleGlmOlBpeGVsWERpbWVuc2lvbj42NzwvZXhpZjpQaXhlbFhEaW1lbnNpb24+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgoFjYVPAAAClklEQVQ4EaVUTW8SURQ9DMwApYDhI/UjpEHaRkmqJhhcaOJSG+PKVGPduDCx0ZU74w8wce1aF0Y3amJ0VxMTXViSNsZFbWmKtY0pglQBoQgMMHjvG2YyUOPGs4A395133rkfM7YuAf8A79psgPFvpf4t5rASrGtN60KSbELMWO/UW5hP/0CzreHk4RACXidd1CUO3diDbdChRgSpR2iTaHlHRcjnRLXexuzjZYz6ZHhkCalcHQ+uHMLIHnef+z5BawpLmyU8X8xjraTi4mQAW6UmXQTcnBoTXh6+2UCjpeHG2VifS8mwaohlvlVw98Uq7r/dQmBYxpkJPz7/bOD1lwp+qxqK5JiRiPqRLTX045aUhSCnybH36W1ce5aBd0jGWNCF1UIdn7I1FKoqpieD6BLn6qNlqB0NfNDUsbRV4jXXjAv9ZCGP64kw1rfroFrg9lQU92bimE6MILVRQZAcHw278G7pO5yKHaS7Cw6jS/MrBQSHHPhabCAZ8WLm9KhJTk6EcCQawJ2nK4jv8yC1/ovmCBhWzIqZXJoMveWLmxXEwm6R3vnkfkHoUJcZbbLios5eOr6X6tZE2KtgLl2Ex2kX+9AlxNqs4a1z44iF3DjgU+B1y+C62rmtBLtddxKP+JGrtnD5VAQXjoVRplEahD7YZES226A4JBLSKdx1jfMi8JrF2alKBL7QR41rdQwykXoudcHeA9eTU2MY7sRDb1+hRnCc7oZMlxvlMsSYazrkIL1omKN5G/+YQ5OGVujQDzt0kEqp1sJaWcXLhSwy+Ro6vDEA8aZwnHtTKDfw6kMOKo3QIPgou/OQy5raEekmD/pxgibAOM9nzFePDwhHHP0P6CmTAIvpGexOo19fMHsh/Wtk3f8DtkAVWS9Nh68AAAAASUVORK5CYII=" width="20" height="16" class="img_ev3q"> &gt; Create &gt; ensure RKE2 is selected &gt; Choose Azure</strong></li>
<li>The <code>Cloud Credentials</code> field will get populated automatically. Fill out the details below.<!-- -->
<ul>
<li><code>Cluster Name</code>: Set a cluster name</li>
<li><code>Cluster Description</code>: Set a cluster description</li>
<li>Set the <code>Machine Pools</code> details. This reflects the nodes we will have on the cluster and their specified role (controller or worker nodes).<!-- -->
<ul>
<li><code>Pool Name</code>: Left the default</li>
<li><code>Machine Count</code>: Set to 2 due to limitations</li>
<li><code>Location</code>: Choose your favourable location
<img decoding="async" loading="lazy" alt="title image reading &amp;quot;Azure RKE2 Cluster Page 01&amp;quot;" src="https://github.com/personal-blog/assets/images/azure_rke2_page01-56fcd29de3bab6431f65cad94caa45d2.png" width="1923" height="893" class="img_ev3q"></li>
</ul>
</li>
<li>Continue with the <strong>Cluster Configuration &gt; Basics</strong>
<ul>
<li><code>Kubernetes Version</code>: Define the preferred Kubernetes version</li>
<li><code>Container Network</code>: Choose <strong>Cilium</strong>
<img decoding="async" loading="lazy" alt="title image reading &amp;quot;Azure RKE2 Cluster Page 02&amp;quot;" src="https://github.com/personal-blog/assets/images/azure_rke2_page02-a5ef6cc7238ae8559ee5278311360e42.png" width="1918" height="706" class="img_ev3q">
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>We can leave the rest of the configuration as default. However, if we want to enable Cilium with <code>kube-proxy</code> replacement, we can update the cluster by editing the YAML configuration instead. This can be done by clicking the <code>Edit as YAML</code> button at the bottom right-hand side.</p></div></div>
</li>
</ul>
</li>
<li>Continue with the <strong>Cluster Configuration &gt; Advanced</strong>
<ul>
<li><code>Additional Controller Manager Args</code>: Set <code>--configure-cloud-routes=false</code>
<img decoding="async" loading="lazy" alt="title image reading &amp;quot;Azure RKE2 Cluster Page 03&amp;quot;" src="https://github.com/personal-blog/assets/images/azure_rke2_page03-9f52550c7de5a3ecf728618142775be8.png" width="1917" height="792" class="img_ev3q"></li>
</ul>
</li>
</ul>
</li>
<li>Click <strong>"Save"</strong></li>
</ol>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The cluster creation might take up to 20 minutes. Be patient as a couple of resources and Azure items are created for this cluster.</p><p>After 20 minutes:
<img decoding="async" loading="lazy" alt="title image reading &amp;quot;Azure RKE2 Cluster Page Success&amp;quot;" src="https://github.com/personal-blog/assets/images/azure_rke2_success-1871165ca5bfbb55a502387aa991891d.png" width="1917" height="653" class="img_ev3q"></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rke2-cluster-validation">RKE2 Cluster Validation<a class="hash-link" aria-label="Direct link to RKE2 Cluster Validation" title="Direct link to RKE2 Cluster Validation" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#rke2-cluster-validation">‚Äã</a></h2>
<p>Now that the RKE2 cluster is up and running, let's perform some validation steps to ensure the cluster is working as expected.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                          STATUS   ROLES                              AGE   VERSION           INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test03-pool1-cff6be83-jfnrw   Ready    control-plane,etcd,master,worker   50m   v1.28.11+rke2r1   192.168.0.5   &lt;none&gt;        Ubuntu 18.04.6 LTS   5.4.0-1109-azure   containerd://1.7.17-k3s1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test03-pool1-cff6be83-wml94   Ready    control-plane,etcd,master,worker   56m   v1.28.11+rke2r1   192.168.0.4   &lt;none&gt;        Ubuntu 18.04.6 LTS   5.4.0-1109-azure   containerd://1.7.17-k3s1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                   READY   STATUS      RESTARTS      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-4wzld                                           1/1     Running     0             49m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-7st9q                                           1/1     Running     0             55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-695b4bfc8b-rrdpw                       1/1     Running     3 (46m ago)   55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-695b4bfc8b-wvswc                       1/1     Running     5 (44m ago)   55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cloud-controller-manager-test03-pool1-cff6be83-jfnrw   1/1     Running     4 (43m ago)   49m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cloud-controller-manager-test03-pool1-cff6be83-wml94   1/1     Running     5 (44m ago)   55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-test03-pool1-cff6be83-jfnrw                       1/1     Running     0             49m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-test03-pool1-cff6be83-wml94                       1/1     Running     0             55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-cilium-4g9m6                         0/1     Completed   0             56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-coredns-4fcl8                        0/1     Completed   0             56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-ingress-nginx-sllhl                  0/1     Completed   0             56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-metrics-server-djld4                 0/1     Completed   0             56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-snapshot-controller-6vktm            0/1     Completed   0             56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-snapshot-controller-crd-fmr6n        0/1     Completed   0             56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-install-rke2-snapshot-validation-webhook-tj4b8    0/1     Completed   0             56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-apiserver-test03-pool1-cff6be83-jfnrw             1/1     Running     1 (43m ago)   49m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-apiserver-test03-pool1-cff6be83-wml94             1/1     Running     1             43m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-controller-manager-test03-pool1-cff6be83-jfnrw    1/1     Running     3 (46m ago)   49m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-controller-manager-test03-pool1-cff6be83-wml94    1/1     Running     1 (44m ago)   46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-proxy-test03-pool1-cff6be83-jfnrw                 1/1     Running     0             49m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-proxy-test03-pool1-cff6be83-wml94                 1/1     Running     0             55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-scheduler-test03-pool1-cff6be83-jfnrw             1/1     Running     3 (46m ago)   49m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-scheduler-test03-pool1-cff6be83-wml94             1/1     Running     1 (44m ago)   46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns-84b9cb946c-bd8p6             1/1     Running     0             49m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns-84b9cb946c-npgl2             1/1     Running     0             55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns-rke2-coredns-autoscaler-b49765765-lp244   1/1     Running     0             55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-ingress-nginx-controller-qk5mc                    1/1     Running     0             53m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-ingress-nginx-controller-wbdf8                    1/1     Running     0             48m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-metrics-server-655477f655-j9vzw                   1/1     Running     0             54m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-snapshot-controller-59cc9cd8f4-8fhwb              1/1     Running     6 (44m ago)   54m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-snapshot-validation-webhook-54c5989b65-9vb9w      1/1     Running     0             54m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods,svc -n cattle-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                             READY   STATUS      RESTARTS      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/cattle-cluster-agent-59df97fc7f-44q74        1/1     Running     2 (43m ago)   46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/cattle-cluster-agent-59df97fc7f-vbvbb        1/1     Running     0             45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/helm-operation-4clvk                         0/2     Completed   0             50m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/helm-operation-89qsx                         0/2     Completed   0             51m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/rancher-webhook-d677765b4-6vrkh              1/1     Running     1 (44m ago)   44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/system-upgrade-controller-6f86d6d4df-jvd9k   1/1     Running     0             51m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/cattle-cluster-agent   ClusterIP   10.43.82.34    &lt;none&gt;        80/TCP,443/TCP   56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/rancher-webhook        ClusterIP   10.43.80.125   &lt;none&gt;        443/TCP          51m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it ds/cilium -n kube-system -- cilium status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Defaulted container "cilium-agent" out of: cilium-agent, install-portmap-cni-plugin (init), config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KVStore:                 Ok   Disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kubernetes:              Ok   1.28 (v1.28.11+rke2r1) [linux/amd64]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kubernetes APIs:         ["EndpointSliceOrEndpoint", "cilium/v2::CiliumClusterwideNetworkPolicy", "cilium/v2::CiliumEndpoint", "cilium/v2::CiliumNetworkPolicy", "cilium/v2::CiliumNode", "cilium/v2alpha1::CiliumCIDRGroup", "core/v1::Namespace", "core/v1::Pods", "core/v1::Service", "networking.k8s.io/v1::NetworkPolicy"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KubeProxyReplacement:    False   [eth0   192.168.0.5 fe80::6245:bdff:fe94:cd06]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host firewall:           Disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SRv6:                    Disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CNI Chaining:            portmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CNI Config file:         successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cilium:                  Ok   1.15.5 (v1.15.5-8c7e442c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NodeMonitor:             Disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cilium health daemon:    Ok   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IPAM:                    IPv4: 9/254 allocated from 10.42.1.0/24, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IPv4 BIG TCP:            Disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IPv6 BIG TCP:            Disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BandwidthManager:        Disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host Routing:            Legacy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Masquerading:            IPTables [IPv4: Enabled, IPv6: Disabled]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Controller Status:       52/52 healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy Status:            OK, ip 10.42.1.172, 0 redirects active on ports 10000-20000, Envoy: embedded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Global Identity Range:   min 256, max 65535</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hubble:                  Disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Encryption:              Disabled        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster health:          2/2 reachable   (2024-07-26T09:19:17Z)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Modules Health:          Stopped(0) Degraded(0) OK(11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-contact">‚úâÔ∏è Contact<a class="hash-link" aria-label="Direct link to ‚úâÔ∏è Contact" title="Direct link to ‚úâÔ∏è Contact" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#%EF%B8%8F-contact">‚Äã</a></h2>
<p>If you have any questions, feel free to get in touch! You can use the <code>Discussions</code> option found <a href="https://github.com/egrosdou01/personal-blog/discussions" target="_blank" rel="noopener noreferrer">here</a> or reach out to me on any of the social media platforms provided. üòä</p>
<p>We look forward to hearing from you!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="https://github.com/personal-blog/blog/rancher-rke2-cilium-azure#conclusions">‚Äã</a></h2>
<p>This is it! We performed an RKE2 cluster with Cilium using the Rancher UI in just a few clicks. üéâ In an upcoming blog post, we will demonstrate how to perform the same with either <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a> or <a href="https://opentofu.org/" target="_blank" rel="noopener noreferrer">OpenTofu</a>!</p>
<p>It's a wrap for this post! üéâ Thanks for reading! Stay tuned for more exciting updates!</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="Rancher" term="Rancher"/>
        <category label="Cilium" term="Cilium"/>
        <category label="RKE2" term="RKE2"/>
        <category label="Open Source" term="Open Source"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="GitOps" term="GitOps"/>
        <category label="DevOps" term="DevOps"/>
        <category label="Azure" term="Azure"/>
        <category label="2024" term="2024"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Cilium Cluster Mesh on RKE2]]></title>
        <id>https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2</id>
        <link href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2"/>
        <updated>2024-07-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#introduction">‚Äã</a></h2>
<p>After spending some time working with the on-prem <a href="https://docs.rke2.io/" target="_blank" rel="noopener noreferrer">RKE2</a> lab setup, I came to notice a couple of issues while forming in an automated fashion the <a href="https://docs.cilium.io/en/stable/network/clustermesh/clustermesh/" target="_blank" rel="noopener noreferrer">Cilium cluster mesh</a> between on-prem clusters.</p>
<p>In today's post, we will go through the step-by-step process of forming a <strong>Cilium Cluster Mesh</strong> and explain any issues that might have arisen by following the <strong>GitOps</strong> approach. The cilium CLI will not be required. The deployment will be performed primarily via <code>Helm</code> and <code>kubectl</code>.</p>
<p>Additionally, we will use the <a href="https://docs.cilium.io/en/v1.15/network/clustermesh/clustermesh/#shared-certificate-authority" target="_blank" rel="noopener noreferrer">shared CA</a> (Certificate Authority) approach as this is a convenient way to form a cluster mesh in an automated fashion and also the best practise for the Hubble Relay setup. The approach will enable <strong>mTLS</strong> across clusters.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-setup">Lab Setup<a class="hash-link" aria-label="Direct link to Lab Setup" title="Direct link to Lab Setup" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#lab-setup">‚Äã</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+----------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Cluster Name  |        Type          |       Version        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+----------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   mesh01        | RKE2 managed cluster | RKE2 v1.27.14+rke2r1 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   mesh02        | RKE2 managed cluster | RKE2 v1.27.14+rke2r1 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+----------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Deployment     | Version  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Rancher2 Provider |  4.2.0   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|     Cilium        | 1.15.500 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#prerequisites">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="infrastructure">Infrastructure<a class="hash-link" aria-label="Direct link to Infrastructure" title="Direct link to Infrastructure" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#infrastructure">‚Äã</a></h3>
<p>For this demonstration, we assume readers have at least two RKE2 clusters up and running. In our case, to create an RKE2 cluster on-prem we used the <a href="https://registry.terraform.io/providers/rancher/rancher2/latest/docs" target="_blank" rel="noopener noreferrer">Rancher2</a> Terraform provider. The provider allows users to create different resources across different platforms alongside defining information for the RKE2 deployment like IP Address handling, and CNI (Container Network Interface) custom configuration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cilium-cluster-mesh">Cilium Cluster Mesh<a class="hash-link" aria-label="Direct link to Cilium Cluster Mesh" title="Direct link to Cilium Cluster Mesh" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#cilium-cluster-mesh">‚Äã</a></h3>
<ul>
<li>The <strong>Cluster Name</strong> and the <strong>Cluster ID</strong> must be unique.</li>
<li>The <strong>Pods</strong> and the <strong>Services CIDR</strong> ranges must be unique across all the Kubernetes Clusters. The pods need to communicate over a unique IP address. See the IP address schema table above.</li>
<li>Node CIDRs must be unique. The Nodes to have IP connectivity.</li>
<li>The Cilium pods must connect to the <code>ClusterMesh API Server</code> service exposed on every Kubernetes cluster.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#resources">‚Äã</a></h3>
<p>Ensure the below are satisfied.</p>
<ol>
<li>Helm CLI installed</li>
<li>kubectl installed</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-0-rke2-terraform-provider">Step 0: RKE2 Terraform Provider<a class="hash-link" aria-label="Direct link to Step 0: RKE2 Terraform Provider" title="Direct link to Step 0: RKE2 Terraform Provider" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#step-0-rke2-terraform-provider">‚Äã</a></h2>
<p>The below snippet is an example configuration on how to deploy an RKE2 cluster via the <strong>Rancher2</strong> Provider.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  # RKE2 configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource "rancher2_cluster_v2" "rke2" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Define basic cluster details like labels and annotations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotations           = var.rancher_env.cluster_annotations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes_version    = var.rancher_env.rke2_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels                = var.rancher_env.cluster_labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_network_policy = var.rancher_env.network_policy # Option to enable or disable Project Network Isolation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name                  = var.rancher_env.cluster_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Define the Cilium Configuration for the cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      chart_values = &lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rke2-cilium:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          k8sServiceHost: 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          k8sServicePort: 6443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          kubeProxyReplacement: true # Prepare the deployment for kube-proxy replacement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          operator:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          hubble: # Enable Hubble for observability </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            peerService:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              clusterDomain: cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            relay:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              auto:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                certValidityDuration: 1095</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                method: helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ui:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Apply machine global settings for the clusters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      machine_global_config = &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cni: "cilium" # Enable Cilium CNI for every cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cluster-cidr: ${var.rke_cluster_cidr}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service-cidr: ${var.rke_service_cidr}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disable-kube-proxy: true # Disable kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcd-expose-metrics: false # Do not expose the etcd metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Start building the controller and workder nodes dynamically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dynamic "machine_pools" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for_each = var.node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          cloud_credential_secret_name = data.rancher2_cloud_credential.auth.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          control_plane_role           = machine_pools.key == "ctl_plane" ? true : false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          etcd_role                    = machine_pools.key == "ctl_plane" ? true : false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name                         = machine_pools.value.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          quantity                     = machine_pools.value.quantity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          worker_role                  = machine_pools.key != "ctl_plane" ? true : false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          machine_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kind = rancher2_machine_config_v2.nodes[machine_pools.key].kind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name = replace(rancher2_machine_config_v2.nodes[machine_pools.key].name, "_", "-")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      machine_selector_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As the focus here is more on the <strong>Cilium Cluster Mesh</strong> setup, we will not go into much detail about the Terraform RKE2 deployment. If there is demand for an in-depth blog post about Terraform RKE2 deployments, feel free to get in touch.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-export-kubeconfig">Step 1: Export kubeconfig<a class="hash-link" aria-label="Direct link to Step 1: Export kubeconfig" title="Direct link to Step 1: Export kubeconfig" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#step-1-export-kubeconfig">‚Äã</a></h2>
<p>Either from the Terraform execution plan or via the Rancher UI, collect the kubeconfig of the RKE2 clusters. Alternatively, we can <code>SSH</code> into one of the RKE2 master nodes and collect the <code>kubeconfig</code> found in the directory <code>/etc/rancher/rke2/rke2.yaml</code>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;directory of kubeconfig&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl nodes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-helm-list-and-values-export">Step 2: Helm list and values export<a class="hash-link" aria-label="Direct link to Step 2: Helm list and values export" title="Direct link to Step 2: Helm list and values export" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#step-2-helm-list-and-values-export">‚Äã</a></h2>
<p>RKE2 comes with its own Cilium CNI Helm chart. That means RKE2 clusters will have an RKE2 Cilium Helm chart deployment in the <code>kube-system</code> namespace.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validate">Validate<a class="hash-link" aria-label="Direct link to Validate" title="Direct link to Validate" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#validate">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;directory of kubeconfig&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm list -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            	NAMESPACE  	REVISION	UPDATED                                	STATUS  	CHART                                       	APP VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-cilium                     	kube-system	1       	2024-07-13 09:32:09.981662 +0200 CEST  	deployed	rke2-cilium-1.15.500                        	1.15.5     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-coredns                    	kube-system	1       	2024-07-13 07:05:49.846980773 +0000 UTC	deployed	rke2-coredns-1.29.002                       	1.11.1     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-ingress-nginx              	kube-system	1       	2024-07-13 07:06:24.63272854 +0000 UTC 	deployed	rke2-ingress-nginx-4.8.200                  	1.9.3      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-metrics-server             	kube-system	1       	2024-07-13 07:06:24.86243331 +0000 UTC 	deployed	rke2-metrics-server-2.11.100-build2023051513	0.6.3      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-snapshot-controller        	kube-system	1       	2024-07-13 07:06:26.764326178 +0000 UTC	deployed	rke2-snapshot-controller-1.7.202            	v6.2.1     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-snapshot-controller-crd    	kube-system	1       	2024-07-13 07:06:24.217899546 +0000 UTC	deployed	rke2-snapshot-controller-crd-1.7.202        	v6.2.1     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke2-snapshot-validation-webhook	kube-system	1       	2024-07-13 07:06:24.544748567 +0000 UTC	deployed	rke2-snapshot-validation-webhook-1.7.302    	v6.2.2 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="collect-rke2-cilium-helm-values">Collect rke2-cilium Helm Values<a class="hash-link" aria-label="Direct link to Collect rke2-cilium Helm Values" title="Direct link to Collect rke2-cilium Helm Values" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#collect-rke2-cilium-helm-values">‚Äã</a></h3>
<p><strong>mesh01</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm get values rke2-cilium -n kube-system -o yaml &gt; values_mesh01.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>mesh02</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm get values rke2-cilium -n kube-system -o yaml &gt; values_mesh02.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Example values_mesh01.yaml</strong></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cattle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">clusterId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">8ffz659l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterCIDR</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.244.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterCIDRv4</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.244.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterDNS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.96.0.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterDomain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rke2DataDir</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/lib/rancher/rke2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceCIDR</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.96.0.0/18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">hubble</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">peerService</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">clusterDomain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">relay</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">auto</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">certValidityDuration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1095</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">method</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ui</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">k8sServiceHost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">k8sServicePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kubeProxyReplacement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">operator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The configuration comes from the <code>machine_global_config</code> and <code>chart_values</code> sections defined in the Terraform code found in <a href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#step-0-rke2-terraform-provider">Step 0</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-cilium-cluster-mesh-helm-values">Step 3: Cilium Cluster Mesh Helm Values<a class="hash-link" aria-label="Direct link to Step 3: Cilium Cluster Mesh Helm Values" title="Direct link to Step 3: Cilium Cluster Mesh Helm Values" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#step-3-cilium-cluster-mesh-helm-values">‚Äã</a></h2>
<p>To set up the Cilium cluster mesh, we need to include the <code>rke2-charts</code> repo and later on, update the Helm values with the required cluster mesh settings. For this demonstration, we will use the <code>NodePort</code> deployment. For production environments, a <code>LoadBalancer</code> deployment is recommended as we do not have to rely on Node availability.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-rke2-charts-repo">Add rke2-charts Repo<a class="hash-link" aria-label="Direct link to Add rke2-charts Repo" title="Direct link to Add rke2-charts Repo" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#add-rke2-charts-repo">‚Äã</a></h3>
<p>The action should be performed in both clusters.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm repo add rke2-charts https://rke2-charts.rancher.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm repo update</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="update-mesh01-helm-values">Update mesh01 Helm Values<a class="hash-link" aria-label="Direct link to Update mesh01 Helm Values" title="Direct link to Update mesh01 Helm Values" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#update-mesh01-helm-values">‚Äã</a></h3>
<p>On the same level as global, add the below configuration.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ca</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cert</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Base64 encoded shared CA crt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Base64 encoded shared CA key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mesh01 </span><span class="token comment" style="color:#999988;font-style:italic"># The unique name of the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The unique ID of the cluster used for the cluster mesh formation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">clustermesh</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiserver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NodePort </span><span class="token comment" style="color:#999988;font-style:italic"># Set the Clustermesh API service to be of type NodePort. Not recommended for Production environments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32379</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the listening port for the Clustermesh API service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">authMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">extraDnsNames</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"mesh01.mesh.cilium.io"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the extra DNS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">clusters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ips</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> &lt;Node IP</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The Node IP of the mesh02 cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mesh02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32380</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The NodePort defined on mesh02 for the Clustermesh API service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"mesh.cilium.io"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the default domain for the mesh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">useAPIServer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Enable the Clustermesh API deployment</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="update-mesh02-helm-values">Update mesh02 Helm Values<a class="hash-link" aria-label="Direct link to Update mesh02 Helm Values" title="Direct link to Update mesh02 Helm Values" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#update-mesh02-helm-values">‚Äã</a></h3>
<p>On the same level as global, add the below configuration.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ca</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cert</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Base64 encoded shared CA crt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Base64 encoded shared CA key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mesh02 </span><span class="token comment" style="color:#999988;font-style:italic"># The unique name of the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The unique ID of the cluster used for the cluster mesh formation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">clustermesh</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiserver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NodePort </span><span class="token comment" style="color:#999988;font-style:italic"># Set the Clustermesh API service to be of type NodePort. Not recommended for production environments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32380</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the listening port for the Clustermesh API service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">authMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">extraDnsNames</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"mesh02.mesh.cilium.io"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the extra DNS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">clusters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ips</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> &lt;Node IP</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The Node IP of the mesg01 cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mesh01 </span><span class="token comment" style="color:#999988;font-style:italic"># Define the name of the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32379</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The NodePort defined on mesh02 for the Clustermesh API service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"mesh.cilium.io"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Define the default domain for the mesh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">useAPIServer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Enable the Clustermesh API deployment</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="update-mesh01mesh02-helm-deployment">Update mesh01/mesh02 Helm deployment<a class="hash-link" aria-label="Direct link to Update mesh01/mesh02 Helm deployment" title="Direct link to Update mesh01/mesh02 Helm deployment" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#update-mesh01mesh02-helm-deployment">‚Äã</a></h3>
<p>To ensure the updated Helm values are applied, we will use the HELM CLI to update the <code>rke2-cilium</code> deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm upgrade rke2-cilium rke2-charts/rke2-cilium --version 1.15.500 --namespace kube-system -f values_mesh01.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm list -n kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Perform the commands for the <code>mesh02</code> cluster.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The <code>helm upgrade</code> command will create a new revision of the <code>rke2-cilium</code> application and show if the update was successful or not. Additionally, the cilium daemonset will get restarted and the Clustermesh API deployment will get created. Execute the commands below to double-check the update action.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl rollout status daemonset cilium -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods,svc -n kube-system | grep -i clustermesh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-validate-cilium-cluster-mesh">Step 4: Validate Cilium Cluster Mesh<a class="hash-link" aria-label="Direct link to Step 4: Validate Cilium Cluster Mesh" title="Direct link to Step 4: Validate Cilium Cluster Mesh" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#step-4-validate-cilium-cluster-mesh">‚Äã</a></h2>
<p>As we do not use the Cilium CLI, to ensure the Cilium cluster mesh works as expected, we will exec into the cilium daemonset and check the required details.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ds -n kube-system | grep -i cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium                          4         4         4       4            4           kubernetes.io/os=linux   7d6h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="on-mesh01-and-mesh02">On mesh01 and mesh02<a class="hash-link" aria-label="Direct link to On mesh01 and mesh02" title="Direct link to On mesh01 and mesh02" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#on-mesh01-and-mesh02">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it ds/cilium -n kube-system -- cilium status | grep -i clustermesh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Defaulted container "cilium-agent" out of: cilium-agent, install-portmap-cni-plugin (init), config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClusterMesh:             1/1 clusters ready, 11 global-services</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>On both sides, the <code>ClusterMesh</code> should point to <code>1/1 clusters ready</code>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it ds/cilium -n kube-system -- cilium-health status               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Defaulted container "cilium-agent" out of: cilium-agent, install-portmap-cni-plugin (init), config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Probe time:   2024-07-20T13:58:47Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Nodes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh01/mesh01-controller-3d16581b-7q5bj (localhost):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=693.829¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=118.583¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.244.1.71:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=688.411¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=251.927¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh01/mesh01-controller-3d16581b-v58rq:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=671.007¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=237.395¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.244.0.75:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=702.976¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=342.115¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh01/mesh01-worker-7ced0c6c-lz9sp:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=819.21¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=397.398¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.244.3.215:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=821.223¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=465.965¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh01/mesh01-worker-7ced0c6c-w294x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=738.787¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=335.803¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.244.2.36:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=693.326¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=426.571¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh02/mesh02-controller-52d8e160-b27rn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=683.278¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=335.076¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.245.0.106:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=818.386¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=387.314¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh02/mesh02-controller-52d8e160-q4rvf:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=683.097¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=301.448¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.245.1.75:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=748.101¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=510.124¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh02/mesh02-worker-a1c14ae0-5l759:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=631.954¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=266.391¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.245.3.232:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=751.853¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=433.049¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mesh02/mesh02-worker-a1c14ae0-c7tcb:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host connectivity to x.x.x.x:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=671.823¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=365.949¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint connectivity to 10.245.2.69:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ICMP to stack:   OK, RTT=690.894¬µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HTTP to agent:   OK, RTT=466.73¬µs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>With the cilium-health status command, you should be able to see all the nodes from both clusters. Check the ICMP and HTTP status. Should be "OK".</p><p>Also, it might take a couple of minutes till the cilium-health status is available.</p><p>If the time-out persists, have a look at the firewall rules and whether traffic between the clusters is allowed.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>The NodePort IP addresses set for the cluster mesh need to be the IP addresses of the worker node instead of the master node. If they are the master node, the Cilium Cluster Mesh will not get deployed and we will get the below error.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">remote-etcd-cluster01                                                             4m25s ago      4s ago       22      failed to detect whether the cluster configuration is required: etcdserver: permission denied </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-5-hubble-ui">Step 5: Hubble UI<a class="hash-link" aria-label="Direct link to Step 5: Hubble UI" title="Direct link to Step 5: Hubble UI" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#step-5-hubble-ui">‚Äã</a></h2>
<p>To work with the Hubble UI we can use the <code>kubectl port-forward</code> of the Hubble UI service or update the existing <code>rke2-cilium</code> deployment on one of the nodes and expose the Hubble UI as a <code>NodePort</code> service. Just include the below in the <code>values_mesh01.yaml</code> or the <code>values_mesh02.yaml</code> file.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ui</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NodePort</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For more information about the RKE2 Cilium Helm Chart values, have a look <a href="https://artifacthub.io/packages/helm/rke2-charts/rke2-cilium/1.15.500" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-contact">‚úâÔ∏è Contact<a class="hash-link" aria-label="Direct link to ‚úâÔ∏è Contact" title="Direct link to ‚úâÔ∏è Contact" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#%EF%B8%8F-contact">‚Äã</a></h2>
<p>If you have any questions, feel free to get in touch! You can use the <code>Discussions</code> option found <a href="https://github.com/egrosdou01/personal-blog/discussions" target="_blank" rel="noopener noreferrer">here</a> or reach out to me on any of the social media platforms provided. üòä</p>
<p>We look forward to hearing from you!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="https://github.com/personal-blog/blog/cilium-cluster-mesh-rke2#conclusions">‚Äã</a></h2>
<p>This is it! We performed a Cilium cluster mesh between two on-prem RKE2 clusters in just a few steps! üéâ</p>
<p>It's a wrap for this post! üéâ Thanks for reading! Stay tuned for more exciting updates!</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="Cilium" term="Cilium"/>
        <category label="RKE2" term="RKE2"/>
        <category label="Open Source" term="Open Source"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="GitOps" term="GitOps"/>
        <category label="DevOps" term="DevOps"/>
        <category label="2024" term="2024"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Cilium on EKS with Sveltos]]></title>
        <id>https://github.com/personal-blog/blog/cilium-eks-sveltos</id>
        <link href="https://github.com/personal-blog/blog/cilium-eks-sveltos"/>
        <updated>2024-07-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#introduction">‚Äã</a></h2>
<p>In today's blog post, we will demonstrate an easy way of deploying and controlling <a href="https://docs.cilium.io/en/v1.14/" target="_blank" rel="noopener noreferrer">Cilium</a> on an <a href="https://aws.amazon.com/eks/" target="_blank" rel="noopener noreferrer">EKS</a> cluster with <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">Sveltos</a>.</p>
<p>As the majority of the documentation out there provides a step-by-step installation directly with the Helm chart commands, we decided to demonstrate a different approach, the GitOps approach, with the use of <a href="https://projectsveltos.github.io/sveltos/addons/addons/" target="_blank" rel="noopener noreferrer">Sveltos ClusterProfile</a> CRD (Custom Resource Definition).</p>
<p><img decoding="async" loading="lazy" alt="title image reading &amp;quot;Cilium on EKS with Sveltos Diagram&amp;quot;" src="https://github.com/personal-blog/assets/images/cilium_sveltos_eks-96202e60f24f3661fb326790c8b28ead.jpg" width="1600" height="870" class="img_ev3q"></p>
<p>We will utilise the Terraform <a href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest" target="_blank" rel="noopener noreferrer">AWS EKS module</a> to create an EKS cluster. Once the cluster is up and running, we will register it with Sveltos. Then, we will update the <a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-vpc-cni.html" target="_blank" rel="noopener noreferrer"><code>aws-core</code> daemonset</a> to support  ENI mode and remove the <code>kube-proxy</code> Kubernetes resources as Cilium will take over.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-setup">Lab Setup<a class="hash-link" aria-label="Direct link to Lab Setup" title="Direct link to Lab Setup" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#lab-setup">‚Äã</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   Cluster Name  |        Type       |         Version          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   mgmt          | Management Cluster| RKE2 v1.28.9+rke2r1      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| eks-test01      | Managed Cluster   | EKS v1.28.10-eks-49c6de4 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+-------------------+--------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  Deployment | Version  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Cilium   | v1.14.8  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  sveltosctl | v0.27.0  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#prerequisites">‚Äã</a></h2>
<p>To follow along with the blog post, ensure the below are satisfied.</p>
<ol>
<li>AWS Service Account</li>
<li>AWS CLI installed</li>
<li>Terraform installed</li>
<li>kubectl installed</li>
<li>sveltosctl installed</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-create-eks-cluster-with-terraform">Step 1: Create EKS Cluster with Terraform<a class="hash-link" aria-label="Direct link to Step 1: Create EKS Cluster with Terraform" title="Direct link to Step 1: Create EKS Cluster with Terraform" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#step-1-create-eks-cluster-with-terraform">‚Äã</a></h2>
<p>The easiest way to spin up an EKS cluster is by following the recommended training and resources from the Hashicorp website. Find the training material and the Git repository further below.</p>
<ul>
<li>
<p>Training: <a href="https://developer.hashicorp.com/terraform/tutorials/kubernetes/eks" target="_blank" rel="noopener noreferrer">https://developer.hashicorp.com/terraform/tutorials/kubernetes/eks</a></p>
</li>
<li>
<p>GitHub Repository: <a href="https://github.com/hashicorp/learn-terraform-provision-eks-cluster" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/learn-terraform-provision-eks-cluster</a></p>
</li>
</ul>
<p>To execute the Terraform plan, a valid <code>AWS Service Account</code> should be available with the right permissions to create the required resources. For more information about the AWS Service Accounts, have a look <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>To get the cluster <code>kubeconfig</code> and start interacting with the cluster, the <strong>AWS CLI</strong> is used. Modify and execute the command below.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ aws eks update-kubeconfig --region &lt;the region the cluster created&gt; --name &lt;the name of the cluster&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The command will save the kubeconfig in the default directory <code>~/.kube/config</code>. If the file should be stored elsewhere, pass the argument <code>--kubeconfig</code> and specify the output directory. For more details, check out the <a href="https://docs.aws.amazon.com/cli/latest/reference/eks/update-kubeconfig.html" target="_blank" rel="noopener noreferrer">link</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-register-cluster-withsveltos">Step 2: Register Cluster with&nbsp;Sveltos<a class="hash-link" aria-label="Direct link to Step 2: Register Cluster with&nbsp;Sveltos" title="Direct link to Step 2: Register Cluster with&nbsp;Sveltos" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#step-2-register-cluster-withsveltos">‚Äã</a></h2>
<p>Once we have access to the cluster, it is time to proceed with the Sveltos cluster registration. As this is a cloud Kubernetes cluster, we need to ensure Sveltos has the <strong>right set of permissions</strong> to perform the Kubernetes deployments and add-ons. To do that, we will utilise <code>sveltosctl</code> and generate a new kubeconfig file.</p>
<p>Download the <code>sveltosctl</code> binary <a href="https://github.com/projectsveltos/sveltosctl/releases" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="generate-sveltos-kubeconfig">Generate Sveltos kubeconfig<a class="hash-link" aria-label="Direct link to Generate Sveltos kubeconfig" title="Direct link to Generate Sveltos kubeconfig" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#generate-sveltos-kubeconfig">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Ensure you are authenticated with the AWS service account before performing the command below.</p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;directory of the EKS kubeconfig file&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sveltosctl generate kubeconfig --create --expirationSeconds=86400 &gt; eks_kubeconfig.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>sveltosctl</code> redirects the output of the command into a file named <code>eks_kubeconfig.yaml</code>. The file will be used by Sveltos for the managed cluster registration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="register-ekscluster---management-cluster">Register EKS&nbsp;Cluster - Management Cluster<a class="hash-link" aria-label="Direct link to Register EKS&nbsp;Cluster - Management Cluster" title="Direct link to Register EKS&nbsp;Cluster - Management Cluster" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#register-ekscluster---management-cluster">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sveltosctl register cluster --namespace=&lt;namespace&gt; --cluster=&lt;cluster name&gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --kubeconfig=&lt;path to Sveltos file with Kubeconfig&gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --labels=env=test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The command above will register the EKS cluster with Sveltos on the mentioned <strong>namespace</strong>, and <strong>name</strong> and will attach the cluster <strong>label</strong> <code>env=test</code> defined.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If the namespace does not exist in the management cluster, the command will fail with the namespace not found error. Ensure the defined namespace exists in the cluster before registration.</p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get sveltosclusters -A --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE        NAME         READY   VERSION                LABELS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mgmt             mgmt         true    v1.28.9+rke2r1         sveltos-agent=present</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test             eks-test01   true    v1.28.10-eks-49c6de4   env=test,sveltos-agent=present</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-update-the-ekscluster">Step 3: Update the EKS&nbsp;cluster<a class="hash-link" aria-label="Direct link to Step 3: Update the EKS&nbsp;cluster" title="Direct link to Step 3: Update the EKS&nbsp;cluster" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#step-3-update-the-ekscluster">‚Äã</a></h2>
<p>As we would like to use Cilium with the Kube Proxy replacement and the <a href="https://docs.aws.amazon.com/AmazonECS/latest/bestpracticesguide/networking-networkmode-awsvpc.html" target="_blank" rel="noopener noreferrer">ENI</a> mode enabled, we need to perform additional actions. As the <code>kube-proxy</code> daemonset is already installed, we have to remove all related resources and update the <code>aws-node</code> daemonset to support the ENI mode.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation">Validation<a class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#validation">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods,ds -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                      READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/aws-node-4x8sq                        2/2     Running   0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/aws-node-vjtlx                        2/2     Running   0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/aws-node-xp7vl                        2/2     Running   0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/coredns-648485486-t5sxm               1/1     Running   0          20m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/coredns-648485486-tv4h5               1/1     Running   0          20m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ebs-csi-controller-5df9db689f-8hmdm   6/6     Running   0          15m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ebs-csi-controller-5df9db689f-qmxhs   6/6     Running   0          15m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ebs-csi-node-2rspx                    3/3     Running   0          15m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ebs-csi-node-gvtfj                    3/3     Running   0          15m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ebs-csi-node-t96ch                    3/3     Running   0          15m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/kube-proxy-4jxlt                      1/1     Running   0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/kube-proxy-hgx9h                      1/1     Running   0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/kube-proxy-l877x                      1/1     Running   0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                  DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR              AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/aws-node               3         3         3       3            3           &lt;none&gt;                     20m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/ebs-csi-node           3         3         3       3            3           kubernetes.io/os=linux     16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/ebs-csi-node-windows   0         0         0       0            0           kubernetes.io/os=windows   16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/kube-proxy             3         3         3       3            3           &lt;none&gt;                     20m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="delete-kube-proxy-resources">Delete kube-proxy Resources<a class="hash-link" aria-label="Direct link to Delete kube-proxy Resources" title="Direct link to Delete kube-proxy Resources" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#delete-kube-proxy-resources">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;directory of the EKS kubeconfig file&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl delete ds kube-proxy -n kube-system # Remove the kube-proxy daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl delete cm kube-proxy -n kube-system # Remove the kube-proxy ConfigMap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="update-aws-node-resources">Update aws-node Resources<a class="hash-link" aria-label="Direct link to Update aws-node Resources" title="Direct link to Update aws-node Resources" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#update-aws-node-resources">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl patch daemonset aws-node --type='strategic' -p='{"spec":{"template":{"spec":{"nodeSelector":{"io.cilium/aws-node-enabled":"true"}}}}}' -n kube-system # This is required based on the Cilium documentation to enable the ENI mode</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods,ds -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                      READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/coredns-648485486-t5sxm               1/1     Running   0          22m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/coredns-648485486-tv4h5               1/1     Running   0          22m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ebs-csi-controller-5df9db689f-8hmdm   6/6     Running   0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ebs-csi-controller-5df9db689f-qmxhs   6/6     Running   0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ebs-csi-node-2rspx                    3/3     Running   0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ebs-csi-node-gvtfj                    3/3     Running   0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ebs-csi-node-t96ch                    3/3     Running   0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                  DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                     AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/aws-node               0         0         0       0            0           io.cilium/aws-node-enabled=true   22m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/ebs-csi-node           3         3         3       3            3           kubernetes.io/os=linux            17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/ebs-csi-node-windows   0         0         0       0            0           kubernetes.io/os=windows          17m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The aws-node daemonset scaled down to 0 replicas.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-create-sveltos-clusterprofile">Step 4: Create Sveltos ClusterProfile<a class="hash-link" aria-label="Direct link to Step 4: Create Sveltos ClusterProfile" title="Direct link to Step 4: Create Sveltos ClusterProfile" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#step-4-create-sveltos-clusterprofile">‚Äã</a></h3>
<p>It is time to create a <strong>Sveltos ClusterProfile</strong> and deploy <strong>Cilium</strong> to the EKS cluster with the label set to <code>env=test</code>. Following the Cilium <a href="https://docs.cilium.io/en/v1.14/installation/k8s-install-helm/" target="_blank" rel="noopener noreferrer">documentation</a>, we will enable the required Helm values for the <code>kube-proxy </code>replacement and the ENI mode.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config.projectsveltos.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterProfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env=test </span><span class="token comment" style="color:#999988;font-style:italic"># Deploy Cilium v1.14.8 to any cluster with the cluster label set to env=test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">helmCharts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">chartName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium/cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">chartVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.14.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">helmChartAction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">releaseNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repositoryURL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//helm.cilium.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      eni:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      ipam:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        mode: eni</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      egressMasqueradeInterfaces: eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      routingMode: native</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      kubeProxyReplacement: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      k8sServiceHost: &lt;The Server API FQDN or IP Address&gt; # The information can be exctracted from the kubeconfig file or the AWS UI</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      k8sServicePort: &lt;The Server API listening port&gt; # The information can be extracted from the kubeconfig file or the AWS UI</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      nodePort:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      debug:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        enabled: true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The ClusterProfile will deploy Cilium CNI to any cluster with the cluster label set to <code>env=test</code>. It will then deploy the Cilium Helm chart in the <code>kube-system</code> namespace alongside the kube-proxy replacement and the ENI mode. Hubble is also enabled.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-5-deploy-cilium-andvalidate">Step 5: Deploy Cilium and&nbsp;Validate<a class="hash-link" aria-label="Direct link to Step 5: Deploy Cilium and&nbsp;Validate" title="Direct link to Step 5: Deploy Cilium and&nbsp;Validate" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#step-5-deploy-cilium-andvalidate">‚Äã</a></h2>
<p>To see and evaluate the results, the Sveltos ClusterProfile will be deployed to the management cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;Sveltos managament cluster&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f "clusterprofile_cilium1148.yaml"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation-1">Validation<a class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#validation-1">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./sveltosctl show addons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+---------------+-------------+--------+---------+-------------------------------+----------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|     CLUSTER     | RESOURCE TYPE |  NAMESPACE  |  NAME  | VERSION |             TIME              |          PROFILES          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+---------------+-------------+--------+---------+-------------------------------+----------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| test/eks-test01 | helm chart    | kube-system | cilium | 1.14.8  | 2024-06-18 14:39:26 +0000 UTC | ClusterProfile/cilium-1148 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+---------------+-------------+--------+---------+-------------------------------+----------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export KUBECONFIG=&lt;directory of the EKS kubeconfig file&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n kube-system | grep -i cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-2vg4c                          1/1     Running             0          54s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-594f4858f6-km2wh      1/1     Running             0          54s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-operator-594f4858f6-xx2q6      1/1     Running             0          55s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-qrwwf                          1/1     Running             0          55s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-s55v5                          1/1     Running             0          54s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it cilium-2vg4c -n kube-system -- cilium status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Defaulted container "cilium-agent" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KVStore:                 Ok   Disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kubernetes:              Ok   1.28+ (v1.28.10-eks-49c6de4) [linux/amd64]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kubernetes APIs:         ["EndpointSliceOrEndpoint", "cilium/v2::CiliumClusterwideNetworkPolicy", "cilium/v2::CiliumEndpoint", "cilium/v2::CiliumNetworkPolicy", "cilium/v2::CiliumNode", "cilium/v2alpha1::CiliumCIDRGroup", "core/v1::Namespace", "core/v1::Pods", "core/v1::Service", "networking.k8s.io/v1::NetworkPolicy"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KubeProxyReplacement:    True   [eth0 10.0.1.150 (Direct Routing), eth1 10.0.1.37]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-nginx-application">Deploy Nginx Application<a class="hash-link" aria-label="Direct link to Deploy Nginx Application" title="Direct link to Deploy Nginx Application" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#deploy-nginx-application">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f "nginx.yaml"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods,svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/my-nginx-684dd4dcd4-gl9rm   1/1     Running   0          18s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/my-nginx-684dd4dcd4-nk9mm   1/1     Running   0          18s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/kubernetes   ClusterIP   172.20.0.1      &lt;none&gt;        443/TCP        33m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/my-nginx     NodePort    172.20.80.220   &lt;none&gt;        80:32449/TCP   3s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cilium-validation">Cilium Validation<a class="hash-link" aria-label="Direct link to Cilium Validation" title="Direct link to Cilium Validation" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#cilium-validation">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n kube-system exec ds/cilium -- cilium service list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Defaulted container "cilium-agent" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ID   Frontend             Service Type   Backend                         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1    172.20.0.1:443       ClusterIP      1 =&gt; 10.0.1.15:443 (active)     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         2 =&gt; 10.0.2.226:443 (active)    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2    172.20.208.197:443   ClusterIP      1 =&gt; 10.0.1.150:4244 (active)   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3    172.20.22.66:80      ClusterIP      1 =&gt; 10.0.3.36:4245 (active)    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4    172.20.141.67:80     ClusterIP      1 =&gt; 10.0.2.229:8081 (active)   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5    172.20.0.10:53       ClusterIP      1 =&gt; 10.0.1.144:53 (active)     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         2 =&gt; 10.0.3.123:53 (active)     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6    172.20.80.220:80     ClusterIP      1 =&gt; 10.0.1.216:80 (active)     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         2 =&gt; 10.0.3.39:80 (active)      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7    10.0.1.150:32449     NodePort       1 =&gt; 10.0.1.216:80 (active)     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         2 =&gt; 10.0.3.39:80 (active)      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8    10.0.1.37:32449      NodePort       1 =&gt; 10.0.1.216:80 (active)     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         2 =&gt; 10.0.3.39:80 (active)      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9    0.0.0.0:32449        NodePort       1 =&gt; 10.0.1.216:80 (active)     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         2 =&gt; 10.0.3.39:80 (active)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From the output above, we can observe that Cilium eBPF kube-proxy replacement created the NodePort service for Nginx.</p>
<p>As the blog post is not intended to outline in depth how the kube-proxy replacement works, check out the <a href="https://docs.cilium.io/en/v1.14/network/kubernetes/kubeproxy-free/" target="_blank" rel="noopener noreferrer">link</a> for further tests.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#conclusions">‚Äã</a></h2>
<p>We demonstrated an easy way of deploying Cilium CNI to an EKS cluster with the Sveltos ClusterProfile. The complete lifecycle of the CNI is now controlled by Sveltos and without external dependencies.</p>
<p>Take advantage of the <a href="https://projectsveltos.github.io/sveltos/template/intro_template/" target="_blank" rel="noopener noreferrer">Sveltos Templating</a> and the <a href="https://projectsveltos.github.io/sveltos/events/addon_event_deployment/" target="_blank" rel="noopener noreferrer">Sveltos Event Framework</a> capabilities to make every Kubernetes deployment and add-on easier!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="contact">Contact<a class="hash-link" aria-label="Direct link to Contact" title="Direct link to Contact" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#contact">‚Äã</a></h2>
<p>We are here to help! Whether you have questions, or issues or need assistance, our Slack channel is the perfect place for you. Click here to <a href="https://app.slack.com/client/T0471SNT5CZ/C06UZCXQLGP" target="_blank" rel="noopener noreferrer">join us</a> us.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-support-thisproject">üëè Support this&nbsp;project<a class="hash-link" aria-label="Direct link to üëè Support this&nbsp;project" title="Direct link to üëè Support this&nbsp;project" href="https://github.com/personal-blog/blog/cilium-eks-sveltos#-support-thisproject">‚Äã</a></h2>
<p>Every contribution counts! If you enjoyed this article, check out the Projectsveltos <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">GitHub repo</a>. You can <a href="https://github.com/projectsveltos" target="_blank" rel="noopener noreferrer">star üåü the project</a> if you find it helpful.</p>
<p>The GitHub repo is a great resource for getting started with the project. It contains the code, documentation, and many more examples.</p>
<p>Thanks for reading!</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="Sveltos" term="Sveltos"/>
        <category label="Cilium" term="Cilium"/>
        <category label="Open Source" term="Open Source"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="GitOps" term="GitOps"/>
        <category label="DevOps" term="DevOps"/>
        <category label="2024" term="2024"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Welcome]]></title>
        <id>https://github.com/personal-blog/blog/welcome</id>
        <link href="https://github.com/personal-blog/blog/welcome"/>
        <updated>2024-07-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[üåü Welcome!]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-welcome">üåü Welcome!<a class="hash-link" aria-label="Direct link to üåü Welcome!" title="Direct link to üåü Welcome!" href="https://github.com/personal-blog/blog/welcome#-welcome">‚Äã</a></h2>
<p>Hello and welcome to my blog! üöÄ</p>
<p>Here, you will discover everything you need to know about open source tools, DevOps, and GitOps practices.</p>
<p>Dive in and let's explore together! üí°üîß</p>]]></content>
        <author>
            <name>Eleni Grosdouli</name>
            <uri>https://github.com/egrosdou01</uri>
        </author>
        <category label="Hello" term="Hello"/>
    </entry>
</feed>