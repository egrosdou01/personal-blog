"use strict";(self.webpackChunkpersonal_blog=self.webpackChunkpersonal_blog||[]).push([[6617],{9109:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var i=r(4848),t=r(8453);const o={slug:"opentofu-rke2-cilium-azure",title:"OpenTofu: RKE2 Cluster with Cilium on Azure",authors:["egrosdou01"],date:new Date("2024-08-21T00:00:00.000Z"),tags:["opentofu","cilium","rke2","azure","open-source","kubernetes","gitops","devops","2024"]},a=void 0,s={permalink:"/personal-blog/blog/opentofu-rke2-cilium-azure",source:"@site/blog/2024-08-21-opentofu-rke2-cilium-azure/opentofu-rke2-cilium-azure.md",title:"OpenTofu: RKE2 Cluster with Cilium on Azure",description:"Introduction",date:"2024-08-21T00:00:00.000Z",tags:[{inline:!1,label:"OpenTofu",permalink:"/personal-blog/blog/tags/opentofu",description:"OpenTofu is a fork of Terraform"},{inline:!1,label:"Cilium",permalink:"/personal-blog/blog/tags/cilium",description:"eBPF-based Networking, Security, and Observability for Kubernetes"},{inline:!1,label:"RKE2",permalink:"/personal-blog/blog/tags/rke2",description:"Rancher Kubernetes Engine 2 (RKE2)"},{inline:!1,label:"Azure",permalink:"/personal-blog/blog/tags/azure",description:"Azure Cloud"},{inline:!1,label:"Open Source",permalink:"/personal-blog/blog/tags/open-source",description:"Open source software"},{inline:!1,label:"Kubernetes",permalink:"/personal-blog/blog/tags/kubernetes",description:"Container orchestration platform for automating application deployment, scaling, and management"},{inline:!1,label:"GitOps",permalink:"/personal-blog/blog/tags/gitops",description:"Operational framework that uses Git as a single source of truth for declarative infrastructure and applications"},{inline:!1,label:"DevOps",permalink:"/personal-blog/blog/tags/devops",description:"Set of practices that combines software development and IT operations"},{inline:!1,label:"2024",permalink:"/personal-blog/blog/tags/2024",description:"The year the post went online"}],readingTime:10.665,hasTruncateMarker:!0,authors:[{name:"Eleni Grosdouli",title:"DevOps Consulting Engineer at Cisco Systems",url:"https://github.com/egrosdou01",imageURL:"https://github.com/egrosdou01.png",key:"egrosdou01"}],frontMatter:{slug:"opentofu-rke2-cilium-azure",title:"OpenTofu: RKE2 Cluster with Cilium on Azure",authors:["egrosdou01"],date:"2024-08-21T00:00:00.000Z",tags:["opentofu","cilium","rke2","azure","open-source","kubernetes","gitops","devops","2024"]},unlisted:!1,prevItem:{title:"Civo Navigate Berlin 2024",permalink:"/personal-blog/blog/civo-navigate-berlin-2024"},nextItem:{title:"Sveltos Templating: Cilium Cluster Mesh in One Run",permalink:"/personal-blog/blog/sveltos-templating-cilium-cluster-mesh"}},l={authorsImageUrls:[void 0]},c=[{value:"Introduction",id:"introduction",level:2},{value:"Lab Setup",id:"lab-setup",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Rancher Server",id:"rancher-server",level:3},{value:"Azure Free Credits",id:"azure-free-credits",level:3},{value:"Install OpenTofu",id:"install-opentofu",level:3},{value:"Validation",id:"validation",level:4},{value:"Step 0: Pre-work",id:"step-0-pre-work",level:2},{value:"Step 0.1: Familiarise with OpenTofu Registry",id:"step-01-familiarise-with-opentofu-registry",level:3},{value:"Step 0.2: Familiarise with Rancher2 Provider",id:"step-02-familiarise-with-rancher2-provider",level:3},{value:"Step 0.3: Choose Integrated Development Environment (IDE)",id:"step-03-choose-integrated-development-environment-ide",level:3},{value:"GitHub Repo",id:"github-repo",level:2},{value:"Outline Project Structure",id:"outline-project-structure",level:2},{value:"File structure",id:"file-structure",level:3},{value:"providers.tf",id:"providerstf",level:2},{value:"data.tf",id:"datatf",level:2},{value:"output.tf",id:"outputtf",level:2},{value:"main.tf",id:"maintf",level:2},{value:"Define the Azure Cloud Credentials",id:"define-the-azure-cloud-credentials",level:3},{value:"Define the Machine Configuration",id:"define-the-machine-configuration",level:3},{value:"Define the RKE2 Condifugration",id:"define-the-rke2-condifugration",level:3},{value:"variables.tf",id:"variablestf",level:2},{value:"terraform.tfvars",id:"terraformtfvars",level:3},{value:"Execution",id:"execution",level:2},{value:"Validation",id:"validation-1",level:2},{value:"Delete Resources",id:"delete-resources",level:2},{value:"\u2709\ufe0f Contact",id:"\ufe0f-contact",level:2},{value:"Conclusions",id:"conclusions",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsxs)(n.p,{children:["In a ",(0,i.jsx)(n.a,{href:"/personal-blog/blog/rancher-rke2-cilium-azure",children:"previous post"}),", we covered how to create an ",(0,i.jsx)(n.a,{href:"https://docs.rke2.io/",children:"RKE2"})," cluster on ",(0,i.jsx)(n.a,{href:"https://azure.microsoft.com/en-us/get-started",children:"Azure Cloud"})," using the ",(0,i.jsx)(n.a,{href:"https://azure.microsoft.com/en-us/free#all-free-services",children:"cloud-free credits"})," from the ",(0,i.jsx)(n.strong,{children:"Rancher UI"}),". As this is a convenient approach to get started with Rancher, in today's post, we will demonstrate how to use ",(0,i.jsx)(n.a,{href:"https://opentofu.org/",children:"OpenTofu"})," to automate the deployment."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"OpenTofu"})," is a fork of ",(0,i.jsx)(n.a,{href:"https://www.terraform.io/",children:"Terraform"}),". It is an open-source project, community-driven, and managed by the Linux Foundation. If you want to get familiar with what ",(0,i.jsx)(n.code,{children:"OpenTofu"})," is and how to get started, check out the link ",(0,i.jsx)(n.a,{href:"https://opentofu.org/docs/intro/core-workflow/",children:"here"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Additionally, we will demonstrate how easy it is to customise the ",(0,i.jsx)(n.a,{href:"https://docs.cilium.io/en/stable/",children:"Cilium"})," configuration and enable ",(0,i.jsx)(n.a,{href:"https://kube-vip.io/",children:"kube-vip"})," for LoadBalancer services from the HCL (HashiCorp Configuration Language) definition."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"title image reading &quot;OpenTofu Rancher RKE2 Cluster on Azure&quot;",src:r(6298).A+"",width:"6907",height:"2316"})}),"\n",(0,i.jsx)(n.h2,{id:"lab-setup",children:"Lab Setup"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"+-----------------------------+------------------+----------------------+\n|        Cluster Name         |       Type       |       Version        |\n+-----------------------------+------------------+----------------------+\n|          Rancher            |   k3s cluster    |    v1.28.7+k3s1      |\n| Downstream RKE2 cluster     |       RKE2       |  v1.28.11+rke2r1     |\n+-----------------------------+------------------+----------------------+\n\n+-------------------+----------+\n|    Deployment     | Version  |\n+-------------------+----------+\n|      Cilium       | 1.15.500 |\n|      OpenTofu     | v1.8.1   |\n+-------------------+----------+\n\n"})}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.h3,{id:"rancher-server",children:"Rancher Server"}),"\n",(0,i.jsxs)(n.p,{children:["We do not concentrate on installing ",(0,i.jsx)(n.code,{children:"Rancher"}),". If you are unsure how to install Rancher, take a look at the official documentation ",(0,i.jsx)(n.a,{href:"https://ranchermanager.docs.rancher.com/getting-started/quick-start-guides",children:"here"})," or go through the guide I created a couple of weeks back found ",(0,i.jsx)(n.a,{href:"https://medium.com/@eleni.grosdouli/rancher-on-eks-with-nginx-ingress-and-lets-encrypt-4f041fc1adae",children:"here"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"azure-free-credits",children:"Azure Free Credits"}),"\n",(0,i.jsxs)(n.p,{children:["For this demonstration, we will use the Azure ",(0,i.jsx)(n.a,{href:"https://azure.microsoft.com/en-us/free",children:"free credits"})," offering. The approach taken allows readers to understand how to set up the Azure cloud environment to perform RKE2 deployments with Rancher without spending money outside the free-credits offering."]}),"\n",(0,i.jsx)(n.p,{children:"Ensure the below are satisfied."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Helm CLI installed (Optional Step)"}),"\n",(0,i.jsx)(n.li,{children:"kubectl installed"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"install-opentofu",children:"Install OpenTofu"}),"\n",(0,i.jsxs)(n.p,{children:["There is a wide variety of options provided to install ",(0,i.jsx)(n.code,{children:"OpenTofu"}),". To follow along, check out the ",(0,i.jsx)(n.a,{href:"https://opentofu.org/docs/intro/install/",children:"link"})," and install ",(0,i.jsx)(n.code,{children:"OpenTofu"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"validation",children:"Validation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ tofu version\nOpenTofu v1.8.1\non darwin_arm64\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-0-pre-work",children:"Step 0: Pre-work"}),"\n",(0,i.jsx)(n.h3,{id:"step-01-familiarise-with-opentofu-registry",children:"Step 0.1: Familiarise with OpenTofu Registry"}),"\n",(0,i.jsxs)(n.p,{children:["As with the Terraform registry, the ",(0,i.jsx)(n.code,{children:"OpenTofu"})," registry is a centralised service for ",(0,i.jsx)(n.strong,{children:"distributing"})," and ",(0,i.jsx)(n.strong,{children:"managing"})," providers/modules. Users can ",(0,i.jsx)(n.strong,{children:"share"}),", ",(0,i.jsx)(n.strong,{children:"discover"}),", and ",(0,i.jsx)(n.strong,{children:"consume"})," reusable infrastructure modules and providers."]}),"\n",(0,i.jsxs)(n.p,{children:["A list of the available providers/modules is located ",(0,i.jsx)(n.a,{href:"https://github.com/opentofu/registry/",children:"here"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"rancher2"})," provider is supported by OpenTofu. The details can be found ",(0,i.jsx)(n.a,{href:"https://github.com/opentofu/registry/tree/main/providers/r/rancher",children:"here"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"step-02-familiarise-with-rancher2-provider",children:"Step 0.2: Familiarise with Rancher2 Provider"}),"\n",(0,i.jsxs)(n.p,{children:["Before we even begin with the actual coding, it is a nice opportunity to familiarise with the ",(0,i.jsx)(n.a,{href:"https://search.opentofu.org/provider/opentofu/rancher2/v4.1.0",children:"Rancher2 provider"}),"."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"title image reading &quot;Rancher2 Terraform Provider&quot;",src:r(6653).A+"",width:"3454",height:"2076"})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"Check out the example sections of the resources available and the supported Cloud providers."})}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsxs)(n.p,{children:["Be mindful this is an alpha preview of the OpenTofu Registry UI. If you encounter any issues, report them ",(0,i.jsx)(n.a,{href:"https://github.com/opentofu/registry-ui/issues",children:"here"}),"."]})}),"\n",(0,i.jsx)(n.h3,{id:"step-03-choose-integrated-development-environment-ide",children:"Step 0.3: Choose Integrated Development Environment (IDE)"}),"\n",(0,i.jsxs)(n.p,{children:["As with any other project, we will use ",(0,i.jsx)(n.a,{href:"https://git-scm.com/book/en/v2/Getting-Started-What-is-Git%3F",children:"Git"})," to store our code in a central location and ",(0,i.jsx)(n.a,{href:"https://code.visualstudio.com/",children:"Visual Studio Code"})," to perform the coding. Choose your favourite source control system and IDE, and dive into the next sections! \ud83d\ude80"]}),"\n",(0,i.jsx)(n.h2,{id:"github-repo",children:"GitHub Repo"}),"\n",(0,i.jsxs)(n.p,{children:["The showcase repository is available ",(0,i.jsx)(n.a,{href:"https://github.com/egrosdou01/opentofu-rke2-cilium-azure/tree/main",children:"here"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"outline-project-structure",children:"Outline Project Structure"}),"\n",(0,i.jsxs)(n.p,{children:["Like with any Terraform project, we will create several ",(0,i.jsx)(n.code,{children:".tf"})," files to store the Infrastructure as Code (IaC) definitions. For best practices, have a look at the ",(0,i.jsx)(n.a,{href:"https://spacelift.io/blog/opentofu-tutorial#opentofu-best-practices",children:"link"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"In your favourite IDE, create a new project and create the below file structure."}),"\n",(0,i.jsx)(n.h3,{id:"file-structure",children:"File structure"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"main.tf"}),": Contains the resource blocks that define the resources to be created in the Azure cloud"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"variables.tf"}),": Contains the variable declaration used in the resource blocks"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"providers.tf"}),": Contains the required providers used in the resource blocks"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"data.tf"}),": Contains several data retrieved from the outside and used it through the resource creation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"output.tf"}),": Contains the output that needs to be generated on successful completion of the OpenTofu plan/apply"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"*.tfvars"}),": Contains the default values of the specified variables"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"providerstf",children:"providers.tf"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"providers.tf"})," file holds the required providers that will be used for the creation of the relevant resources. OpenTofu configurations must declare which providers they require so that OpenTofu can install and use them."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'terraform {\n  required_version = "~> 1.8.1"\n\n  required_providers {\n    rancher2 = {\n      source  = "opentofu/rancher2"\n      version = "4.1.0"\n    }\n    local = {\n      source  = "opentofu/local"\n      version = "2.5.1"\n    }\n    http = {\n      source  = "opentofu/http"\n      version = "3.4.4"\n    }\n  }\n}\n\nprovider "rancher2" {\n  api_url   = var.rancher2_api_url\n  token_key = var.rancher2_token_key\n}\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["It is a good practice to avoid specifying sensitive data in the ",(0,i.jsx)(n.code,{children:"variables.tf"})," file. The ",(0,i.jsx)(n.code,{children:"providers.tf"})," file expects the ",(0,i.jsx)(n.code,{children:"rancher2_api_url"})," and ",(0,i.jsx)(n.code,{children:"rancher2_token_key"})," variables. Following the best practices, we can have a file that exports the required variable name and value. From a terminal window, we set the ",(0,i.jsx)(n.a,{href:"https://www.digitalocean.com/community/tutorials/how-to-read-and-set-environmental-and-shell-variables-on-linux",children:"source"})," pointing to the file before performing any IaC actions."]})}),"\n",(0,i.jsx)(n.h2,{id:"datatf",children:"data.tf"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"data.tf"})," file holds the code to download relevant information about the kube-vip installation. The information will be used later on in the ",(0,i.jsx)(n.code,{children:"main.tf"})," file while defining the RKE2 cluster configuration."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# Download the kube-vip required RBAC manifest\ndata "http" "kube_vip_rbac" {\n  url = "https://kube-vip.io/manifests/rbac.yaml"\n}\n\n# Download a specific kube-vip version\ndata "http" "kube_vip_version" {\n  method = "GET"\n  url    = "https://api.github.com/repos/kube-vip/kube-vip/releases#v0.8.2"\n}\n\n# Download the kube-vip-cloud-provider required manifest\ndata "http" "kube_vip_cloud_provider" {\n  url = "https://raw.githubusercontent.com/kube-vip/kube-vip-cloud-provider/main/manifest/kube-vip-cloud-controller.yaml"\n}\n\n...\n\n'})}),"\n",(0,i.jsx)(n.h2,{id:"outputtf",children:"output.tf"}),"\n",(0,i.jsxs)(n.p,{children:["In the file, we can specify anything we want based on the use case at hand. For this demonstration, we keep it simple. We would display only the RKE2 ",(0,i.jsx)(n.code,{children:"cluster-name"})," and ",(0,i.jsx)(n.code,{children:"cluster-id"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# Display the RKE2 Cluster Name\noutput "rke2_cluster_name" {\n  value = rancher2_cluster_v2.rke2.name\n}\n\n# Display the RKE2 Cluster ID\noutput "rancher_cluster_id" {\n  value = data.rancher2_project.system.cluster_id\n}\n\n...\n\n'})}),"\n",(0,i.jsx)(n.h2,{id:"maintf",children:"main.tf"}),"\n",(0,i.jsxs)(n.p,{children:["The file contains the logic for creating virtual machines and installing RKE2 on top. We will break the ",(0,i.jsx)(n.code,{children:"main.tf"})," file into smaller pieces and try to go through them in more detail."]}),"\n",(0,i.jsx)(n.h3,{id:"define-the-azure-cloud-credentials",children:"Define the Azure Cloud Credentials"}),"\n",(0,i.jsxs)(n.p,{children:["It is a requirement to have valid Azure cloud credentials before proceeding with the RKE2 installation. If you are unsure how to get the below variable details, have a look at my previous post ",(0,i.jsx)(n.a,{href:"/personal-blog/blog/rancher-rke2-cilium-azure#set-up-rancher-cloud-credentials",children:"here"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# Create the Azure Cloud Credentials in Rancher\nresource "rancher2_cloud_credential" "azure_creds" {\n  name = "Azure Credentials"\n  azure_credential_config {\n    client_id       = var.azure_env.az_client_id\n    client_secret   = var.azure_env.az_client_secret\n    subscription_id = var.azure_env.az_subscription_id\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"define-the-machine-configuration",children:"Define the Machine Configuration"}),"\n",(0,i.jsx)(n.p,{children:"The below resource will create the required virtual machines for the RKE2 cluster. Here, we define two types of nodes, the controller and the worker node. They could have the same or different hardware specifications based on the use case scenario that needs to be covered."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# Create the different nodes for RKE2 (controller and worker node)\nresource "rancher2_machine_config_v2" "nodes" {\n  for_each      = var.node\n  generate_name = each.value.name\n\n  azure_config {\n    disk_size            = each.value.agent_disk\n    image                = each.value.image\n    location             = each.value.location\n    managed_disks        = true\n    open_port            = each.value.open_port\n    private_address_only = false\n    resource_group       = each.value.resource_group\n    storage_type         = each.value.storage_type\n    size                 = each.value.agent_type\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"define-the-rke2-condifugration",children:"Define the RKE2 Condifugration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# RKE2 configuration\nresource "rancher2_cluster_v2" "rke2" {\n  annotations           = var.rancher_env.cluster_annotations\n  kubernetes_version    = var.rancher_env.rke2_version\n  labels                = var.rancher_env.cluster_labels\n  enable_network_policy = var.rancher_env.network_policy # Option to enable or disable Project Network Isolation.\n  name                  = var.rancher_env.cluster_id\n\n  rke_config {\n    # You can create a Terraform template and polulate the values of the file based on the variables defined below\n    additional_manifest = templatefile("${path.module}/files/kube-vip-daemonset.tfmpl",\n      {\n        int_name                = var.kube_vip.int_name\n        kube_vip_rbac           = data.http.kube_vip_rbac.response_body\n        kube_vip_version        = jsondecode(data.http.kube_vip_version.response_body)[0]["tag_name"]\n        kube_vip_address        = var.kube_vip.kube_vip_address\n        kube_vip_pool           = var.kube_vip.kube_vip_pool\n        kube_vip_cloud_provider = data.http.kube_vip_cloud_provider.response_body\n    })\n\n    # Define the Helm chart values for the Cilium installation\n    chart_values = <<-EOF\n      # Have a look at https://github.com/cilium/cilium/blob/main/install/kubernetes/cilium/values.yaml to include additional custom values\n      rke2-cilium:\n        k8sServiceHost: 127.0.0.1\n        k8sServicePort: 6443\n        kubeProxyReplacement: true # Enable Cilium with Kube-Proxy replacement on\n      EOF\n\n    # Define the Rancher global settings for the whole cluster\n    machine_global_config = <<EOF\n      cni: "cilium" \n      cluster-cidr: ${var.rke_cluster_cidr}\n      service-cidr: ${var.rke_service_cidr}\n      disable-kube-proxy: true\n      EOF\n\n    # Sepcify the role of each node based on the name of the node\n    dynamic "machine_pools" {\n      for_each = var.node\n      content {\n        cloud_credential_secret_name = rancher2_cloud_credential.azure_creds.id\n        control_plane_role           = machine_pools.key == "controller" ? true : false\n        etcd_role                    = machine_pools.key == "controller" ? true : false\n        name                         = machine_pools.value.name\n        quantity                     = machine_pools.value.quantity\n        worker_role                  = machine_pools.key != "controller" ? true : false\n\n        machine_config {\n          kind = rancher2_machine_config_v2.nodes[machine_pools.key].kind\n          name = rancher2_machine_config_v2.nodes[machine_pools.key].name\n        }\n      }\n    }\n\n    machine_selector_config {\n      config = null\n    }\n\n  }\n\n...\n\n'})}),"\n",(0,i.jsx)(n.h2,{id:"variablestf",children:"variables.tf"}),"\n",(0,i.jsxs)(n.p,{children:["Outline how the variables used in the ",(0,i.jsx)(n.code,{children:"main.tf"})," file should look like. If required, perform additional validations to the code."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'variable "azure_env" {\n  description = "Azure required details"\n  type = object({\n    az_client_id       = string\n    az_client_secret   = string\n    az_subscription_id = string\n  })\n}\n\nvariable "kube_vip" {\n  description = "kube-vip basic settings"\n  type = object({\n    int_name         = string\n    kube_vip_address = string\n    kube_vip_pool    = string\n  })\n}\n\nvariable "node" {\n  description = "Two RKE2 nodes to be configured"\n  type = object({\n    controller = object({\n      name           = string\n      agent_disk     = optional(number)\n      image          = optional(string)\n      location       = optional(string)\n      open_port      = optional(list(string))\n      resource_group = optional(string)\n      storage_type   = optional(string)\n      agent_type     = optional(string)\n      quantity       = number\n    })\n    worker = object({\n      name           = string\n      agent_disk     = optional(number)\n      image          = optional(string)\n      location       = optional(string)\n      open_port      = optional(list(string))\n      resource_group = optional(string)\n      storage_type   = optional(string)\n      agent_type     = optional(string)\n      quantity       = number\n    })\n  })\n}\n\nvariable "rancher2_api_url" {\n  description = "URL to Rancher Server API"\n  type        = string\n}\n\nvariable "rancher2_token_key" {\n  description = "Rancher API Token key"\n  type        = string\n}\n\n...\n\n'})}),"\n",(0,i.jsx)(n.h3,{id:"terraformtfvars",children:"terraform.tfvars"}),"\n",(0,i.jsxs)(n.p,{children:["The file holds the input for the resource creation. Depending on how the ",(0,i.jsx)(n.code,{children:"variables.tf"})," file looks like, we should set a similar structure to define the variables initialisation."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'kube_vip = {\n  int_name         = "eth0"\n  kube_vip_address = "x.x.x.x"\n  kube_vip_pool    = "x.x.x.x-x.x.x.x"\n}\n\nnode = {\n  controller = { name = "controller", quantity = 1, agent_disk = 30, image = "canonical:UbuntuServer:18.04-LTS:latest", location = "westus", resource_group = "rancher-rg", storage_type = "Standard_LRS", agent_type = "Standard_D2_v2" },\n  worker  = { name = "worker", quantity = 1, agent_disk = 30, image = "canonical:UbuntuServer:18.04-LTS:latest", location = "westus", resource_group = "rancher-rg", storage_type = "Standard_LRS", agent_type = "Standard_D2_v2" }\n}\n\nrancher_env = {\n  cluster_annotations = { "rke2" = "demo" }\n  cluster_labels      = { "rke2" = "azure-demo" }\n  rke2_version     = "v1.28.11+rke2r1"\n  cluster_id       = "eleni-azure-01"\n  network_policy   = "false"\n}\n\nrke_cluster_cidr   = "10.42.0.0/16"\nrke_service_cidr   = "10.43.0.0/16"\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"The kube-vip interface name defined in the file represents the network interface from the virtual machines created in the Azure Cloud environment."})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"The node definition will allow you to create an RKE2 cluster based on the free-credits subscription. If the above are changed, the deployment might fail due to subscription limitations."})}),"\n",(0,i.jsx)(n.h2,{id:"execution",children:"Execution"}),"\n",(0,i.jsx)(n.p,{children:"To plan and apply the resources, use the below commands."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\n$ tofu init\n\n$ tofu plan\n\n$ tofu apply\n\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsxs)(n.p,{children:["When performing the ",(0,i.jsx)(n.code,{children:"tofu init"})," command, I received the below warning."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"- Installing opentofu/rancher2 v4.1.0...\n- Installed opentofu/rancher2 v4.1.0. Signature validation was skipped due to the registry not containing GPG keys for this provider\n"})}),(0,i.jsxs)(n.p,{children:["I raised a ",(0,i.jsx)(n.code,{children:"GitHub"})," ",(0,i.jsx)(n.a,{href:"https://github.com/rancher/terraform-provider-rancher2/issues/1385",children:"issue"})," with the Terraform Rancher2 Provider."]})]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["Check out the ",(0,i.jsx)(n.code,{children:".terraform/providers/registry.opentofu.org"})," directory with the providers sourced from the OpenTofu registry."]})}),"\n",(0,i.jsxs)(n.p,{children:["The above will first create the Azure Cloud Credentials in the Rancher instance, then continue with the RKE2 cluster creation. The ",(0,i.jsx)(n.code,{children:"tofu apply"})," command might take up to 10 min. Just wait for it to complete."]}),"\n",(0,i.jsx)(n.h2,{id:"validation-1",children:"Validation"}),"\n",(0,i.jsxs)(n.p,{children:["If the ",(0,i.jsx)(n.code,{children:"tofu apply"})," command completes successfully, we should have a cluster with two nodes. One ",(0,i.jsx)(n.code,{children:"controller"})," and one ",(0,i.jsx)(n.code,{children:"worker"})," node in the ",(0,i.jsx)(n.code,{children:"westus"})," region."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"title image reading &quot;Rancher2 Terraform Provider&quot;",src:r(2682).A+"",width:"3452",height:"1988"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ kubectk get nodes\nNAME                                       STATUS   ROLES                       AGE     VERSION\neleni-azure-01-controller-49abc099-ftvnv   Ready    control-plane,etcd,master   11m     v1.28.11+rke2r1\neleni-azure-01-worker-87b90346-swd64       Ready    worker                      7m59s   v1.28.11+rke2r1\n\n$ kubectk get pods -n kube-system\nNAME                                                                READY   STATUS      RESTARTS   AGE\ncilium-5rfh4                                                        1/1     Running     0          11m\ncilium-operator-6bd79b68b5-ch979                                    1/1     Running     0          11m\ncilium-vmt9d                                                        1/1     Running     0          8m8s\ncloud-controller-manager-eleni-azure-01-controller-49abc099-ftvnv   1/1     Running     0          11m\netcd-eleni-azure-01-controller-49abc099-ftvnv                       1/1     Running     0          11m\nhelm-install-rke2-cilium-kqmkc                                      0/1     Completed   0          11m\nhelm-install-rke2-coredns-m5f8f                                     0/1     Completed   0          11m\nhelm-install-rke2-ingress-nginx-vzdps                               0/1     Completed   0          11m\nhelm-install-rke2-metrics-server-5t4sj                              0/1     Completed   0          11m\nhelm-install-rke2-snapshot-controller-crd-jvdtd                     0/1     Completed   0          11m\nhelm-install-rke2-snapshot-controller-zpkhv                         0/1     Completed   0          11m\nhelm-install-rke2-snapshot-validation-webhook-6qlpx                 0/1     Completed   0          11m\nkube-apiserver-eleni-azure-01-controller-49abc099-ftvnv             1/1     Running     0          11m\nkube-controller-manager-eleni-azure-01-controller-49abc099-ftvnv    1/1     Running     0          11m\nkube-scheduler-eleni-azure-01-controller-49abc099-ftvnv             1/1     Running     0          11m\nkube-vip-5vlxw                                                      1/1     Running     0          11m\nkube-vip-cloud-provider-85fd9b9cf7-n24fd                            1/1     Running     0          11m\nrke2-coredns-rke2-coredns-84b9cb946c-5wch4                          1/1     Running     0          11m\nrke2-coredns-rke2-coredns-84b9cb946c-zfkm5                          1/1     Running     0          8m5s\nrke2-coredns-rke2-coredns-autoscaler-b49765765-4gkwf                1/1     Running     0          11m\nrke2-ingress-nginx-controller-hljpx                                 1/1     Running     0          6m15s\nrke2-metrics-server-655477f655-v2j6g                                1/1     Running     0          6m38s\nrke2-snapshot-controller-59cc9cd8f4-66942                           1/1     Running     0          6m39s\nrke2-snapshot-validation-webhook-54c5989b65-zqxgz                   1/1     Running     0          6m38s\n"})}),"\n",(0,i.jsx)(n.h2,{id:"delete-resources",children:"Delete Resources"}),"\n",(0,i.jsxs)(n.p,{children:["It is very easy to delete the resources created, simply perform the ",(0,i.jsx)(n.code,{children:"tofu destroy"})," and confirm the action. The deletion of the resources will take up to 2 minutes."]}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-contact",children:"\u2709\ufe0f Contact"}),"\n",(0,i.jsxs)(n.p,{children:["If you have any questions, feel free to get in touch! You can use the ",(0,i.jsx)(n.code,{children:"Discussions"})," option found ",(0,i.jsx)(n.a,{href:"https://github.com/egrosdou01/personal-blog/discussions",children:"here"})," or reach out to me on any of the social media platforms provided. \ud83d\ude0a"]}),"\n",(0,i.jsx)(n.p,{children:"We look forward to hearing from you!"}),"\n",(0,i.jsx)(n.h2,{id:"conclusions",children:"Conclusions"}),"\n",(0,i.jsx)(n.p,{children:"This is it! Automate the creation of RKE2 clusters in Azure with OpenTofu! \ud83c\udf89"}),"\n",(0,i.jsx)(n.p,{children:"It's a wrap for this post! \ud83c\udf89 Thanks for reading! Stay tuned for more exciting updates!"})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},6298:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/images/openTofu_rancher_intro_image-d89b7d976207b64e2eaa5b79d0cbf34e.jpg"},6653:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/images/rancher2_tf_provider-9d0f69806f1f35bebe06e0d0199cc865.png"},2682:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/images/rke2_opentofu_azure-6b9ac87af58d9ad3a09d237229e62e3b.png"},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>s});var i=r(6540);const t={},o=i.createContext(t);function a(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);